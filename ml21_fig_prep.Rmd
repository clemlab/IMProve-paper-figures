---
title: "ml21_fig_prep_v9"
author: "Shyam Saladi"
date: "11/20/2015"
output: html_document
---
```{r}
library(datamart)

library(ggplot2)
library(ggbeeswarm) # https://github.com/eclarke/ggbeeswarm
library(ggthemes)
library(cowplot)
library(gtable)
library(grid)
library(gridExtra)
library(scales)
library(RColorBrewer)

library(fitdistrplus)

library(xlsx)
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)

library(boot)
library(caret)

library(pROC)

library(foreach)
library(doMC)
registerDoMC(cores=10)

#backup dataset to load, just in case
#load("~/ml-ecoli-paper/.RData_1111_backup.Rdata")
```

Careful not to re-overwrite things! If you do, then load the dataset given above

# figure preparation and helper functions
```{r}
specify_decimal <- function(x, k) format(round(x, k), nsmall=k)

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

theme_pub <- function(base_size = 7, base_family = "Helvetica", ...)
{
    require(ggplot2)
    txt <- element_text(family = base_family, size = base_size, colour = "black", face = "plain")
    bold_txt <- element_text(family = base_family, size = base_size, colour = "black", face = "bold")
    
    theme_bw(base_size = base_size, base_family = base_family) +
        theme(
            ..., 
            legend.key.size = unit(0.25, "cm"),
            
            legend.background = element_blank(),
            legend.key = element_blank(),
            strip.background = element_blank(),
            
            plot.background = element_blank(),
            panel.background = element_blank(),
            
            panel.grid.minor = element_blank(),
            panel.grid.major = element_blank(),
            panel.background = element_blank(),
            panel.border = element_blank(),
            
            axis.ticks = element_line(color = "black"),
            axis.line = element_line(color = "black"),
        
            text = txt,
            plot.title = txt,
            
            axis.text = element_text(family = base_family, size = base_size-1, colour = "black", face = "plain"),
            axis.title = element_text(family = base_family, size = base_size, colour = "black", face = "plain"),
            
            legend.title = bold_txt,
            legend.text = element_text(family = base_family, size = base_size-1, colour = "black", face = "plain")
        )
}

# rounds a decimal number to 3 places (by default) and then formats it as a percentage 
rnd_pct <- function(x, digits = 3, ...) {
    require(scales)
    # cast into character then numeric in case x is a factor
    percent(round(as.numeric(as.character(x)), digits = digits, ...))
}

perc.rank <- function(x) trunc(rank(x))/length(x)
rem_extrema <- function(x) {
    x <- data.frame(V1 = x, V2 = x)
    x[x$V1 != min(x$V1) & x$V1 != max(x$V1),]$V1
}

my_roc <- function(...) {
    require(pROC)
    require(dplyr)
    pROC_outcome <- roc(...)
    pROC_outcome$ppv <- foreach(thisthreshold = pROC_outcome$thresholds, .combine='c') %dopar% {
        truepos <- sum(pROC_outcome$cases >= thisthreshold)
        predpos <- sum(c(pROC_outcome$cases, pROC_outcome$controls) >= thisthreshold)
        truepos/predpos
    }
    pROC_outcome$npv <- foreach(thisthreshold = pROC_outcome$thresholds, .combine='c') %dopar% {
        trueneg <- sum(pROC_outcome$controls <= thisthreshold)
        predneg <- sum(c(pROC_outcome$cases, pROC_outcome$controls) <= thisthreshold)
        trueneg/predneg
    }
    pROC_outcome$threshold_percentiles <- percent_rank(pROC_outcome$thresholds)
    pROC_outcome$min_ppv <- length(pROC_outcome$cases) / (length(pROC_outcome$cases) + length(pROC_outcome$controls))
    pROC_outcome$min_npv <- length(pROC_outcome$controls) / (length(pROC_outcome$cases) + length(pROC_outcome$controls))
    pROC_outcome[c("thresholds", "threshold_percentiles", "sensitivities","specificities","ppv", "min_ppv", "npv", "min_npv")]
}

getname <- function(vector, token = 1) {
    vector <- as.character(vector)
    unlist(lapply(vector, function(x) strsplit(x, "[[:space:]]|(?=[|])", perl=TRUE)[[1]][token]))
}

fd_bw <- function (x) { 2 * IQR(x) * length(x)^(-1/3) }

level_ranks <- function(x, extra_starting_level = FALSE) {
    x <- as.numeric(factor(x))
    x_levels <- unique(x)
    
    if(extra_starting_level) {
        x_levels <- c(min(x_levels)-1, x_levels)
    }
    map_df <- data.frame(old = x_levels, 
                         new = percent_rank(x_levels))
    map_df$new[match(x, map_df$old)]
}

# modified from from asbio::ConDis.matrix  http://www.inside-r.org/packages/cran/asbio/docs/ConDis.matrix
ConDis.matrix2 <- function (Y1, Y2) 
{
    n <- length(Y1)
    m <- as.data.frame(matrix(nrow = n, ncol = n, dimnames = list(seq(1, 
                                                                      n), seq(1, n))))
    foreach (i=1:n, .combine = 'c') %do% {
        foreach (j=i:n, .combine = 'c') %do% { # changed bounds from 1:n to i:n
            ifelse((Y1[i] > Y1[j] & Y2[i] > Y2[j]) | (Y1[i] < Y1[j] & Y2[i] < Y2[j]), 1,
                   ifelse((Y1[i] < Y1[j] & Y2[i] > Y2[j]) | (Y1[i] > Y1[j] & Y2[i] < Y2[j]), -1, 0))
        }
    }
#    m[upper.tri(m, diag = TRUE)] <- NA
#    m
}

# to make alpha only pertain to fill (not outline)
# from http://stackoverflow.com/questions/34754357/fill-transparency-with-geom-violin/34762360#34762360
GeomPolygon2 <- ggproto("GeomPolygon2", Geom,
                        draw_panel = function(data, panel_scales, coord) {
                          n <- nrow(data)
                          if (n == 1) return(zeroGrob())
                          munched <- coord_munch(coord, data, panel_scales)
                          munched <- munched[order(munched$group), ]
                          first_idx <- !duplicated(munched$group)
                          first_rows <- munched[first_idx, ]
                          ggplot2:::ggname("geom_polygon",
                                           polygonGrob(munched$x, munched$y, default.units = "native",
                                                       id = munched$group,
                                                       gp = gpar(
                                                         col = first_rows$colour,
                                                         fill = alpha(first_rows$fill, first_rows$alpha),
                                                         lwd = first_rows$size * .pt,
                                                         lty = first_rows$linetype
                                                       )
                                           )
                          )
                        },
                        default_aes = aes(colour = "NA", fill = "grey20", size = 0.5, linetype = 1,
                                          alpha = NA),
                        handle_na = function(data, params) {
                          data
                        },
                        required_aes = c("x", "y"),
                        draw_key = draw_key_polygon
)

`%||%` <- function (a, b) 
{
  if (!is.null(a)) 
    a
  else b
}

GeomViolin2 <- ggproto("GeomViolin", Geom,
                       setup_data = function(data, params) {
                         data$width <- data$width %||%
                           params$width %||% (resolution(data$x, FALSE) * 0.9)
                         plyr::ddply(data, "group", transform,
                                     xmin = x - width / 2,
                                     xmax = x + width / 2
                         )
                       },

                       draw_group = function(self, data, ..., draw_quantiles = NULL) {
                         data <- transform(data,
                                           xminv = x - violinwidth * (x - xmin),
                                           xmaxv = x + violinwidth * (xmax - x)
                         )
                         newdata <- rbind(
                           plyr::arrange(transform(data, x = xminv), y),
                           plyr::arrange(transform(data, x = xmaxv), -y)
                         )
                         newdata <- rbind(newdata, newdata[1,])
                         if (length(draw_quantiles) > 0) {
                           stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <= 1))
                           quantiles <- create_quantile_segment_frame(data, draw_quantiles)
                           aesthetics <- data[
                             rep(1, nrow(quantiles)),
                             setdiff(names(data), c("x", "y")),
                             drop = FALSE
                             ]
                           both <- cbind(quantiles, aesthetics)
                           quantile_grob <- GeomPath$draw_panel(both, ...)
                           ggplot2:::ggname("geom_violin", grobTree(
                             GeomPolygon2$draw_panel(newdata, ...),
                             quantile_grob)
                           )
                         } else {
                           ggplot2:::ggname("geom_violin", GeomPolygon2$draw_panel(newdata, ...))
                         }
                       },
                       draw_key = draw_key_polygon,
                       default_aes = aes(weight = 1, colour = "grey20", fill = "white", size = 0.5,
                                         alpha = NA, linetype = "solid"),
                       required_aes = c("x", "y")
)

geom_violin2 <- function(mapping = NULL, data = NULL, stat = "ydensity",
                         draw_quantiles = NULL, position = "dodge",
                         trim = TRUE, scale = "area",
                         na.rm = FALSE, show.legend = NA, inherit.aes = TRUE,
                         ...) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomViolin2,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      trim = trim,
      scale = scale,
      draw_quantiles = draw_quantiles,
      na.rm = na.rm,
      ...
    )
  )
}

find_cell <- function(table, row, col, name="core-fg"){
  l <- table$layout
  which(l$t==row & l$l==col & l$name==name)
}

# analytic method (didn't end up using this)
spearman_95ci <- function(spearman, nobs) {
    # http://stats.stackexchange.com/questions/18887/how-to-calculate-a-confidence-interval-for-spearmans-rank-correlation
    # http://www.ncss.com/wp-content/themes/ncss/pdf/Procedures/PASS/Confidence_Intervals_for_Spearmans_Rank_Correlation.pdf
    base <- atanh(spearman)
    delta <- 1.96/sqrt(nobs-3)
    c(tanh(base - delta), tanh(base + delta))
}

cor_boot <- function(data, indices, method="spearman", use = "pairwise.complete.obs", ...) {
   cor(data[indices,]$ml21, data[indices,]$outcome, method=method, use = use, ...)
} 
```


# p1 - plot the daley normalized activity vs svmrank score
# fluman norm activity vs svmrank score
# ROCs with cutoffs
```{r}
ecoli_outcomes_exp <- read.csv("training/ecoli_outcomes_exp.csv", header = TRUE, row.names = 1, stringsAsFactors = FALSE)

daley_ml21 <- ecoli_outcomes_exp[! ecoli_outcomes_exp$grouping %in% c('folded.exp','folded.exp.1','folded.exp.2'),]
daley_ml21$scores <- read.table("training/daley_only_raw_exp_ml21.full.4.train.predictions", header = FALSE)$V1

daley_outcomes <- read.csv("training/AllPlates_161104_with_raw.csv", header = TRUE)
daley_outcomes <- filter(daley_outcomes, Keep. == 1) %>% 
    gather(measurement, value, Val1:OD600_Norm4) %>%
    mutate(grouping = factor(paste(groupid, measurement, sep="|")),
           outcome = as.numeric(value)
           ) %>%
    filter(!is.na(outcome))

daley_outcomes <- daley_outcomes[tolower(daley_outcomes$ID) %in% daley_ml21$ID,]
daley_outcomes <- daley_outcomes[daley_outcomes$measurement %in% c('ValNorm1','ValNorm2','ValNorm3', 'ValNorm4'),]
daley_outcomes$ID <- tolower(as.character(daley_outcomes$ID))
daley_outcomes$scores <- join(daley_outcomes, daley_ml21, by = "ID", type = "left", match = "first")$scores

daley_outcomes <- rename(daley_outcomes,  
                         cterm = Cterm_new,
                         ml21 = scores)

## Gather outcomes from Fluman data
fluman_ml21 <- ecoli_outcomes_exp[ecoli_outcomes_exp$grouping %in% c('folded.exp','folded.exp.1','folded.exp.2'),]
fluman_ml21$scores <- read.table("training/daley_only_raw_exp_ml21.full.4.fluman.predictions", header = FALSE)$V1
fluman_ml21 <- select(fluman_ml21, -value)

## only keep those genes that were trained on
fluman_outcomes <- read.csv("training/fluman_data_all.csv", header = TRUE)
fluman_outcomes <- gather(fluman_outcomes, measurement, outcome, whole.cell.fluorescence:OD600.at.harvest) %>%
    filter(!is.na(outcome))
fluman_outcomes <- fluman_outcomes[tolower(fluman_outcomes$name) %in% fluman_ml21$ID,]
fluman_outcomes <- fluman_outcomes[fluman_outcomes$measurement %in% c('folded.exp','folded.exp.1','folded.exp.2'),]
fluman_outcomes$ID <- tolower(as.character(fluman_outcomes$name))

fluman_outcomes <- join(fluman_outcomes, fluman_ml21, by = "ID", type = "left", match = "first")

fluman_outcomes <- mutate(fluman_outcomes, cterm = "fluman", grouping = measurement) %>% 
    rename(ml21 = scores)

## Gather both datasets into the same dataframe with matching columns
ecoli_training <- rbind(select(daley_outcomes, ID, cterm, measurement, outcome, ml21, grouping),
                        select(fluman_outcomes, ID, cterm, measurement, outcome, ml21, grouping))
rm(daley_outcomes, daley_ml21, fluman_outcomes, fluman_ml21)

ecoli_training$grouping <- factor(as.character(ecoli_training$grouping))

# need to calculate AUCs for each activity value but within the "in" and "out" groupings
ecoli_auc <- foreach (thiscterm = unique(ecoli_training$cterm), .combine='rbind') %dopar% {
    thisgroup <- filter(ecoli_training, cterm == thiscterm)

    # within each grouping and go through each activity
    foreach (thisthreshold = unique(rem_extrema(thisgroup$outcome)), .combine='rbind') %dopar% {
        # take all activities greater than the current one as true
        thisresponse <- thisgroup$outcome >= thisthreshold
        data.frame(
            cterm = thiscterm,
            response_threshold = thisthreshold,
            proportion = sum(thisresponse) / length(thisresponse), # proportion of positives/negatives at this activity
            ci = ci.auc(response = thisresponse, predictor = thisgroup$ml21, direction="<", method = "delong"),
            ci_labels = c("lower95", "auc", "upper95")
        )
    }
}
ecoli_auc <- dcast(ecoli_auc, cterm + response_threshold + proportion ~ ci_labels, value.var = "ci")
ecoli_auc$response_threshold_percentile <- perc.rank(ecoli_auc$response_threshold)

ecoli_roc <- foreach (thiscterm = unique(ecoli_training$cterm), .combine='rbind') %dopar% {
    thisgroup <- filter(ecoli_training, cterm == thiscterm)
    # within each grouping and go through each activity
    foreach (thispercentile = c(0:99), .combine='rbind') %dopar% {
        # take all activities greater than the current one as true
        thisquantile <- quantile(thisgroup$outcome, probs = thispercentile/100, na.rm = TRUE, names = FALSE)
        thisresponse <- thisgroup$outcome > thisquantile
        
        thisci <- ci.auc(response = thisresponse, predictor = thisgroup$ml21, direction = "<")
        
        data.frame(
            cterm = thiscterm,
            quantile = thisquantile,
            percentile = thispercentile,
            lower95 = thisci[[1]], 
            auc = thisci[[2]],
            upper95 = thisci[[3]],
            my_roc(response = thisresponse, predictor = thisgroup$ml21, direction = "<")
            )
    }
}

ecoli_training$cterm_rank <- NA
ecoli_training$cterm_rank_bin <- NA
ecoli_training$cterm_rank_percent_bin <- NA
ecoli_training$outcome_rank <- NA

ecoli_auc$response_threshold_percentile <- NA
for(thiscterm in unique(ecoli_training$cterm)) {
    
    thisrank <- rank(ecoli_training[ecoli_training$cterm == thiscterm,]$ml21)
    
    ecoli_training[ecoli_training$cterm == thiscterm,]$cterm_rank <- thisrank
    ecoli_training[ecoli_training$cterm == thiscterm,]$cterm_rank_bin <- floor(thisrank/10) *10
    ecoli_training[ecoli_training$cterm == thiscterm,]$cterm_rank_percent_bin <- percent_rank(floor(thisrank/10) *10)
    
    ecoli_training[ecoli_training$cterm == thiscterm,]$outcome_rank <-
        percent_rank(ecoli_training[ecoli_training$cterm == thiscterm,]$outcome)
    
    ecoli_auc[ecoli_auc$cterm == thiscterm,]$response_threshold_percentile <-
        percent_rank(ecoli_auc[ecoli_auc$cterm == thiscterm,]$response_threshold)
}
rm(thiscterm)

ecoli_training$cterm_rank_bin <- floor(ecoli_training$cterm_rank/10)*10

ecoli_auc$cterm <- factor(ecoli_auc$cterm, 
                          labels = c("in", "out", "fluman"), 
                          levels = c("in", "out", "fluman"))


ecoli_roc$cterm <- factor(ecoli_roc$cterm, 
                          labels = c("C-terminus Inside (GFP activity)", "C-terminus Outside (PhoA activity)", 
                                     "C-terminus Inside (Folded protein"), 
                          levels = c("in", "out", "fluman"))

ecoli_cor <- foreach (thisgrouping = unique(ecoli_training$grouping), .combine='rbind') %dopar% {
    thisgroup <- filter(ecoli_training, grouping == thisgrouping) #"folded.exp") 
    pairs <- ConDis.matrix2(thisgroup$ml21, thisgroup$outcome)
    data.frame(group = thisgrouping,
               cterm = unique(thisgroup$cterm),
               table(pairs),
               spearman = cor(thisgroup$ml21, thisgroup$outcome, ))
}
ecoli_cor <- dcast(ecoli_cor, cterm + group ~ pairs, value.var = "Freq")
colnames(ecoli_cor) <- c("cterm", "group", "disconcor", "invalid", "concor")
ecoli_cor <- mutate(ecoli_cor, total = disconcor + concor) %>%
    group_by(cterm) %>%
    summarize(concor = sum(concor, na.rm = TRUE),
              disconcor = sum(disconcor, na.rm = TRUE),
              total = sum(total, na.rm = TRUE),
              kendall = (concor - disconcor)/total)

# make table from here:
ecoli_stats <- ecoli_training %>% 
    group_by(cterm) %>%
    summarize(plates = length(unique(grouping)),
              genes = length(unique(ID)),
              observations = length(ID)) %>%
    inner_join(ecoli_cor, by = c("cterm" = "cterm")) %>%
    select(-disconcor, -concor) %>%
    rename(total_pairs = total) %>% 
    data.frame

rownames(ecoli_stats) <- ecoli_stats$cterm
ecoli_stats <- select(ecoli_stats, -cterm)

ecoli_stats$kendall <- round(ecoli_stats$kendall, 3)
colnames(ecoli_stats) <- c("Plates", "Genes", "Observations", # "Concordant Pairs", "Disconcordant Pairs", 
                           "Total~Pairs", "Kendall's"~tau)

table_theme <-  ttheme_default(
    core = list(fg_params=list(fontsize = 6)),
    colhead = list(fg_params=list(fontsize = 6, parse=TRUE)),
    rowhead = list(fg_params=list(fontsize = 6, parse=TRUE)),
    padding = unit(c(2, 3), "mm"))

tab <- tableGrob(data.frame(t(ecoli_stats)), theme = table_theme, 
                 cols = c("C-terminal Cytoplasmic\n(GFP)", 
                          "C-terminal Periplasmic\n(PhoA)", 
                          "C-terminal Cytoplasmic\n(GFP, folded protein)"))
header <- tableGrob(data.frame(t(ecoli_stats))[1,1:2],
                    theme = table_theme,
                    cols=c("Daley, Rapp, et al., 2005", "Fluman, et al., 2014")) 

p1_table <- gridExtra::join(header[1,], tab, along=2) 
p1_table$layout[1:6 , c("l", "r")] <- list(c(2, 4), c(3, 4))

# chg_attr <- function(table, row, col, name="core-fg", append = TRUE, ...) {
#     l <- table$layout
#     ind <- which(l$t==row & l$l==col & l$name==name)
#     
#     table$grobs[ind][[1]][["gp"]] <- c(table$grobs[ind][[1]][["gp"]], ...)
#     table
# }

ind <- find_cell(p1_table, 2, 2, "colhead-fg")
p1_table$grobs[ind][[1]][["gp"]]$col <- brewer.pal(3, "Dark2")[[1]]
ind <- find_cell(p1_table, 2, 3, "colhead-fg")
p1_table$grobs[ind][[1]][["gp"]]$col <- brewer.pal(3, "Dark2")[[2]]
ind <- find_cell(p1_table, 2, 4, "colhead-fg")
p1_table$grobs[ind][[1]][["gp"]]$col <- brewer.pal(3, "Dark2")[[3]]


# correlation metrics
ecoli_xy_cor <- filter(ecoli_training, cterm != "out") %>% group_by(cterm) %>%
    summarize(count = length(outcome),
              spearman = cor(outcome, ml21, method = "spearman"),
              lower95 = specify_decimal(spearman_95ci(spearman, count), k=2)[1],
              upper95 = specify_decimal(spearman_95ci(spearman, count), k=2)[2],
              spearman = specify_decimal(spearman, k=2),
              ci = paste0(spearman, " (", lower95, "-", upper95, ")"),
              x = min(ml21)+(max(ml21)-min(ml21))*(6/20), 
              ylab = max(outcome)*(1-1/50),
              y = ylab-max(outcome)*(1/20)
    )

ecoli_daley_fluman <- filter(ecoli_training, cterm != "out") %>% group_by(cterm, ID) %>% 
    summarize(outcome_max = max(outcome, na.rm = TRUE),
              outcome_avg = mean(outcome, na.rm = TRUE),
              outcome_min = min(outcome, na.rm = TRUE))
ecoli_daley_fluman <- cbind(
    dcast(ecoli_daley_fluman, ID ~ cterm, value.var = "outcome_min"),
    dcast(ecoli_daley_fluman, ID ~ cterm, value.var = "outcome_avg"),
    dcast(ecoli_daley_fluman, ID ~ cterm, value.var = "outcome_max"))
colnames(ecoli_daley_fluman) <- c("id", "daley_min", "fluman_min", "id2", "daley_avg", "fluman_avg", "id3", "daley_max", "fluman_max")
ecoli_daley_fluman <- filter(ecoli_daley_fluman, !is.na(fluman_min), !is.na(daley_min))

ecoli_daley_fluman_cor <- cor(ecoli_daley_fluman$fluman_avg, ecoli_daley_fluman$daley_avg, method="spearman")
ecoli_daley_fluman_cor_ci <- specify_decimal(spearman_95ci(ecoli_daley_fluman_cor, nrow(ecoli_daley_fluman)), k=2)
```

# better not to run this everytime but rather just save the results
# Commented to avoid running by mistake. Just load "bootstraps_with_bca_ci.RData"
```{r}
# bs_count <- 10^6
# library(magrittr)
# library(dplyr)
# library(boot)
# ecoli_xy_boot_in <- boot(data=filter(ecoli_training, cterm == "in") %>% select(ml21, outcome), 
#                statistic=cor_boot, R=bs_count, parallel="multicore", ncpus=20)
# ecoli_xy_boot_fluman <- boot(data=filter(ecoli_training, cterm == "fluman") %>% select(ml21, outcome), 
#                statistic=cor_boot, R=bs_count, parallel="multicore", ncpus=25)
# ecoli_daley_fluman_boot <- boot(data=select(ecoli_daley_fluman, fluman_avg, daley_avg) 
#                                     %>% rename(ml21=fluman_avg, outcome=daley_avg), 
#                statistic=cor_boot, R=bs_count, parallel="multicore", ncpus=25)
# 
# ecoli_xy_boot_in_ci <- boot.ci(ecoli_xy_boot_in, type="bca")
# ecoli_xy_boot_fluman_ci <- boot.ci(ecoli_xy_boot_fluman, type="bca")
# ecoli_daley_fluman_boot_ci <- boot.ci(ecoli_daley_fluman_boot, type="bca")

load("bootstraps_with_bca_ci.RData")
```

```{r}
# all possible cutoffs with AUCs
p1_ecoli_auc <- ggplot(ecoli_auc, aes(x=response_threshold_percentile*100, color = cterm)) + 
    geom_hline(aes(yintercept=50), linetype = "dashed", color = "darkgrey") + 
    geom_line(aes(y = auc*100)) + 
#    geom_line(aes(y = lower95)) + geom_line(aes(y = upper95)) +
    scale_y_continuous(expand = c(0, 0), breaks=seq(0,100,10), limits = c(48, 90)) + 
    scale_x_continuous(expand = c(0, 0), breaks=seq(0,100,25), limits = c(0,100)) + 
    ylab("AUC") + 
    xlab("Activity Percentile") + 
    scale_color_manual(values = brewer.pal(3, "Dark2")) +
    theme_pub(legend.position = "None")

ecoli_selected_auc <- filter(ecoli_roc, percentile %in% c(50, 97)) %>%
    select(cterm, percentile, lower95, auc, upper95) %>%
    distinct() %>%
    mutate(cterm = factor(cterm),
           auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~('", lower95, "'-'", upper95, "')"))

p1_ecoli_roc <- ggplot(filter(ecoli_roc, percentile %in% c(50, 97))) + 
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_path(aes(x=100-specificities*100, y=sensitivities*100, color = cterm)) +
    geom_text(aes(x = 75, y = 8*(4-as.numeric(cterm))-3, color = cterm, label = ci), size = 5*5/14,
              parse = TRUE, data = ecoli_selected_auc) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0, 0)) +
    xlab("False Positive Rate") + ylab("True Positive Rate") + 
    scale_color_manual(values = brewer.pal(3, "Dark2")) +
    facet_wrap(~percentile, nrow=1, scales = "free")  +
    theme_pub(legend.position = "None", aspect.ratio = 1,
              plot.margin = unit(c(0, 0, 0, 0), "mm"))

p1_ecoli_roc <- ggplotGrob(p1_ecoli_roc)
p1_ecoli_roc$grobs$strip_t1$grobs[[1]]$children[[2]]$children[[1]]$label <- expression(50^"th"*~"percentile")
p1_ecoli_roc$grobs$strip_t2$grobs[[1]]$children[[2]]$children[[1]]$label <- expression(97^"th"*~"percentile")


ecoli_xy_cor$lower95_boot <- -1
ecoli_xy_cor$upper95_boot <- -1
ecoli_xy_cor[ecoli_xy_cor$cterm == "in", c('lower95_boot', 'upper95_boot')] <- ecoli_xy_boot_in_ci$bca[c(4,5)]
ecoli_xy_cor[ecoli_xy_cor$cterm == "fluman", c('lower95_boot', 'upper95_boot')] <- ecoli_xy_boot_fluman_ci$bca[c(4,5)]
ecoli_xy_cor <- mutate(ecoli_xy_cor, 
                       lower95_boot = specify_decimal(lower95_boot, k=2),
                       upper95_boot = specify_decimal(upper95_boot, k=2),
                       ci_boot = paste0("'", spearman, "'~('", lower95_boot, "'-'", upper95_boot, "')")
                       )
    
p1_ecoli_xy <- ggplot(filter(ecoli_training, cterm != "out"), aes(x = ml21, y = outcome)) +
    stat_summary(fun.ymin = min, fun.ymax = max, geom = "linerange", size = 0.3, alpha=0.4) +
    stat_summary(fun.y = mean, geom="point", size = .25) +
#    geom_smooth(aes(color = cterm), span = 100, se = FALSE, fullrange=TRUE, size = 0.5) +
    geom_text(aes(x=x, y=ylab), label = "italic(rho)[spearman]", size = 5*5/14, parse=TRUE, data = ecoli_xy_cor) +
    geom_text(aes(x=x, y=y, color=cterm, label=ci_boot), size = 5*5/14, parse=TRUE, data = ecoli_xy_cor) +
    scale_y_continuous(expand = c(.01, 0), breaks=c(0:3, 4, 6, 8)) +
    scale_x_continuous(expand = c(.01, 0.01)) +
    scale_color_manual(values = brewer.pal(3, "Dark2")[c(1,3)]) + 
    ylab("Mean Normalized Activity") +
    xlab(expression("SVM"^"rank"*~"score")) + 
    theme_pub(legend.position = "None",
              strip.text = element_blank(),
              plot.margin = unit(c(0, 0, 0, 0), "mm")) +
    facet_wrap(~cterm, ncol=1, scales = "free")


ecoli_daley_fluman_cor_label <- specify_decimal(c(ecoli_daley_fluman_cor, 
                                                  ecoli_daley_fluman_boot_ci$bca[4], 
                                                  ecoli_daley_fluman_boot_ci$bca[5]), 
                                                k=2)
ecoli_daley_fluman_cor_label <- paste0("'", ecoli_daley_fluman_cor_label[1], "'~('",
                                       ecoli_daley_fluman_cor_label[2], "'-'",
                                       ecoli_daley_fluman_cor_label[3], "')")

p1_daley_fluman <- ggplot(ecoli_daley_fluman) + 
    geom_segment(aes(x=fluman_min, xend=fluman_max, y=daley_avg, yend=daley_avg), size=0.3, alpha=0.4) +
    geom_segment(aes(x=fluman_avg, xend=fluman_avg, y=daley_min, yend=daley_max), size=0.3, alpha=0.4) +
    geom_point(aes(x=fluman_avg, y=daley_avg), size=0.25) +
    annotate("text", x = 1, y = 7.9, label = "italic(rho)[spearman]", size = 5*5/14, parse=TRUE) +
    annotate("text", x = 1, y = 7.45, label = ecoli_daley_fluman_cor_label, size = 5*5/14, parse=TRUE) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(.01, 0)) + 
    ylab("Normalized GFP activity") +
    xlab("Normalized folded protein") + 
    theme_pub(axis.title.x = element_text(size=7, color=brewer.pal(3, "Dark2")[3]),
              axis.title.y = element_text(size=7, color=brewer.pal(3, "Dark2")[1]),
              plot.margin = unit(c(0, 0, 0, .5), "mm"))
    
# p1_main <- plot_grid(p1_table, nrow = 2, ncol = 2) +
#     draw_plot(p1_ecoli_auc, .5, .5, .5, .5) +
# #    draw_plot(p1_ecoli_xy, x = 0, y = 0, width = .5, height = 0.5) + 
#     draw_plot(plot_grid(p1_daley_fluman, p1_ecoli_xy, p1_ecoli_roc, nrow = 1, rel_widths = c(1,2,2)), 
#               x = 0, y = 0, width = 1, height = .5) + 
# #    draw_plot(p1_ecoli_roc, x = 0.5, y = 0, width = .5, height = .5) +
#     draw_plot_label(letters[1:5], c(0, 0, 0.18, 0.5, 0.6), c(1, 0.52, 0.52, 1, 0.52), size = 8)

p1_main <- ggdraw() +
    draw_plot(p1_daley_fluman, x = .0, y = .5, width = .23, height = 0.48) + 
    draw_plot(p1_table, x = .21, y = 0.51, width = 1 - .47, height = 0.48) +
    draw_plot(p1_ecoli_xy, x = .75, y = 0, width = .24, height = .98) + 
    draw_plot(plot_grid(p1_ecoli_roc, p1_ecoli_auc, nrow = 1, rel_widths = c(1, 1)), 
              x = 0, y = 0, width = .75, height = .5) + 
    draw_plot_label(letters[1:5], c(0, 0.26, .75, 0, 0.38), c(1, 1, 1, 0.52, 0.52), size = 8)

save_plot(filename = "plots/fig1_w_panels.pdf", 
          plot = p1_main,
          base_width = uconv(183, "mm", "in", "Length"),
          base_height = 3)
```

# p2 - nycomps
```{r}
nycomps_pos_scores <- data.frame(
    ml21 = read.table("large-scale/nycomps_only_pos.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
    cterm = read.table("large-scale/nycomps_only_pos_phobius.phobiuscterm", header = FALSE)$V1,
    gene_outcome = "pos",
    row.names = rownames(read.csv("large-scale/nycomps_only_pos.fna.allstats.csv", header = TRUE, row.names = 1))
    )

nycomps_neg_scores <- data.frame(
    ml21 = read.table("large-scale/nycomps_only_neg.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
    cterm = read.table("large-scale/nycomps_only_neg_phobius.phobiuscterm", header = FALSE)$V1,
    gene_outcome = "neg",
    row.names = rownames(read.csv("large-scale/nycomps_only_neg.fna.allstats.csv", header = TRUE, row.names = 1))
    )

nycomps_mixed_scores <- data.frame(
    ml21 = read.table("large-scale/nycomps_mixed.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
    cterm = read.table("large-scale/nycomps_mixed_phobius.phobiuscterm", header = FALSE)$V1,
    gene_outcome = "mix",
    row.names = rownames(read.csv("large-scale/nycomps_mixed.fna.allstats.csv", header = TRUE, row.names = 1))
    )
nycomps_posmix <- rbind(nycomps_pos_scores, nycomps_neg_scores, nycomps_mixed_scores)
rm(nycomps_pos_scores, nycomps_neg_scores, nycomps_mixed_scores)

rownames(nycomps_posmix) <- getname(rownames(nycomps_posmix), 3)
nycomps_posmix$id <- as.integer(rownames(nycomps_posmix))
nycomps_posmix$gene_outcome <- as.character(nycomps_posmix$gene_outcome)
nycomps_posmix[nycomps_posmix$gene_outcome %in% c("mix", "pos"),]$gene_outcome <- "≥1 pos"
nycomps_posmix$gene_outcome <- factor(nycomps_posmix$gene_outcome, 
                              levels = c("neg", "≥1 pos"), 
                              labels = c("neg", "≥1 pos"))

nycomps_vectors <- read.csv("large-scale/nycomps_outcomes.csv", header = TRUE,  stringsAsFactors = FALSE) %>% 
    rename(id = X,
           sum_outcomes = sum) %>%
    gather(plasmid_name, plasmid_outcome, N:MSGC.9_LDAO) %>%
    filter(Analyze == 1) %>%
    select(orfno, id, sum_outcomes, tot_neg, tot_pos, pos_neg, plasmid_name, plasmid_outcome)

nycomps_vectors <- left_join(nycomps_vectors, nycomps_posmix, by = "id") %>%
    filter(!is.na(ml21), plasmid_outcome != 0)

nycomps_roc <- foreach(thisplasmid = unique(nycomps_vectors$plasmid_name), .combine='rbind') %dopar% {
    thisdata <- filter(nycomps_vectors, plasmid_name == thisplasmid)
    thisdata <- transmute(thisdata, 
                          thisresponse = plasmid_outcome == 1,
                          ml21 = ml21)
    df <- data.frame(
        my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
        group = thisplasmid,
        type = "plasmid"
        )
}

nycomps_roc <- 
    rbind(nycomps_roc,
          data.frame(my_roc(gene_outcome == "≥1 pos" ~ ml21, data = nycomps_posmix, direction = "<"), group = "posmix", type = "all"),
          data.frame(my_roc(plasmid_outcome == 1 ~ ml21, data = nycomps_vectors, direction = "<"), group = "vectors", type = "all")
    )

nycomps_auc <- foreach(thisplasmid = unique(nycomps_vectors$plasmid_name), .combine=rbind) %dopar% {
    thisdata <- filter(nycomps_vectors, plasmid_name == thisplasmid)
    thisdata <- transmute(thisdata, 
                          thisresponse = plasmid_outcome == 1,
                          ml21 = ml21)
    df1 <- data.frame(
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
        group = thisplasmid,
        type = "plasmid",
        cterm = "all",
        ci_labels = c("lower95", "auc", "upper95"),
        count = nrow(thisdata)
        )
    
    df2 <- foreach(thiscterm = unique(nycomps_vectors$cterm), .combine=rbind) %dopar% {
        thisdata <- filter(nycomps_vectors, plasmid_name == thisplasmid, cterm == thiscterm)
        thisdata <- transmute(thisdata, 
                              thisresponse = plasmid_outcome == 1,
                              ml21 = ml21)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
            group = thisplasmid,
            type = "plasmid",
            cterm = thiscterm,
            ci_labels = c("lower95", "auc", "upper95"),
            count = nrow(thisdata)
            )
    }
    
    rbind(df1, df2)
}

nycomps_auc <- 
    rbind(nycomps_auc,
          data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                                   data = nycomps_posmix, direction = "<"),
                    group = "posmix", 
                    type = "all", 
                    cterm = "all",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = nrow(nycomps_posmix)
                    ),
          data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                                   data = filter(nycomps_posmix, cterm == "CYTOPLASMIC."), direction = "<"),
                    group = "posmix", 
                    type = "all", 
                    cterm = "CYTOPLASMIC.",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = nrow( filter(nycomps_posmix, cterm == "CYTOPLASMIC.") )
                    ),
          data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                                   data = filter(nycomps_posmix, cterm == "NON-CYTOPLASMIC."), direction = "<"),
                    group = "posmix", 
                    type = "all", 
                    cterm = "NON-CYTOPLASMIC.",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = nrow( filter(nycomps_posmix, cterm == "NON-CYTOPLASMIC.") )
                    ),
          data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                                   data = nycomps_vectors, direction = "<"),
                    group = "vectors", 
                    type = "all", 
                    cterm = "all",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = nrow(nycomps_vectors)
                    ),
          data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                                   data = filter(nycomps_vectors, cterm == "CYTOPLASMIC."), direction = "<"),
                    group = "vectors", 
                    type = "all", 
                    cterm = "CYTOPLASMIC.",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = nrow( filter(nycomps_vectors, cterm == "CYTOPLASMIC.") )
                    ),
          data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                                   data = filter(nycomps_vectors, cterm == "NON-CYTOPLASMIC."), direction = "<"),
                    group = "vectors", 
                    type = "all", 
                    cterm = "NON-CYTOPLASMIC.",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = nrow( filter(nycomps_vectors, cterm == "NON-CYTOPLASMIC.") )
                    )
    )

nycomps_auc <- dcast(nycomps_auc, group + type + cterm + count ~ ci_labels, value.var = "ml21")

nycomps_median <- ddply(nycomps_posmix, .(gene_outcome), summarize,
                        median_ml21 = median(ml21))

nycomps_xscale <- quantile(nycomps_posmix$ml21, probs = c(.0025,.9975), names = FALSE)
nycomps_xscale[[1]] <- nycomps_xscale[[1]]-1
nycomps_xscale[[2]] <- nycomps_xscale[[2]]+1
nycomps_breaks <- seq(-6,6,2)

custom_histogram_data <- function(bin_data, hist_data, id) {
    temp_hist <- hist(hist_data,
                      breaks = seq(from = max(bin_data)+1, to = min(bin_data)-1, by = -fd_bw(bin_data)),
                      plot=FALSE)
    
    temp_hist2 <- data.frame(mids = temp_hist$mids, counts = temp_hist$counts)
    temp_hist2$id <- id
    temp_hist2
}

nycomps_posmix_hist <- rbind(
    custom_histogram_data(nycomps_posmix$ml21, filter(nycomps_posmix, gene_outcome != "neg")$ml21, "Expressed"),
    custom_histogram_data(nycomps_posmix$ml21, filter(nycomps_posmix, gene_outcome == "neg")$ml21, "Not Expressed")
    )
nycomps_posmix_hist <- inner_join(nycomps_posmix_hist,
                                  ddply(nycomps_posmix_hist, "mids", summarise, sumcounts = sum(counts)),
                                  by = "mids")
nycomps_posmix_hist$counts_sumcounts <- nycomps_posmix_hist$counts / nycomps_posmix_hist$sumcounts

nycomps_vectors_hist <- rbind(
    custom_histogram_data(nycomps_vectors$ml21, filter(nycomps_vectors, plasmid_outcome == 1)$ml21, "Positive"),
    custom_histogram_data(nycomps_vectors$ml21, filter(nycomps_vectors, plasmid_outcome == -1)$ml21, "Negative")
    )
nycomps_vectors_hist <- inner_join(nycomps_vectors_hist,
                                  ddply(nycomps_vectors_hist, "mids", summarise, sumcounts = sum(counts)),
                                  by = "mids")
nycomps_vectors_hist$counts_sumcounts <- nycomps_vectors_hist$counts / nycomps_vectors_hist$sumcounts

nycomps_bincount_summary <- 
    ddply(rbind(mutate(nycomps_posmix_hist, group = "posmix"), mutate(nycomps_vectors_hist, group = "vectors")),
      .(group), summarize,
      "Number of Bins Retained" = sum(sumcounts > 12),
      "Total Number of Bins" = sum(sumcounts > 0),
      "Percent Retained" = round(sum(sumcounts > 12) / sum(sumcounts > 0), 3) * 100
      ) %>% select(-group)
rownames(nycomps_bincount_summary) <- c("Expression by Gene", "All Expression Trials")
```

# nycomps plotting
```{r}
nycomps_posmix$gene_outcome2 <- factor(as.character(nycomps_posmix$gene_outcome), 
                                      labels = c("Not Expressed","Expressed"), levels = c("neg","≥1 pos"))
p2_posmix_histogram <- ggplot(nycomps_posmix) + 
    geom_histogram(aes(x=ml21, fill = gene_outcome2), 
                   binwidth = fd_bw(nycomps_posmix$ml21), alpha=1, position="identity") + 
    scale_x_continuous(expand=c(0,0), breaks=nycomps_breaks, limits=nycomps_xscale) +
    scale_y_continuous(expand=c(0,0)) +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C"), guide = guide_legend(title = "Gene of Interest:")) +
    ylab("Count") +
    xlab(expression("SVM"^"rank"*~"score")) + 
    theme_pub(legend.title = element_blank(),
              legend.position=c(0.2, 0.8), 
              plot.margin=unit(c(0, 0, 0, 0), "in"))

p2_posmix_histogram <- ggplotGrob(p2_posmix_histogram)
p2_posmix_histogram$grobs[[8]]$grobs$`99_0b89f20d561c508bc59ffe13ea616bb4`[[1]][[7]]$gp$col <- "#A4A5A5"
p2_posmix_histogram$grobs[[8]]$grobs$`99_0b89f20d561c508bc59ffe13ea616bb4`[[1]][[8]]$gp$col <- "#A10F1C"

nycomps_vectors$outcome2 <- factor(as.character(nycomps_vectors$plasmid_outcome),
                                    labels = c("Negative","Positive"), levels = c("-1","1"))
p2_raw_histogram <- ggplot(nycomps_vectors) + 
    geom_histogram(aes(x=ml21, fill = factor(outcome2)),
                   binwidth = fd_bw(nycomps_vectors$ml21), position="identity") + 
    scale_x_continuous(expand=c(0,0), breaks=nycomps_breaks, limits=nycomps_xscale) +
    scale_y_continuous(expand=c(0,0)) +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C"), guide = guide_legend(title = "Expression Trial:")) +
    ylab("Count") +
    xlab(expression("SVM"^"rank"*~"score")) + 
    theme_pub(legend.title = element_blank(),
              legend.position=c(0.2, 0.8), 
              plot.margin=unit(c(0, 1/16, 0, 0), "in"))

p2_raw_histogram <- ggplotGrob(p2_raw_histogram)
p2_raw_histogram$grobs[[8]]$grobs$`99_d5523fc5c0f7949a182beca40893c6ae`[[1]][[7]]$gp$col <- "#A4A5A5"
p2_raw_histogram$grobs[[8]]$grobs$`99_d5523fc5c0f7949a182beca40893c6ae`[[1]][[8]]$gp$col <- "#A10F1C"

p2_posmix_roc_label <- filter(nycomps_auc, group == "posmix", cterm == "all") %>% 
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~('", lower95, "'-'", upper95, "')")
           )
p2_posmix_roc <- ggplot(filter(nycomps_roc, group == "posmix")) +
    geom_path(aes(x=100-specificities*100, y = sensitivities*100)) +
    geom_ribbon(aes(x=100-specificities*100, ymin=100-specificities*100, ymax=sensitivities*100, fill=sensitivities>1-specificities)) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    annotate(geom = "text", x = 75, y = 19, label = p2_posmix_roc_label$count, size = 5*5/14, parse=TRUE) +
    annotate(geom = "text", x = 75, y = 10, label = p2_posmix_roc_label$ci, size = 5*5/14, parse=TRUE) +    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0, 0)) +
    xlab("False Positive Rate") + 
    ylab("True Positive Rate") +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme_pub(aspect.ratio = 1, legend.position = "None", plot.margin=unit(c(0, 0, 0, 0), "in"))


p2_raw_roc_label <- filter(nycomps_auc, group == "vectors", cterm == "all") %>% 
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~('", lower95, "'-'", upper95, "')")
           )
p2_raw_roc <- ggplot(filter(nycomps_roc, group == "vectors")) +
    geom_path(aes(x=100-specificities*100, y = sensitivities*100)) +
    geom_ribbon(aes(x=100-specificities*100, ymin=100-specificities*100, ymax=sensitivities*100, fill=sensitivities>1-specificities)) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    annotate(geom = "text", x = 75, y = 19, label = p2_raw_roc_label$count, size = 5*5/14, parse=TRUE) +
    annotate(geom = "text", x = 75, y = 10, label = p2_raw_roc_label$ci, size = 5*5/14, parse=TRUE) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(expand = c(0, 0)) +
    xlab("False Positive Rate") + 
    ylab("True Positive Rate") + 
    scale_fill_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme_pub(aspect.ratio = 1, legend.position = "None", plot.margin=unit(c(0, 0, 0, 0), "in"))

prep_for_polygon <- function(df, x = "thresholds", y = "ppv", min_y = "min_ppv") {
    # prep_for_polygon(data.frame(thresholds = c(1, 2, -3), ppv = c(1, 5, 10)), min_ppv = 1)
    # order by thresholds
    df <- df[order(df[,x], decreasing = TRUE),]
    
    # min y value
    min_y_val <- df[, min_y][1]
        
    # top of polygon
    df$y_greater_min <- df[,y] > min_y_val
    df <- df[seq_len(nrow(df)) %>% rep(each=2) %>% tail(-1) %>% head(-1),]
    rownames(df) <- seq(length = nrow(df))
    df$id <-  rep(seq(nrow(df)/2), each = 2)
    df$type <- y
    
    # bottom of polygon
    df <- df[rep(seq_len(nrow(df)), each=2),]
    df[grepl(".1", rownames(df), fixed = TRUE),]$type <- min_y
    df[df$type == "min_y", y] <- min_y_val
    
    # order for geom_polygon (needs to be closed)
    foreach(thisid = unique(df$id), .combine = rbind) %do% {
        thisdata <- filter(df, id == thisid) 
        thisdata <- thisdata[order(thisdata[, x], thisdata[,y], decreasing = TRUE),]
        rbind(thisdata[1,], thisdata[2,], thisdata[4,], thisdata[3,])
    }
}

p2_posmix_ppv_prep <- prep_for_polygon(filter(nycomps_roc, group == "posmix"))
p2_posmix_ppv <- ggplot(p2_posmix_ppv_prep) + 
    geom_polygon(aes(x=threshold_percentiles*100, y=ppv*100, group=id, fill=y_greater_min, color = y_greater_min), size = 0.1) +
    geom_path(aes(x=threshold_percentiles*100, y=ppv*100), size = 0.25, 
              data = filter(p2_posmix_ppv_prep, type != "min_ppv") %>% distinct(thresholds, ppv)) +
    geom_hline(aes(yintercept = min(min_ppv)*100), linetype="dashed", color="darkgrey", size = 0.5) +
    annotate("text", x = 15, y = 55, label = "By Gene:", size = 7*5/14, fontface = "bold", family = "Helvetica") + 
    scale_x_continuous(expand=c(0,0), limits=c(0,100)) +
    scale_y_continuous(expand=c(0,0), limits=c(0,60), breaks=seq(0, 100, 20)) +
    xlab(expression("Percentile SVM"^"rank"*~"score")) + 
    ylab("PPV") +
    scale_color_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme_pub(legend.position="None", plot.margin=unit(c(1/16, 1/16, 1/16, 0), "in"))

p2_raw_ppv_prep <- prep_for_polygon(filter(nycomps_roc, group == "vectors"))
p2_raw_ppv <- ggplot(p2_raw_ppv_prep) + 
    geom_polygon(aes(x=threshold_percentiles*100, y=ppv*100, group=id, fill=y_greater_min, color = y_greater_min), size = 0.1) +
    geom_path(aes(x=threshold_percentiles*100, y=ppv*100), size = 0.25, 
              data = filter(p2_raw_ppv_prep, type != "min_ppv") %>% distinct(thresholds, ppv)) +
    geom_hline(aes(yintercept = min(min_ppv)*100), linetype="dashed", color="darkgrey", size = 0.5) +
    annotate("text", x = 20, y = 55, label = "By Expression Trial:", size = 7*5/14, fontface = "bold", family = "Helvetica") + 
    scale_x_continuous(expand=c(0,0), limits=c(0,100)) +
    scale_y_continuous(expand=c(0,0), limits=c(0,60), breaks=seq(0, 100, 20)) +
    xlab(expression("Percentile SVM"^"rank"*~"score")) + 
    ylab("PPV") +
    scale_color_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme_pub(legend.position="None", plot.margin=unit(c(1/16, 1/16, 1/16, 0), "in"))

p2_raw_npv_prep <- prep_for_polygon(filter(nycomps_roc, group == "vectors"), y = "npv", min_y = "min_npv")
p2_raw_npv <- ggplot(p2_raw_npv_prep) + 
    geom_polygon(aes(x=threshold_percentiles*100, y=npv*100, group=id, fill=y_greater_min, color = y_greater_min), size = 0.1) +
    geom_path(aes(x=threshold_percentiles*100, y=npv*100), size = 0.25, 
              data = filter(p2_raw_npv_prep, type != "min_npv") %>% distinct(thresholds, ppv)) +
    geom_hline(aes(yintercept = min(min_npv)*100), linetype="dashed", color="darkgrey", size = 0.5) +
    annotate("text", x = 20, y = 55, label = "By Expression Trial:", size = 7*5/14, fontface = "bold", family = "Helvetica") + 
    scale_x_continuous(expand=c(0,0), limits=c(0,100)) +
#    scale_y_continuous(expand=c(0,0), limits=c(0,60), breaks=seq(0, 100, 20)) +
    xlab(expression("Percentile SVM"^"rank"*~"score")) + 
    ylab("NPV") +
    scale_color_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme_pub(legend.position="None", plot.margin=unit(c(1/16, 1/16, 1/16, 0), "in"))


do_rollmean <- function(df, window) {
    df <- filter(df, abs(thresholds) != Inf)
    df <- data.frame(
        thresholds = zoo::rollmean(df$thresholds, window),
        ppv = zoo::rollmean(df$ppv, window)
        )
    df$window <- as.character(window)
    df
}

nycomps_nvector_ppv_smooth <- filter(nycomps_roc, group == "N") %>% select(thresholds, ppv) %>% arrange(desc(thresholds))
nycomps_nvector_ppv_smooth$window <- "1"
nycomps_nvector_ppv_smooth <- rbind(nycomps_nvector_ppv_smooth,
                                    do_rollmean(nycomps_nvector_ppv_smooth, 50),
                                    do_rollmean(nycomps_nvector_ppv_smooth, 100)
                                    )
nycomps_nvector_ppv_smooth$window <- factor(nycomps_nvector_ppv_smooth$window)

p4_nvector_ppv_prep <- prep_for_polygon(filter(nycomps_roc, group == "N"))

p4_nvector_ppv <- ggplot(p4_nvector_ppv_prep) + 
    geom_polygon(aes(x=thresholds, y=ppv*100, group=id, fill=y_greater_min, color = y_greater_min), size = 0.1) +
    geom_path(aes(x=thresholds, y=ppv*100), size = 0.5, data = filter(nycomps_nvector_ppv_smooth, window == "1")) +
#    geom_path(aes(x=thresholds, y=ppv*100), data = filter(nycomps_nvector_ppv_smooth, window == "50")) +
    geom_hline(aes(yintercept = min(min_ppv)*100), linetype="dashed", color="darkgrey", size = 0.5) +
    annotate("text", x = -1.7, y = 55, label = "Expression in (N) His-FLAG-TEV-", size = 7*5/14, fontface = "bold", family = "Helvetica") + 
    coord_cartesian(xlim=nycomps_xscale) +
    scale_x_continuous(expand=c(0,0), breaks=nycomps_breaks) +
    scale_y_continuous(expand=c(0,0), limits=c(0,60), breaks=seq(0, 100, 20)) +
    xlab(expression("SVM"^"rank"*~"score")) + 
    ylab("Positive Predictive Value") +
    scale_color_manual(values = c("#A4A5A5", "#A10F1C")) + 
    scale_fill_manual(values = c("#A4A5A5", "#A10F1C")) + 
    theme_pub(legend.position="None", plot.margin=unit(c(1/16, 1/16, 1/16, 0), "in"))


#cterm split and summary
nycomps_cterm <- cbind(filter(nycomps_auc, type == "plasmid", cterm == "all") %>% 
                           select(-type, -cterm),
                       filter(nycomps_auc, type == "plasmid", cterm == "CYTOPLASMIC.") %>%
                           select(-group, -type, -cterm),
                       filter(nycomps_auc, type == "plasmid", cterm == "NON-CYTOPLASMIC.") %>%
                           select(-group, -type, -cterm)
                       )
temp <- nycomps_cterm$group
colnames(nycomps_cterm) <- c("group", "all_count", "all_auc", "all_lower95", "all_upper95", 
                             "cyto_count", "cyto_auc", "cyto_lower95", "cyto_upper95",
                             "non_count", "non_auc", "non_lower95", "non_upper95")
nycomps_cterm <- select(nycomps_cterm, -group)
nycomps_cterm <- nycomps_cterm[order(-nycomps_cterm$all_count),]

nycomps_cterm <- specify_decimal(nycomps_cterm*100, 1)
nycomps_cterm <-  transmute(nycomps_cterm,
                         all_count = as.numeric(all_count)/100,
                         all = paste0("'", all_auc, "'~('", all_lower95, "'-'", all_upper95, "')"),
                         cyto_count = as.numeric(cyto_count)/100,
                         cyto = paste0("'", cyto_auc, "'~('", cyto_lower95, "'-'", cyto_upper95, "')"),
                         non_count = as.numeric(non_count)/100,
                         non = paste0("'", non_auc, "'~('", non_lower95, "'-'", non_upper95, "')")
                         )

table_theme2 <-  ttheme_default(
    core = list(fg_params=list(fontsize = 5, fontfamily = "Helvetica", parse=TRUE)),
    colhead = list(fg_params=list(fontsize = 5, fontfamily = "Helvetica")),
    rowhead = list(fg_params=list(fontsize = 5, fontfamily = "Helvetica")),
    padding = unit(c(1, 2), "mm"))

header <- tableGrob(nycomps_cterm[1,], 
                    theme = table_theme2,
                    cols = c("All", "Cyto", "Peri", "", "", ""),
                    rows = "temp",
                    widths = unit(rep(c(.085, 0.165), 3), "npc"))

# Periplasmic
ind <- find_cell(header, 1, 4, "colhead-fg")
header$layout[ind, c("l", "r", "z")] <- c(6, 7, 9)
ind <- find_cell(header, 1, 4, "colhead-bg")
header$layout[ind, c("l", "r", "z")] <- c(6, 7, 8)

# Cytoplasmic
ind <- find_cell(header, 1, 3, "colhead-fg")
header$layout[ind, c("l", "r", "z")] <- c(4, 5, 9)
ind <- find_cell(header, 1, 3, "colhead-bg")
header$layout[ind, c("l", "r", "z")] <- c(4, 5, 8)

# All
ind <- find_cell(header, 1, 2, "colhead-fg")
header$layout[ind, c("l", "r", "z")] <- c(2, 3, 9)
ind <- find_cell(header, 1, 2, "colhead-bg")
header$layout[ind, c("l", "r", "z")] <- c(2, 3, 8)

temp_names <- factor(temp,
               levels = c("N", "C", "C_LDAO", 
                          "MSGC.24", "MSGC.28", "MSGC.7", "MSGC.9", "MSGC.9_LDAO"),
               labels = c("(N) His-FLAG-TEV-", "(C) -TEV-His", "(C) -TEV-His (LDAO)", 
                          "(24) His-GST-TEV-", "(28) -TEV-His", "(7) His-TEV-", "(9) His-MBP-TEV-", "(9) His-MBP-TEV- (LDAO)"))

p2_auc_table <- tableGrob(nycomps_cterm, theme = table_theme2, 
                 cols = rep(c("Count", "AUC (95% CI)" ), 3),
#                 cols = rep(c("Count", "AUC~(95*'%'*~CI)" ), 3), # bold doesnt work if parsed though plotmath
                 rows = as.character(temp_names),
                 widths = unit(rep(c(.085, 0.165), 3), "npc"),
                 heights = unit(rep(.0001, 8), "npc"))

p2_auc_table <- gridExtra::join(header[1,], p2_auc_table, along=2)

p2_auc_table$grobs[[4]][[1]] <- "C-terminal Cytoplasmic"
p2_auc_table$grobs[[5]][[1]] <- "C-terminal Periplasmic"

p2_auc_table <- gtable_add_grob(p2_auc_table,
        grobs = segmentsGrob(
            x0 = unit(0,"npc"), y0 = unit(0,"npc"),
            x1 = unit(1,"npc"), y1 = unit(0,"npc"),
            gp = gpar(lwd = 2.0)), t = 2, b = 2, l = 2, r = 7)
p2_auc_table <- gtable_add_grob(p2_auc_table,
        grobs = segmentsGrob( 
            x0 = unit(0,"npc"), y0 = unit(0,"npc"),
            x1 = unit(0,"npc"), y1 = unit(1,"npc"),
            gp = gpar(lwd = 2.0)), t = 1, b = 10, l = 4, r = 4)
p2_auc_table <- gtable_add_grob(p2_auc_table,
            grobs = segmentsGrob(
            x0 = unit(0,"npc"), y0 = unit(0,"npc"),
            x1 = unit(0,"npc"), y1 = unit(1,"npc"),
            gp = gpar(lwd = 2.0)), t = 1, b = 10, l = 6, r = 6)


p2_main <- plot_grid(
    plot_grid(p2_posmix_ppv, p2_raw_ppv,
              p2_posmix_histogram, p2_raw_histogram,
              labels = letters[c(1:4)], label_size = 8, ncol = 2, align = "v"),
    plot_grid(p2_posmix_roc, p2_raw_roc, p2_auc_table, 
              labels = letters[c(5:8)], label_size = 8, ncol=3, rel_widths = c(1, 1, 2.5)),
    nrow=2, rel_heights = c(2,1)
)

save_plot(filename = "plots/fig2_w_panels.pdf", plot = p2_main, base_width = uconv(183, "mm", "in", "Length")) #, base_height = 6)
```

# p3  tb, archaea, gpcrs, surade, and more!
# p3 ROCs (all)
```{r}
# archaea
archaea_scores <- read.csv("small-scale/archaea.fna.allstats.csv", header = TRUE, row.names=1)
rownames(archaea_scores) <- getname(rownames(archaea_scores))
archaea_scores$ml21 =  read.table("small-scale/archaea.fna.allstats.daley_only_raw_exp_ml21")$V1

archaea_outcomes <- read.csv("small-scale/archaea_S1.outcomes.csv", header = TRUE, stringsAsFactors = FALSE)
archaea_outcomes$ml21 <- archaea_scores[archaea_outcomes$Protein,]$ml21
rm(archaea_scores)

archaea_outcomes <- filter(archaea_outcomes, 
                           Measurement %in% c('WB/Gel', 'Scanning Densitometry of SDS-PAGE (%)'), 
                           !(Outcome %in% c("n.c.", "n.t.")))

# Key for Archaea Outcomes:
# "None", "WB-only", "1-10% of MP", ">10% of MP"
# "0", "1", "5", "10"

archaea_roc <- rbind(
    data.frame(
        my_roc(Outcome > 1 ~ ml21, direction = "<",
            data = filter(archaea_outcomes, Measurement != 'Scanning Densitometry of SDS-PAGE (%)')),
        positive_threshold = "sds_only"),
    data.frame(
        my_roc(Outcome > 0 ~ ml21, direction = "<",
            data = filter(archaea_outcomes, Measurement != 'Scanning Densitometry of SDS-PAGE (%)')),
        positive_threshold = "wb_sds")
)

archaea_auc <- rbind(
    data.frame(
        ci = ci.auc(Outcome > 1 ~ ml21, direction = "<", method = "delong",
            data = filter(archaea_outcomes, Measurement != 'Scanning Densitometry of SDS-PAGE (%)')),
        positive_threshold = "sds_only",
        ci_labels = c("lower95", "auc", "upper95")
        ),
    data.frame(
        ci = ci.auc(Outcome > 0 ~ ml21, direction = "<", method = "delong",
            data = filter(archaea_outcomes, Measurement != 'Scanning Densitometry of SDS-PAGE (%)')),
        positive_threshold = "wb_sds",
        ci_labels = c("lower95", "auc", "upper95")
        )
)
archaea_auc <- dcast(archaea_auc, positive_threshold ~ ci_labels, value.var = "ci")

archaea_median <- median(filter(archaea_outcomes, Measurement != 'Scanning Densitometry of SDS-PAGE (%)')$ml21)

p3_archaea_sdspage_data <- ddply(filter(archaea_outcomes, Measurement == 'Scanning Densitometry of SDS-PAGE (%)'),
                                .(Protein, ml21), summarize,
                                sds_max = max(as.numeric(Outcome)),
                                sds_min = min(as.numeric(Outcome)),
                                count = length(Outcome)
                                ) %>% filter(count != 1) 

p3_archaea_sdspage_data2 <- filter(archaea_outcomes, Measurement == 'Scanning Densitometry of SDS-PAGE (%)') %>% 
                   mutate(Outcome = as.numeric(Outcome)) %>%  
                   anti_join(p3_archaea_sdspage_data %>% gather(type, Outcome, sds_max:sds_min))

# Repeat of this one item, so spread them apart a tiny bit
p3_archaea_sdspage_data2 <- rbind(filter(p3_archaea_sdspage_data2, Protein != "Hbor39700" | Outcome != 12),
    filter(p3_archaea_sdspage_data2, Protein == "Hbor39700", Outcome == 12)[1,] %>% mutate(Outcome = 12.2),
    filter(p3_archaea_sdspage_data2, Protein == "Hbor39700", Outcome == 12)[2,] %>% mutate(Outcome = 11.8))

p3_archaea_sdspage <- ggplot(filter(archaea_outcomes, Measurement == 'Scanning Densitometry of SDS-PAGE (%)')) +
    geom_vline(xintercept = archaea_median-.015, linetype="dotted", color = "black", size = 0.5) +
    geom_point(aes(x=ml21, y=as.numeric(Outcome)), color="#A10F1C", size = 3, shape = 95, 
               data = p3_archaea_sdspage_data2) + 
    geom_errorbar(aes(x=ml21, ymin=sds_min, ymax=sds_max), color="#A10F1C", size = 0.27, width = 0.04,
                   data = p3_archaea_sdspage_data) +
    annotate("text", x = -2.9, y = 38, label = "Archaeal Transporters", size = 7*5/14, fontface = "bold") + 
    scale_y_continuous(expand = c(0,0), limits = c(0, 40)) +
    scale_x_continuous(expand = c(0,0), limits = c(-3.2, -1)) +
    ylab("Percentage of\nMembrane Protein") +
    xlab(expression("SVM"^"rank"*~"score")) + 
    scale_color_manual(values = brewer.pal(3, "Dark2")) +
    theme_pub(axis.title = element_blank(),
              axis.text.x = element_blank(),
              plot.margin = unit(c(1, 0, 2, 0), "mm"))

p3_archaea_western_data <- ddply(filter(archaea_outcomes, Measurement != 'Scanning Densitometry of SDS-PAGE (%)'),
                                   .(Protein), summarise,
                                   no = -sum(Outcome == 0),
                                   wb = sum(Outcome == 1),
                                   sdspage = sum(Outcome > 1),
                                   ml21 = ml21[[1]]
                                   ) %>% gather(group, count, no:sdspage) %>% filter(count != 0)
p3_archaea_western_data[p3_archaea_western_data$Protein == "MJ1319", "ml21"] <- 
    p3_archaea_western_data[p3_archaea_western_data$Protein == "MJ1319","ml21"] - 0.005
p3_archaea_western_data[p3_archaea_western_data$Protein == "Ta0252", "ml21"] <- 
    p3_archaea_western_data[p3_archaea_western_data$Protein == "Ta0252","ml21"] + 0.005

p3_archaea_western <- ggplot(p3_archaea_western_data) + 
    geom_vline(xintercept = archaea_median-.015, linetype="dotted", color = "black", size = 0.5) +
    geom_hline(yintercept = 0, alpha = 0.5, linetype="dashed", color = "darkgrey") +
    geom_bar(aes(x=ml21, y=count), fill="#A4A5A5",
             stat="identity", width=.02, data = filter(p3_archaea_western_data, group=="no", Protein == "MJ1319")) + 
    geom_bar(aes(x=ml21, y=count), fill="#A4A5A5",
             stat="identity", width=.02, data = filter(p3_archaea_western_data, group=="no", Protein != "MJ1319")) + 
    geom_bar(aes(x=ml21, y=count, fill=group), position = "stack",
             stat="identity", width=.02, data = filter(p3_archaea_western_data, group!="no")) +
    xlab(expression("SVM"^"rank"*~"score")) + 
    ylab("Count") +
    scale_fill_manual(values=c("#A10F1C", "#AD665D"), na.value="black") +
    scale_y_continuous(expand = c(0,0), limits = c(-6.1, 6), breaks=seq(-10,10,2)) +
    scale_x_continuous(expand = c(0,0), limits = c(-3.2, -1)) +
    theme_pub(legend.position = "none",
              axis.title = element_blank(),
              plot.margin = unit(c(0, 0, 0, 0), "lines"))

archaea_auc_labels <- mutate(archaea_auc, 
           auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0(auc, "~(", lower95, "-", upper95, ")"))
archaea_auc_labels$y <- c(.16, .07)
    
p3_archaea_roc <- ggplot(archaea_roc) + 
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_path(aes(x=1-specificities, y=sensitivities, color = factor(positive_threshold))) +
    geom_text(aes(x = .65, y = y, label=ci, color=positive_threshold), size = 5*5/14, parse=TRUE, data=archaea_auc_labels) +
    xlab("False Positive Rate") +
    ylab("True Positive Rate") +
    ggtitle("Archaeal Transporters") + 
    scale_color_manual(values = c("#A10F1C", "#AD665D"), na.value="black") +
    scale_y_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) + 
    scale_x_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) +
    theme_pub(legend.position="None", aspect.ratio = 1,
              plot.margin = unit(c(0, 0, 0, 0), "lines"), 
              axis.title = element_text(size = 6))


### M. TUBERCULOSIS OUTCOMES AND SCORES (FROM TIM CROSS'S FIRST PAPER)
tcross_outcomes <- read.csv("small-scale/tcross_mt_outcomes.csv", header = TRUE, row.names = 1, stringsAsFactors = FALSE)
tcross_outcomes <- mutate(tcross_outcomes, 
                          cloned = Cloned,
                          host = strain,
                          IB_CB = IB_CB*2,
                          SOL_CB = SOL_CB*2,
                          MEM_CB = MEM_CB*2,
                          IB_WB = as.numeric(IB_WB),
                          SOL_WB = as.numeric(SOL_WB),
                          MEM_WB = as.numeric(MEM_WB)
                          )

tcross_outcomes[is.na(tcross_outcomes$IB_WB),]$IB_WB  <- 0
tcross_outcomes[is.na(tcross_outcomes$SOL_WB),]$SOL_WB  <- 0
tcross_outcomes[is.na(tcross_outcomes$MEM_WB),]$MEM_WB  <- 0

tcross_outcomes$IB <- pmax(tcross_outcomes$IB_CB, tcross_outcomes$IB_WB)
tcross_outcomes$SOL <- pmax(tcross_outcomes$SOL_CB, tcross_outcomes$SOL_WB)
tcross_outcomes$MEM <- pmax(tcross_outcomes$MEM_CB, tcross_outcomes$MEM_WB)

tcross_outcomes <- select(tcross_outcomes, ORF, cloned, host, IB, SOL, MEM)

tcross_outcomes <- gather(tcross_outcomes, fraction, outcome, IB:MEM)
tcross_outcomes <- mutate(tcross_outcomes,
                          outcome = factor(outcome, levels=c(0,1,2), labels=c("No","WB","CB")),
                          fraction = factor(fraction, levels=c("MEM", "SOL", "IB"), labels=c("MEM", "SOL", "IB"))
                          )

tcross_scores <- data.frame(ml21 = read.table("small-scale/tcross.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
                            names = read.csv("small-scale/tcross.fna.allstats.csv", header = TRUE, stringsAsFactors = FALSE)$title)
tcross_scores$names <- getname(tcross_scores$names)

tcross_outcomes <- left_join(tcross_outcomes, tcross_scores, by = c("ORF" = "names"))
rm(tcross_scores)


tcross_C <- data.frame(ml21_vector = read.table("small-scale/tcross_C.fna.allstats.daley_only_raw_exp_ml21", 
                                                header = FALSE)$V1,
                       names = read.csv("small-scale/tcross_C.fna.allstats.csv", header = TRUE, stringsAsFactors = FALSE)$title)
tcross_C <- mutate(tcross_C, 
                   names = getname(names),
                   cloned = "C"
                   )
tcross_outcomes <- left_join(tcross_outcomes, tcross_C, by = c("ORF"="names", "cloned"="cloned"))
rm(tcross_C)

tcross_N <- data.frame(ml21_vector_N = read.table("small-scale/tcross_N.fna.allstats.daley_only_raw_exp_ml21", 
                                                header = FALSE)$V1,
                       names = read.csv("small-scale/tcross_N.fna.allstats.csv", header = TRUE)$title)
tcross_N <- mutate(tcross_N, 
                   names = getname(names),
                   cloned = "N"
                   )
tcross_outcomes <- left_join(tcross_outcomes, tcross_N, by = c("ORF"="names", "cloned"="cloned"))
rm(tcross_N)

tcross_outcomes[tcross_outcomes$cloned == 'N',]$ml21_vector <- tcross_outcomes[tcross_outcomes$cloned == 'N',]$ml21_vector_N
tcross_outcomes <- select(tcross_outcomes, -ml21_vector_N)

# > select(tcross_outcomes, ORF, cloned, host) %>% distinct %>% group_by(cloned, host) %>% summarize(tot_cloned = length(cloned))
# Source: local data frame [3 x 3]
# Groups: cloned [?]
# 
#   cloned              host tot_cloned
#    (chr)             (chr)      (int)
# 1      C CodonPlus-RP(DE3)         12
# 2      N          C42(DE3)          4
# 3      N CodonPlus-RP(DE3)         93

# > table(tcross_outcomes$outcome)
#  No  WB  CB 
# 208  66  53 
# > table(as.numeric(tcross_outcomes$outcome))
#   1   2   3 
# 208  66  53 
tcross_roc <- foreach(thisthreshold = c(2, 3), .combine='rbind') %dopar% {
    foreach(thisfraction=unique(tcross_outcomes$fraction), .combine='rbind') %dopar% {
        thisdata <- filter(tcross_outcomes, fraction == thisfraction)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(outcome) >= thisthreshold)
        roc1 <- data.frame(
            my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
            fraction = thisfraction,
            positive_threshold = thisthreshold,
            score_type = "ml21")
        roc2 <- data.frame(
            my_roc(thisresponse ~ ml21_vector, data = thisdata, direction = "<"),
            fraction = thisfraction,
            positive_threshold = thisthreshold,
            score_type = "ml21_vector")
        rbind(roc1, roc2)
    }
}
tcross_roc$positive_threshold <- factor(tcross_roc$positive_threshold, 
                                        levels = c(2, 3), 
                                        labels = c("WB", "CB"))

tcross_auc <- foreach(thisthreshold = c(2, 3), .combine='rbind') %dopar% {
    foreach(thisfraction=unique(tcross_outcomes$fraction), .combine='rbind') %dopar% {
        thisdata <- filter(tcross_outcomes, fraction == thisfraction)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(outcome) >= thisthreshold)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
            ml21_vector = ci.auc(thisresponse ~ ml21_vector, data = thisdata, direction = "<", method = "delong"),
            fraction = thisfraction,
            positive_threshold = thisthreshold,
            ci_labels = c("lower95", "auc", "upper95")
            )
        }
    }
tcross_auc$positive_threshold <- factor(tcross_auc$positive_threshold, 
                                        levels = c(2, 3), 
                                        labels = c("WB", "CB"))

tcross_auc <- gather(tcross_auc, score_type, ci, ml21:ml21_vector)
tcross_auc <- dcast(tcross_auc, fraction + positive_threshold + score_type ~ ci_labels, value.var = "ci")

tcross_outcomes <- gather(tcross_outcomes, score_type, score_value, ml21:ml21_vector)

tcross_median <- ddply(tcross_outcomes, .(score_type, fraction), summarize,
                       median = median(score_value))

p3_mt <- ggplot(filter(tcross_outcomes, score_type == "ml21", fraction == "MEM")) +
    geom_vline(aes(xintercept = median(score_value)), linetype="dotted", color="black", size = 0.5) + 
    geom_jitter(aes(x=score_value, y=outcome, fill=as.numeric(outcome), color=as.numeric(outcome)) , shape=21, size = .95,
            position = position_quasirandom(varwidth = TRUE), 
            data=filter(tcross_outcomes, score_type == "ml21", fraction == "MEM")) + # host != "C42(DE3)",
#    geom_jitter(aes(x=score_value, y=outcome, fill=as.numeric(outcome)), color="black", shape=21, size = .95,
#                position = position_quasirandom(varwidth = TRUE), 
#                data=filter(tcross_outcomes, score_type == "ml21", host == "C42(DE3)", fraction == "MEM")) +
    annotate("text", x = -3.7, y = 3.1, label = "M. tuberculosis", size = 7*5/14, fontface = "bold.italic") + 
    scale_y_discrete(labels=c("WB" = "Western\nBlot", "CB" = "Coomassie\nBlue", "No" = "No\nExpression")) +
    scale_fill_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") +
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") +
    theme_pub( #plot.title = element_text(face = "italic", size = 8),
              axis.title = element_blank(),
              legend.position="None",
              plot.margin = unit(c(0, 0, 0, 0), "lines"))

tcross_auc_labels <- filter(tcross_auc, fraction == "MEM", score_type == "ml21") %>%
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0(auc, "~(", lower95, "-", upper95, ")"))
tcross_auc_labels$y <- c(.07, .16)

p3_mt_roc <- ggplot(filter(tcross_roc, fraction == "MEM", score_type == "ml21")) + 
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_path(aes(x=1-specificities, y=sensitivities, color = factor(positive_threshold))) +
    geom_text(aes(x=.65, y=y, label=ci, color=positive_threshold), parse=TRUE, size = 5*5/14, data=tcross_auc_labels) +
    scale_color_manual(values = ggplot_build(p3_mt)$data[[2]] %>% 
                           arrange(desc(-group)) %>% select(colour) %>% unique %>% unlist %>% unname %>% tail(-1), 
                         na.value="black") +
    ylab("True Positive Rate") +
    xlab("False Positive Rate") +
    ggtitle("M. tuberculosis") +
    scale_y_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) + 
    scale_x_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) +
    theme_pub(legend.position="None",
              aspect.ratio = 1,
              plot.margin = unit(c(0, 0, 0, 0), "lines"),
              plot.title = element_text(size = 7, face = "italic"),
              axis.title = element_text(size = 6))


# GPCRs
lundstrom_scores <- read.csv("small-scale/lundstrom1.fna.allstats.csv", header = TRUE, row.names = 1)
lundstrom_scores$ml21 <- read.table("small-scale/lundstrom1.fna.allstats.daley_only_raw_exp_ml21")$V1

lundstrom_outcomes <- read.csv("small-scale/lundstrom1.060915.outcomes.csv", header = TRUE, stringsAsFactors = FALSE)
lundstrom_outcomes <- filter(lundstrom_outcomes, trust == 1)
rownames(lundstrom_outcomes) <- lundstrom_outcomes$new.ids

lundstrom_outcomes$ml21 <- lundstrom_scores[rownames(lundstrom_outcomes),]$ml21
rm(lundstrom_scores)

lundstrom_outcomes <- gather(lundstrom_outcomes, host, outcome, E..coli:SFV)
lundstrom_outcomes <- filter(lundstrom_outcomes, outcome != "nd")
lundstrom_outcomes$outcome <- factor(lundstrom_outcomes$outcome, 
                                     labels = c("No", "Low", "Medium", "High"),
                                     levels = c("0", "1", "2", "3"))

lundstrom_outcomes <- select(lundstrom_outcomes, new.ids, ml21, host, outcome)

lundstrom_median <- ddply(lundstrom_outcomes, .(host), summarize,
                          median = median(ml21))

lundstrom_roc <- foreach(thishost=unique(lundstrom_outcomes$host), .combine='rbind') %dopar% {
    data.frame(
        my_roc(outcome == "High" ~ ml21, data = filter(lundstrom_outcomes, host == thishost), direction = "<"),
        host = thishost)
    }

lundstrom_auc <- ddply(lundstrom_outcomes, .(host), summarize,
                     auc_geno = auc(response = outcome != "No", predictor = ml21, direction = "<"),
                     auc_onlyhigh = auc(response = outcome == "High", predictor = ml21, direction = "<")
                     )

# > table(lundstrom_outcomes$outcome)
#     No    Low Medium   High 
#     56     77     54     87 
# > table(as.numeric(lundstrom_outcomes$outcome))
#  1  2  3  4 
# 56 77 54 87 
lundstrom_roc <- foreach(thisthreshold = c(2, 3, 4), .combine='rbind') %dopar% {
    # ROC for each host separately
    data <- foreach(thishost=unique(lundstrom_outcomes$host), .combine='rbind') %dopar% {
        thisdata <- filter(lundstrom_outcomes, host == thishost)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(outcome) >= thisthreshold)
        df <- data.frame(
            my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
            host = thishost,
            positive_threshold = thisthreshold)
        rbind(df, NA)
    }
   rbind(data, NA)
}

lundstrom_auc <- foreach(thisthreshold = c(2, 3, 4), .combine='rbind') %dopar% {
    # ROC for each host separately
    foreach(thishost=unique(lundstrom_outcomes$host), .combine='rbind') %dopar% {
        thisdata <- filter(lundstrom_outcomes, host == thishost)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(outcome) >= thisthreshold)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
            host = thishost,
            positive_threshold = thisthreshold,
            ci_labels = c("lower95", "auc", "upper95")
          )
    }
}
lundstrom_auc <- dcast(lundstrom_auc, host + positive_threshold ~ ci_labels, value.var = "ml21")

# We need to do it this way so that the density within each expression category is computed first and
# *THEN* plotted but overlaid.
p3_gpcr_data <- ggplot(filter(lundstrom_outcomes, host %in% c("E..coli", "P..pastoris"))) +
    geom_jitter(aes(x=ml21, y=outcome, color=as.numeric(outcome)),
                position = position_quasirandom(varwidth = TRUE), shape=21) +
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") +
    facet_wrap(~host, nrow=2)
p3_gpcr_data <- ggplot_build(p3_gpcr_data)$data[[1]]
p3_gpcr_data$y <- p3_gpcr_data$y - round(p3_gpcr_data$y) - as.numeric(p3_gpcr_data$PANEL) +2

lundstrom_outcomes$host <- factor(lundstrom_outcomes$host, levels=c("P..pastoris", "E..coli", "SFV"))
p3_gpcr_sub_right <- ggplot(filter(lundstrom_outcomes, host %in% c("E..coli", "P..pastoris"))) +
    geom_segment(aes(x=median, xend=median, y=0.5, yend=1.5), size = 0.5, linetype = "dotted", 
                 data = filter(lundstrom_median, host == "E..coli")) +
    geom_segment(aes(x=median, xend=median, y=-0.5, yend=0.5), size = 0.5, linetype = "dotted", 
                 data = filter(lundstrom_median, host == "P..pastoris")) +
    geom_point(aes(x=ml21, y=as.numeric(host) + as.numeric(outcome)/7-1.3, color=as.numeric(outcome)), shape=18, size=1.5) + # 124 is | 
    annotate("text", x = -4.6, y = 1.36, label = "Mammalian GPCRs", size = 7*5/14, fontface = "bold") + 
    xlab(expression("SVM"^"rank"*~"score")) + 
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") + 
    scale_y_continuous(labels=c("0" = "P. pastoris", "1" = "E. coli"), breaks=c(0, 1), limits=c(-0.5, 1.5), expand=c(0,0)) +
    scale_x_continuous(limits=c(-5.4, 0.6), expand=c(0,0)) +
    theme_pub(legend.position="None", 
              axis.title.y = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.line.y = element_blank(),
              plot.margin = unit(c(2, 0, 2, 0), "mm"))

p3_gpcr_sub_left <- ggplot(filter(lundstrom_outcomes, host %in% c("E..coli", "P..pastoris"))) +
    geom_point(aes(x=ml21, y=as.numeric(host) + as.numeric(outcome)/7-1.3, color=as.numeric(outcome)), shape=18, size=1.5) + # 124 is | 
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") + 
    scale_y_continuous(labels=c("0" = "P. pastoris", "1" = "E. coli"), breaks=c(0, 1), limits=c(-0.5, 1.5), expand=c(0,0)) +
    scale_x_continuous(limits=c(-15, -10), expand=c(1,0), breaks = c(-10)) +
    theme_pub(legend.position="None", 
              axis.title.y = element_blank(),
              axis.text.y = element_text(face="italic", color = brewer.pal(3, "Dark2")[c(2,1)]),
              axis.title.x = element_blank(),
              plot.margin = unit(c(2, 0, 2, 4), "mm"))

p3_gpcr_main <- plot_grid(p3_gpcr_sub_left, p3_gpcr_sub_right, align = "h", nrow=1, rel_widths = c(1.3, 10))

lundstrom_auc_labels <- filter(lundstrom_auc, host %in% c("E..coli", "P..pastoris")) %>% arrange(host, -positive_threshold) %>% 
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~(", lower95, "-'", upper95, "')")) 
#lundstrom_auc_labels$y <- c(.25, .16, .07, .94, .85, .76)
#lundstrom_auc_labels$x <- c(.65, .65, .65, .35, .35, .35)
lundstrom_auc_labels$y <- c(.25, .16, .07, .25, .16, .07)
lundstrom_auc_labels$x <- c(.65, .65, .65, .75, .75, .75)

lundstrom_roc$host <- factor(lundstrom_roc$host,
                             levels = c("E..coli", "P..pastoris", "SFV"))

p3_gpcr_roc <- ggplot(filter(lundstrom_roc, host != "SFV")) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_path(aes(x=1-specificities, y=sensitivities, color = factor(positive_threshold))) +
    geom_text(aes(x=x, y=y, label=ci, color=factor(positive_threshold)), parse=TRUE, size = 5*5/14, data=lundstrom_auc_labels) +
    scale_color_manual(values = ggplot_build(p3_gpcr_1)$data[[3]] %>% 
                           arrange(desc(-group)) %>% select(colour) %>% unique %>% unlist %>% unname %>% tail(-1)) +
    ylab("True Positive Rate") +
    xlab("False Positive Rate") +
    ggtitle("Mammalian GPCRs") + 
    scale_y_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) + 
    scale_x_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) +
    theme_pub(legend.position="None",
              aspect.ratio=1,
              axis.title = element_text(size = 6),
              strip.text = element_text(size = 6, face = "italic", color=brewer.pal(3, "Dark2")[1:2]),
              plot.margin = unit(c(0, 0, 0, 0), "lines"),
              strip.switch.pad.wrap = unit(c(0, 0, 0, 0), "lines"),
              strip.switch.pad.grid = unit(c(0, 0, 0, 0), "lines")) +
    facet_wrap(~host, ncol=1, scales="free")

p3_gpcr_roc <- ggplotGrob(p3_gpcr_roc)
p3_gpcr_roc$grobs$strip_t1$grobs[[1]]$children[[2]]$children[[1]]$label <- "E. coli"
p3_gpcr_roc$grobs$strip_t2$grobs[[1]]$children[[2]]$children[[1]]$label <- "P. pastoris"
p3_gpcr_roc$grobs$strip_t2$grobs[[1]]$children[[2]]$children[[1]]$gp$col <- "#D95F02"

# t maritima
tmaritima_scores <- read.csv("small-scale/koth_tmaritima.ffn.allstats.csv", header = TRUE, row.names = 1,  stringsAsFactors = FALSE)
rownames(tmaritima_scores) <- getname(rownames(tmaritima_scores))
tmaritima_scores$ml21 <- read.table("small-scale/koth_tmaritima.ffn.allstats.daley_only_raw_exp_ml21")$V1

tmaritima_outcomes <- read.csv("small-scale/koth_tmaritima.outcomes.csv", header = TRUE, row.names = 3,  stringsAsFactors = FALSE)
tmaritima_outcomes <- rename(tmaritima_outcomes, Purified = Puriﬁed)
tmaritima_outcomes$ml21 <- tmaritima_scores[rownames(tmaritima_outcomes),]$ml21
rm(tmaritima_scores)

tmaritima_outcomes$Purified <- tmaritima_outcomes$Purified * 2
tmaritima_outcomes <- transform(tmaritima_outcomes, outcome = pmax(Expressed, Purified))
tmaritima_outcomes$outcome <- factor(tmaritima_outcomes$outcome,
                                     labels = c("No", "Expressed", "Purified"),
                                     levels = c(0, 1, 2))
tmaritima_outcomes <- select(tmaritima_outcomes, ml21, outcome)


# > table(tmaritima_outcomes$outcome)
#        No Expressed  Purified 
#        58        14         5 
# > table(as.numeric(tmaritima_outcomes$outcome))
#  1  2  3 
# 58 14  5 
tmaritima_roc <- rbind(
    data.frame(
        my_roc(as.numeric(outcome) >= 3 ~ ml21, direction = "<", data = tmaritima_outcomes),
        positive_threshold = "Purified"),
    data.frame(
        my_roc(as.numeric(outcome) >= 2 ~ ml21, direction = "<", data = tmaritima_outcomes),
        positive_threshold = "Expressed")
)

tmaritima_auc <- rbind(
    data.frame(
        ci = ci.auc(as.numeric(outcome) >= 3 ~ ml21, direction = "<", data = tmaritima_outcomes),
        positive_threshold = "Purified",
        ci_labels = c("lower95", "auc", "upper95")
        ),
    data.frame(
        ci = ci.auc(as.numeric(outcome) >= 2 ~ ml21, direction = "<", data = tmaritima_outcomes),
        positive_threshold = "Expressed",
        ci_labels = c("lower95", "auc", "upper95")
        )
)

tmaritima_auc <- dcast(tmaritima_auc, positive_threshold ~ ci_labels, value.var = "ci")


p3_tmaritima <- ggplot(tmaritima_outcomes) +
    geom_hline(aes(yintercept=median(ml21)), color = "darkgrey", linetype = "longdash") +
    geom_jitter(aes(y=ml21, x=factor(outcome), color=as.numeric(outcome)), 
                position = position_beeswarm(priority = 'density', cex=10), size=3) +
    coord_flip() +
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") +
    ggtitle("T. maritima Expression") + 
    ylab(expression("SVM"^"rank"*~"score")) + 
    theme_pub(legend.position = "None",
              axis.title.y=element_blank())

tmaritima_auc_labels <- mutate(tmaritima_auc, auc = specify_decimal(auc*100, k = 1),
                           lower95 = specify_decimal(lower95*100, k = 1),
                           upper95 = specify_decimal(upper95*100, k = 1),
                           ci = paste0(auc, "~('", lower95, "'-", upper95, ")"))
tmaritima_auc_labels$y <- c(.07, .16)

p3_tmaritima_roc <- ggplot(tmaritima_roc) + 
    geom_path(aes(x=1-specificities, y=sensitivities, color = factor(positive_threshold))) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_text(aes(x=.65, y=y, label=ci, color=positive_threshold), parse=TRUE, size = 5*5/14, data=tmaritima_auc_labels) +
    scale_color_manual(values = ggplot_build(p3_tmaritima)$data[[2]] %>% arrange(desc(-group)) %>% 
                           select(colour) %>% unique %>% unlist %>% unname %>% tail(-1), 
                         na.value="black") +
    ylab("True Positive Rate") +
    xlab("False Positive Rate") +
    ggtitle("Thermotoga maritima") +
    scale_y_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) + 
    scale_x_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) +
    theme_pub(legend.position="None", aspect.ratio = 1,
              plot.margin = unit(c(0, 0, 0, 0), "lines"),
              plot.title = element_text(size = 7, face = "italic"),
        axis.title = element_text(size = 6))

# surade
surade_scores <- read.csv("small-scale/surade.fna.allstats.csv", header = TRUE, row.names = 1, stringsAsFactors = FALSE)
rownames(surade_scores) <- getname(rownames(surade_scores))
surade_scores$ml21 <- read.table("small-scale/surade.fna.allstats.daley_only_raw_exp_ml21")$V1

surade_outcomes <- read.csv("small-scale/surade.060915.outcomes.csv", header = TRUE, stringsAsFactors = FALSE)
surade_outcomes$ml21 <- surade_scores[as.character(surade_outcomes$GI.number),]$ml21
rm(surade_scores)

surade_vectors <- data.frame(
    name = rownames(read.csv("small-scale/surade_vectors.fna.allstats.csv", header = TRUE, row.names = 1)),
    ml21_vector = read.table("small-scale/surade_vectors.fna.allstats.daley_only_raw_exp_ml21")$V1
    )
surade_vectors$vector <- getname(surade_vectors$name, token = 3)
surade_vectors$vector <- substr(surade_vectors$vector, start = 1, stop = nchar(surade_vectors$vector)-1)
surade_vectors$GI <- as.integer(getname(surade_vectors$name, token = 1))

surade_outcomes <- left_join(surade_vectors, surade_outcomes, by=c("vector" = "Vector",
                                                                  "GI" = "GI.number"))
rm(surade_vectors)

surade_outcomes$outcome <- factor(as.integer(surade_outcomes$Outcome))
surade_outcomes <- filter(surade_outcomes, !is.na(outcome))

surade_outcomes$vector <- factor(surade_outcomes$vector, 
       labels = c("E. coli pTTQ18-A", "E. coli pTTQ18-C", "E. coli pQE-A", "E. coli pQE-C",
                  "E. coli pBAD-A", "E. coli pBAD-C", "L. lactis pNZ-A", "L. lactis pNZ-C"),
       levels = c("pTTQ18-A", "pTTQ18-C", "pQE-A", "pQE-C", 
                  "pBAD-A", "pBAD-C", "pNZ-A", "pNZ-C"))
surade_outcomes <- select(surade_outcomes, vector, GI, outcome, ml21, ml21_vector)


surade_roc <- foreach(thisthreshold = c(10, 100), .combine='rbind') %dopar% {
    # ROC for each vector separately
    roc1 <- foreach(thisvector=unique(surade_outcomes$vector), .combine='rbind') %dopar% {
        thisdata <- filter(surade_outcomes, vector == thisvector)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
        data.frame(
            my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
            vector = thisvector,
            positive_threshold = thisthreshold)
    }
    # ROC for pET vectors together
    thisdata <- filter(surade_outcomes, vector %in%
                      c("E. coli pTTQ18-A", "E. coli pTTQ18-C", "E. coli pQE-A", "E. coli pQE-C"))
    thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
    roc2 <- data.frame(
        my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
        vector = "pETonly",
        positive_threshold = thisthreshold)
    
    rbind(roc1, roc2)
}

surade_auc <- foreach(thisthreshold = c(10, 100), .combine='rbind') %dopar% {
    # AUC for each vector separately
    auc1 <- foreach(thisvector=unique(surade_outcomes$vector), .combine='rbind') %dopar% {
        thisdata <- filter(surade_outcomes, vector == thisvector)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
            ml21_vector = ci.auc(thisresponse ~ ml21_vector, data = thisdata, direction = "<", method = "delong"),
            vector = thisvector,
            positive_threshold = thisthreshold,
            ci_labels = c("lower95", "auc", "upper95")
          )
    }
    
    # AUC for pET vectors together
    thisdata <- filter(surade_outcomes, vector %in%
                      c("E. coli pTTQ18-A", "E. coli pTTQ18-C", "E. coli pQE-A", "E. coli pQE-C"))
    thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
    auc2 <- data.frame(
        vector = "pETonly",
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method="delong"),
        ml21_vector = ci.auc(thisresponse ~ ml21_vector, data = thisdata, direction = "<", method="delong"),
        positive_threshold = thisthreshold,
        ci_labels = c("lower95", "auc", "upper95")
        )
    
    rbind(auc1, auc2)
}

surade_auc <- gather(surade_auc, score_type, ci, ml21:ml21_vector)
surade_auc <- dcast(surade_auc, vector + positive_threshold + score_type ~ ci_labels, value.var = "ci") 

surade_median <- ddply(surade_outcomes, .(vector), summarize,
                     median = median(ml21),
                     median_vector = median(ml21_vector)
                     )

p3_surade <- ggplot(filter(surade_outcomes, vector %in% 
                                    c("E. coli pTTQ18-A", "E. coli pTTQ18-C", "E. coli pQE-A", "E. coli pQE-C"))) +
    geom_jitter(aes(x=ml21, y=outcome, color=as.numeric(outcome)), position = position_jitter(height = .1)) + 
    geom_vline(aes(xintercept=median(ml21)), linetype = "longdash", color = "darkgrey") +
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") +
    xlab(expression("SVM"^"rank"*~"score")) + 
    ylab("Dot Density") +
    theme_pub(legend.position = "None")

surade_auc_labels <- filter(surade_auc, vector == "pETonly", score_type == "ml21") %>% 
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~(", lower95, "-", upper95, ")"),
           positive_threshold = factor(positive_threshold))
surade_auc_labels$y <- c(.07, .16)

p3_surade_roc <- ggplot(filter(surade_roc, vector == "pETonly")) + 
    geom_path(aes(x=1-specificities, y=sensitivities, color = factor(positive_threshold))) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_text(aes(x=.65, y=y, label=ci, color=positive_threshold), parse=TRUE, size = 5*5/14, data=surade_auc_labels) +
    scale_color_manual(values = unique(filter(ggplot_build(p3_surade)$data[[1]], group %in% c(2,3))$colour), 
                         na.value="black") +
    ylab("True Positive Rate") +
    xlab("False Positive Rate") +
    ggtitle("Microbial secondary transporters") +
    scale_y_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) + 
    scale_x_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) +
    theme_pub(legend.position="None", aspect.ratio = 1,
              plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title = element_text(size = 6))

# hpylori
hpylori_scores <- read.csv("small-scale/hpylori_psakis.ffn.allstats.csv", header = TRUE, 
                    row.names = 1, stringsAsFactors = FALSE)
hpylori_scores$ml21 <- read.table("small-scale/hpylori_psakis.ffn.allstats.daley_only_raw_exp_ml21")$V1

hpylori_outcomes <- read.xlsx2("small-scale/hpylori-psakis.xlsx", sheetName="Hpylori", stringsAsFactors = FALSE)
hpylori_outcomes <- mutate(hpylori_outcomes, code = toupper(Code),
                           outcome = factor(as.numeric(Outcome)),
                           group = Vector,
                           vector = factor(substring(Vector, 1, 3)),
                           scoring = factor(substrRight(Vector, 1)))
#hpylori_outcomes[hpylori_outcomes$scoring == "T",]$scoring <- NA
hpylori_outcomes <- select(hpylori_outcomes, code, group, vector, scoring, outcome)
hpylori_outcomes$group <- factor(hpylori_outcomes$group, 
                                   levels = c("pET", "LAC / A", "LAC / M", "TEV / A", "TEV / M"),
                                   labels = c("pET28 / pET36", "pQL60Lac / Automatic", "pQL60Lac / Manual", 
                                              "pQTev / Automatic", "pQTev / Manual"))
hpylori_outcomes <- filter(hpylori_outcomes, !is.na(outcome))
hpylori_outcomes$ml21 <- hpylori_scores[hpylori_outcomes$code,]$ml21
rm(hpylori_scores)

hpylori_outcomes_means <- ddply(hpylori_outcomes, .(code, vector), summarize,
                                outcome = mean(as.numeric(as.character(outcome)), na.rm = TRUE),
                                ml21 = ml21[[1]])

hpylori_median <- rbind(
    ddply(hpylori_outcomes, .(group), summarise,
          count = length(ml21),
          median = median(ml21),
          type = "direct"
          ),
    data.frame(group = "all", 
           count = length(rbind(hpylori_outcomes, filter(hpylori_outcomes, vector == "pET"))$ml21),
           median = median(rbind(hpylori_outcomes, filter(hpylori_outcomes, vector == "pET"))$ml21),
           type = "direct"),
    ddply(hpylori_outcomes_means, .(vector), summarise,
          count = length(ml21),
          median = median(ml21),
          type = "mean"
          ) %>% rename(group = vector),
    data.frame(group = "all", 
               count = length(hpylori_outcomes_means$ml21),
               median = median(hpylori_outcomes_means$ml21),
               type = "mean")
    )

hpylori_roc <- foreach(thisthreshold = c(1, 2, 3), .combine='rbind') %dopar% {
    # ROC for each vector separately
    roc1 <- foreach(thisgroup=unique(hpylori_outcomes$group), .combine='rbind') %dopar% {
        thisdata <- filter(hpylori_outcomes, group == thisgroup)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
        data.frame(
            my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
            group = thisgroup,
            positive_threshold = thisthreshold,
            type = "direct")
    }
    # ROC for all vectors together
    # need to double pET measurements since LAC and TEV have both manual and automated scores
    thisdata <- rbind(hpylori_outcomes, filter(hpylori_outcomes, vector == "pET"))
    thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
    roc2 <- data.frame(
        my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
        group = "all",
        positive_threshold = thisthreshold,
        type = "direct")
    
    roc3 <- foreach(thisthreshold=c(thisthreshold, thisthreshold-0.5), .combine='rbind') %dopar% { 
        roc4 <- foreach(thisgroup=unique(hpylori_outcomes_means$vector), .combine='rbind') %dopar% {
            thisdata <- filter(hpylori_outcomes_means, vector == thisgroup)
            thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
            data.frame(
                my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
                group = thisgroup,
                positive_threshold = thisthreshold,
                type = "mean")
        }
        
        # ROC for all vectors together (means)
        thisdata <- hpylori_outcomes_means
        thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
        roc5 <- data.frame(
            my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
            group = "all",
            positive_threshold = thisthreshold,
            type = "mean")
        
        rbind(roc4,roc5)
    }
    
    rbind(roc1, roc2, roc3)
}

hpylori_auc <- foreach(thisthreshold = c(1, 2, 3), .combine='rbind') %dopar% {
    # AUC for each vector separately
    auc1 <- foreach(thisgroup=unique(hpylori_outcomes$group), .combine='rbind') %dopar% {
        thisdata <- filter(hpylori_outcomes, group == thisgroup)
        thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
            group = thisgroup,
            positive_threshold = thisthreshold,
            type = "direct",
            ci_labels = c("lower95", "auc", "upper95")
          )
    }
    
    # AUC for all vectors together
    # need to double pET since only one measurement vs two ("Auto" and "Manual" for LAC and TEV)
    thisdata <- rbind(hpylori_outcomes, filter(hpylori_outcomes, vector == "pET"))
    thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
    auc2 <- data.frame(
        group = "all",
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method="delong"),
        positive_threshold = thisthreshold,
        type = "direct",
        ci_labels = c("lower95", "auc", "upper95")
        )
    
    auc3 <- foreach(thisthreshold=c(thisthreshold, thisthreshold-0.5), .combine='rbind') %dopar% { 
        auc4 <- foreach(thisgroup=unique(hpylori_outcomes_means$vector), .combine='rbind') %dopar% {
            thisdata <- filter(hpylori_outcomes_means, vector == thisgroup)
            thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
            data.frame(
                ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
                group = thisgroup,
                positive_threshold = thisthreshold,
                type = "mean",
                ci_labels = c("lower95", "auc", "upper95")
              )
        }
        
        # AUC for means outcomes of all vectors together
        thisdata <- hpylori_outcomes_means
        thisdata <- mutate(thisdata, thisresponse = as.numeric(as.character(outcome)) >= thisthreshold)
        auc5 <- data.frame(
            group = "all",
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method="delong"),
            positive_threshold = thisthreshold,
            type = "mean",
            ci_labels = c("lower95", "auc", "upper95")
            )
        
        rbind(auc4, auc5)
    }
    
    rbind(auc1, auc2, auc3)
}
hpylori_auc <- dcast(hpylori_auc, group + positive_threshold + type ~ ci_labels, value.var = "ml21")

p3_hpylori <- ggplot(hpylori_outcomes_means) + 
    geom_hline(aes(yintercept=median(ml21)), color = "darkgrey", linetype = "longdash") +
    geom_jitter(aes(y=ml21, x=factor(outcome), color=as.numeric(outcome)), 
                position = position_beeswarm(priority = 'density', cex=10), size=3) +
    coord_flip() +
    scale_color_gradient(low="#A4A5A5", high="#A10F1C", na.value="black") +
    ylab(expression("SVM"^"rank"*~"score")) + 
    xlab("Reported Outcome") +
    theme_pub(legend.position = "None")

hpylori_auc_labels <- filter(hpylori_auc, group == "all", type == "mean") %>% arrange(-positive_threshold) %>%
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~('", lower95, "'-'", upper95, "')"))
hpylori_auc_labels$x <- c(1, .92, .85, .77, .70, .62)
hpylori_auc_labels$y <- c(.52, .43, .34, .25, .16, .07)

p3_hpylori_roc <- ggplot(filter(hpylori_roc, group == "all", type == "mean")) + 
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
    geom_path(aes(x=1-specificities, y=sensitivities, color = factor(positive_threshold)), size = 0.4) +
    geom_text(aes(x=x, y=y, label=ci, color=factor(positive_threshold)), parse=TRUE, size = 5*5/14, data=hpylori_auc_labels) +
    scale_color_manual(values = ggplot_build(p3_hpylori)$data[[2]] %>% 
                           arrange(desc(-group)) %>% select(colour) %>% unique %>% unlist %>% unname %>% tail(-1), 
                         na.value="black") +
    ylab("True Positive Rate") +
    xlab("False Positive Rate") +
    ggtitle("Helicobacter pylori") + 
    scale_y_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) + 
    scale_x_continuous(expand = c(0, 0), breaks=c(0, .5, 1), limits=c(0, 1), labels=function(x){x*100}) +
    theme_pub(legend.position="None", aspect.ratio = 1,
              plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 7, face = "italic"),
        axis.title = element_text(size = 6))

p3_main <- ggdraw() +
    draw_plot(
        plot_grid(p3_archaea_sdspage, p3_archaea_western, p3_mt, NULL,
                  labels = c("a", "","","e"), label_size = 8, ncol = 1, align = "v", rel_heights = c(1.5, 1.5, 1.5, 2)),
        x = 0, y = .23, width = .8, height = 1-.23) + 
    draw_plot_label("c", x = 0, y = .66, size = 8) +
    draw_plot(p3_gpcr_main, x = -.0176, y = .23, width = .82, height = .25) +
    annotate("segment", x = .078, xend = .074, y = .294, yend = .303) + 
    annotate("segment", x = .0815, xend = .0775, y = .294, yend = .303) + 
    draw_label("Percentage of\nMembrane Protein", x = .03, y = .915, angle = 90, size = 7) + 
    draw_label("Number of\nConditions", x = .03, y = .75, angle = 90, size = 7) + 
    draw_label("Coomassie Blue", x = .22, y = .782, size = 6, colour = "#A10F1C") + 
    draw_label("Western Blot", x = .22, y = .762, size = 6, colour = "#AD665D") + 
    draw_label("No Expression", x = .22, y = .732, size = 6, colour = "#A4A5A5") + 
    draw_plot(
        plot_grid(p3_archaea_roc, p3_mt_roc, NULL,
                  labels = c("b","d","f"), label_size = 8, ncol = 1, align = "hv"),
        x = .82, y = .25, width = .16, height = .75) +
    draw_plot(p3_gpcr_roc, x = .815, y = 0, width = .17, height = .5) +
    draw_plot(
        plot_grid(p3_hpylori_roc, p3_surade_roc, p3_tmaritima_roc, 
                  labels = c("g", "h", "i"), label_size = 8, nrow = 1, align = "hv"),
        x = .1, y = 0, width = .7, height = .23)

save_plot(filename = "plots/fig3_w_panels.pdf", plot = p3_main, base_width = uconv(183, "mm", "in", "Length"), base_height = 5)
```

# p4 - forward predictions
```{r}
# load allstats and scores
celegans_scores <- read.csv("forward-preds/celegans_mp_wormbase.fna.allstats.csv", 
                     header = TRUE, stringsAsFactors =  FALSE)
celegans_scores$ml21 <- read.table("forward-preds/celegans_mp_wormbase.fna.allstats.daley_only_raw_exp_ml21")$V1

celegans_scores <- transmute(celegans_scores,
                      group="Metazoa",
                      species="Caenorhabditis elegans",
                      base_id=getname(gsub("_", "|", title)),
                      numTMs=numTMs,
                      ml21=ml21)

# load uniprot info
celegans_uniprot <- read.csv("forward-preds/uniprot-celegans.csv", header = TRUE, stringsAsFactors = FALSE)
celegans_uniprot <- filter(celegans_uniprot, wormbase.CDS != "#N/A")
celegans_uniprot <- select(celegans_uniprot, wormbase.CDS, Entry, Entry.name, fragment, 
                           Status, Protein.names, Length, Glycosylation, 
                           Transmembrane, Cross.reference..PDB., 
                           Sequence.uncertainty, Sequence.conflict, Sequence.caution, Disulfide.bond)
# join uniprot info with scores and add to running list
euk_preds <- inner_join(celegans_scores, celegans_uniprot, by = c("base_id" = "wormbase.CDS"))
rm(celegans_scores, celegans_uniprot)


hs_scores <- read.csv("forward-preds/hs_rnd1.fna.allstats.csv", 
                     header = TRUE, stringsAsFactors =  FALSE)
hs_scores$ml21 <- read.table("forward-preds/hs_rnd1.fna.allstats.daley_only_raw_exp_ml21")$V1

hs_scores <- transmute(hs_scores,
                      group="Metazoa",
                      species="Homo sapiens",
                      numTMs=numTMs,
                      ml21=ml21)

hs_scores$base_id <- read.table("forward-preds/hs_rnd1.fna.ids", 
                                header = TRUE, stringsAsFactors = FALSE, sep="\t")$uniprot_id

# load uniprot info
hs_uniprot <- read.csv("forward-preds/uniprot-human.csv", header = TRUE, stringsAsFactors = FALSE)
# join uniprot info with scores and add to running list
hs_scores <- inner_join(hs_scores, hs_uniprot, by = c("base_id" = "Entry"))
hs_scores$Entry <- hs_scores$base_id
hs_scores <- hs_scores[,colnames(euk_preds)]

euk_preds <- rbind(euk_preds, hs_scores)
rm(hs_scores, hs_uniprot)

# load allstats and scores
mm_scores <- read.csv("forward-preds/mm_rnd1.fna.allstats.csv", 
                     header = TRUE, stringsAsFactors =  FALSE)
mm_scores$ml21 <- read.table("forward-preds/mm_rnd1.fna.allstats.daley_only_raw_exp_ml21")$V1
mm_scores <- transmute(mm_scores,
                      group="Metazoa",
                      species="Mus musculus",
                      numTMs=numTMs,
                      ml21=ml21)

mm_scores$base_id <- read.table("forward-preds/mm_rnd1.fna.ids", 
                                header = TRUE, stringsAsFactors = FALSE, sep="\t")$uniprot_id

# load uniprot info
mm_uniprot <- read.csv("forward-preds/uniprot-mouse.csv", header = TRUE, stringsAsFactors = FALSE)
# join uniprot info with scores and add to running list
mm_scores <- inner_join(mm_scores, mm_uniprot, by = c("base_id" = "Entry"))
mm_scores$Entry <- mm_scores$base_id
mm_scores <- mm_scores[,colnames(euk_preds)]

euk_preds <- rbind(euk_preds, mm_scores)
rm(mm_scores, mm_uniprot)
euk_preds <- rename(euk_preds, uniprotid = Entry.name)
euk_preds$has_pdb <- grepl(";", euk_preds$Cross.reference..PDB.)
euk_preds$is_glycosylated <- grepl("CARBOHYD", euk_preds$Glycosylation)
euk_preds$has_disulfide_bond <- grepl("DISULFID", euk_preds$Disulfide.bond)

microbial_preds <- read.csv("forward-preds/microbial_query.fna.allstats.csv", header = TRUE, stringsAsFactors = FALSE)
microbial_preds$ml21 <- read.table("forward-preds/microbial_query.fna.allstats.daley_only_raw_exp_ml21")$V1
microbial_preds <- cbind(select(microbial_preds, numTMs, ml21), 
                         read.table("forward-preds/microbial_query.dat", header = TRUE, sep = "\t"))
microbial_preds <- select(microbial_preds, -CONVERT..pfamseq.sequence.USING.UTF8., -sequence)

microbial_preds <- mutate(microbial_preds,
                          species = gsub("/", "|", species),
                          species = getname(gsub(" ", "_", species)),
                          species = gsub("_", " ", species))
microbial_preds <- rename(microbial_preds, group = grouping, uniprotid=pfamseq_acc)

microbial_preds <- filter(microbial_preds, species != "Escherichia coli (strain ATCC 33849 ")

forward_preds <- rbind(select(euk_preds, group, species, uniprotid, numTMs, ml21), 
                       select(microbial_preds, group, species, uniprotid, numTMs, ml21))

forward_preds <- filter(forward_preds, numTMs > 0)
forward_preds$species <- regmatches(forward_preds$species, 
                                    regexpr('\\w+\\W{1,2}\\w+', forward_preds$species, perl=TRUE))

# Two E. coli datasets here for plotting comparison
daley_outcomes <- read.csv("training/AllPlates_161104_with_raw.csv", header = TRUE) %>%
    filter(Cterm_new == "in", Keep. == 1) %>%
    transmute(gfp = Normalised.GFP..I.e..x.3924.,
              ID = tolower(ID)) %>%
    left_join(ecoli_training, by = c("ID" = "ID")) %>%
    dplyr::select(gfp, ID, ml21) %>%
    filter(gfp > 0)
daley_outcomes <- daley_outcomes[!duplicated(daley_outcomes),]
rownames(daley_outcomes) <- daley_outcomes$ID


fluman_outcomes <- read.csv("training/fluman_data_all.csv", header = TRUE)
rownames(fluman_outcomes) <- fluman_outcomes$name
fluman_outcomes <- select(fluman_outcomes, folded.exp, folded.exp.1, folded.exp.2)
fluman_outcomes <- fluman_outcomes/c(fluman_outcomes['emrD',])
fluman_outcomes$avg_folded <- 
    rowMeans(data.frame(fluman_outcomes$folded.exp, 
                        fluman_outcomes$folded.exp.1, 
                        fluman_outcomes$folded.exp.2), na.rm = TRUE)
fluman_outcomes$ID <- tolower(rownames(fluman_outcomes))
fluman_outcomes <- left_join(fluman_outcomes, ecoli_training, by = c("ID" = "ID")) %>%
    select(ID, avg_folded, ml21)
fluman_outcomes <- fluman_outcomes[!duplicated(fluman_outcomes),]
rownames(fluman_outcomes) <- fluman_outcomes$ID

# tidy datasets here for plotting
euk_preds <- gather(euk_preds, feature, value, has_pdb, is_glycosylated, has_disulfide_bond)
euk_preds$species <- factor(as.character(euk_preds$species),
                            levels = c("Homo sapiens", "Mus musculus", "Caenorhabditis elegans"),
                            labels = c("Homo sapiens", "Mus musculus", "Caenorhabditis elegans"))

euk_preds$feature <- factor(as.character(euk_preds$feature),
                          levels = c("has_pdb", "is_glycosylated", "has_disulfide_bond"),
                          labels = c("Structure in PDB", "Glycosylated", "Disulfide Bond"))

euk_preds$value <- factor(as.character(euk_preds$value),
                          levels = c("FALSE", "TRUE"),
                          labels = c("No", "Yes"))

# give a table with counts in each category, counts above score 0, counts above score 2
forward_tufte_boxplots <- ddply(filter(forward_preds, numTMs > 1), .(group, species), summarize,
      count = length(ml21),
      # for tufte like boxplots, if the min is < xrange min, then the whole linepart doesnt show:
      boxplot_1 = boxplot.stats(ml21, coef = 1.5, do.conf = TRUE, do.out = TRUE)$stats[[1]],
      boxplot_1 = ifelse(boxplot_1 < nycomps_xscale[[1]], nycomps_xscale[[1]], boxplot_1),
      boxplot_2 = boxplot.stats(ml21, coef = 1.5, do.conf = TRUE, do.out = TRUE)$stats[[2]],
      boxplot_3_median = boxplot.stats(ml21, coef = 1.5, do.conf = TRUE, do.out = TRUE)$stats[[3]],
      boxplot_4 = boxplot.stats(ml21, coef = 1.5, do.conf = TRUE, do.out = TRUE)$stats[[4]],
      boxplot_5 = boxplot.stats(ml21, coef = 1.5, do.conf = TRUE, do.out = TRUE)$stats[[5]],
      boxplot_5 = ifelse(boxplot_5 > nycomps_xscale[[2]], nycomps_xscale[[2]], boxplot_5)
      ) %>% arrange(species == "Escherichia coli", group == "Metazoa", boxplot_3_median)

forward_ec_thresholds <- filter(forward_tufte_boxplots, species == "Escherichia coli") %>% 
    select(-group, -species,-count) %>% matrix %>% unlist

forward_targets_table <- ddply(forward_preds, .(group, species), summarize, 
      totalMPs = length(ml21),
      MPs_ge_ECmed = sum(ml21 >= forward_ec_thresholds[[3]]),
      MPs_ge_ECq3 = sum(ml21 > forward_ec_thresholds[[4]]),
      polyMPs_ge_ECmed = sum(ml21 > forward_ec_thresholds[[3]] & numTMs > 1),
      polyMPs_ge_ECq3 = sum(ml21 > forward_ec_thresholds[[4]] & numTMs > 1)
      )

forward_preds_order <- c(
    "Vibrio cholerae",
    "Helicobacter pylori",
    "Campylobacter jejuni",
    "Mycobacterium tuberculosis",
    "Staphylococcus aureus",
    "Plasmodium falciparum",
    
    "Aquifex aeolicus",
    "Thermus thermophilus",
    "Spirochaeta thermophila",
    
    "Gloeobacter violaceus",
    "Rhizobium loti",
    "Methanococcus maripaludis",
    "Haloarcula marismortui",
    "Bacillus halodurans",
    
    "Lactobacillus casei",
    "Bacillus cereus",
    "Bacillus subtilis",
    "Escherichia coli",
    
    "Caenorhabditis elegans",
    "Mus musculus",           
    "Homo sapiens")

p4_all_violin <- ggplot(forward_preds) + 
    geom_point(aes(x=species, y=boxplot_3_median), color = "darkgrey", data = forward_tufte_boxplots) + 
    geom_text(aes(x=species, y=-6, label = species), vjust = 2, fontface = "italic", size = 7*5/14, data = forward_tufte_boxplots) + 
    geom_linerange(aes(x=species, ymin=boxplot_1, ymax=boxplot_2), color = "darkgrey", data = forward_tufte_boxplots)+ 
    geom_linerange(aes(x=species, ymin=boxplot_4, ymax=boxplot_5), color = "darkgrey", data = forward_tufte_boxplots) +
    geom_violin2(aes(y=ml21, x=species), color = "black", adjust = 0.3, alpha = 0) + 
    # to get the tufte-like boxplots
    geom_hline(yintercept=forward_ec_thresholds[[3]], linetype="dashed", color="darkgrey") +
    #geom_hline(yintercept=forward_ec_thresholds[[4]], linetype="dashed", color="darkgrey") +
    coord_flip() +
    ylab(expression("SVM"^"rank"*~"score")) + 
    scale_y_continuous(expand=c(0,0), limits=nycomps_xscale, breaks=nycomps_breaks) +
    scale_x_discrete(limits=forward_preds_order) +
    theme_pub(axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.y = element_blank(),
              axis.line.y = element_blank())

p4_selected_violin <- p4_all_violin + 
    scale_x_discrete(
        limits=c("Plasmodium falciparum",
                    "Aquifex aeolicus",
                    "Thermus thermophilus",
                    "Haloarcula marismortui",
                    "Bacillus halodurans",
                    "Escherichia coli",
                    "Homo sapiens"))

p4_ecoli <- ggplot(daley_outcomes) +
    geom_violin(aes(x = "E. coli", y=log(gfp)), adjust = 0.25, alpha = 1, weight = 0.5) +
    coord_flip() + 
    ylab(expression("ln"("Whole Cell GFP Fluorescence"))) +
    annotate("text", x = .6, y = -3, label = "E. coli", size = 7*5/14, fontface = "italic") +
    theme_pub(
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank()
        )

p4_main <- ggdraw() + 
    draw_plot(plot_grid(p4_ecoli, p4_nvector_ppv, nrow = 1, align = "hv"), 0, .67, 1, .33) +
    draw_plot(p4_selected_violin, 0, 0, 1, .7) +
    draw_plot_label(letters[1:3], c(0, 0.48, 0), c(1, 1, 0.7), size = 8)

save_plot(filename = "plots/fig4_w_panels.pdf", plot = p4_main, base_width = uconv(120, "mm", "in", "Length"))

# RGB by default
save_plot(filename = "plots/extfig1.tiff", 
          plot = ggdraw(p4_all_violin) + 
              draw_plot_label("a", size = 8), 
          base_width = uconv(120, "mm", "in", "Length"), base_height = 7,
          dpi = 300)
```

```{r}
sessionInfo()
```
