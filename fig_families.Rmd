---
title: "Data munging and figure preparation"
author: "Shyam Saladi (saladi@caltech.edu)"
date: "09/20/2016"
output: html_document
---

## Load libraries
Load all libraries necessary for subsequent data munging and plotting.
Some defaults are set here to make things easier throughout.
```{r libraries}
# if TRUE, then data will be written to file
write_out = FALSE

library(tibble)
library(dplyr)
library(dplyrExtras)
library(tidyr)

library(caret)

library(ggplot2)
library(cowplot)
library(corrplot)
library(viridis)
theme_set(theme_cowplot(font_size = 7))

library(foreach)
library(doMC)
registerDoMC(cores = 10)
```

## Convenience functions
Load another file with a number of helper functions to mechanize some tedious
or repetitive tasks.
```{r}
source("preparation-convenience.R")
source("predict.R")
```

```{r forward_preds_pca}
source("https://bioconductor.org/biocLite.R")
library(pcaMethods)

# replace NaN with NA
forward_trans <- preprocess_vars(forward_features,
                                 daley_allstats_exp_xtrans_params) %>%
    as.matrix(forward_trans)
forward_trans[is.nan(forward_trans)] <- NA
forward_trans <- data.frame(forward_trans)

forward_nipals <- pca(forward_trans, center = TRUE, scale = "uv",
                      method = "nlpca", nPcs = 20, completeObs = FALSE)
```

# Calculate Pfam overlap between E. coli and NYCOMPS
```{r pfam_nycomps_overlap}
ecoli_pfam <- bind_rows(
    read.table("../ml-datasets/ecoli-daley-fluman/precalc/Daley_gfp.fna.faa.pfamA",
               comment.char = '#', as.is = TRUE),
    read.table("../ml-datasets/ecoli-daley-fluman/precalc/Daley_phoa.fna.faa.pfamA",
               comment.char = '#', as.is = TRUE))

colnames(ecoli_pfam) <- c('seq_id', 'alignment_start', 'alignment_end',
                          'envelope_start', 'envelope_end', 'hmm_acc',
                          'hmm_name', 'type', 'hmm_start', 'hmm_end',
                          'hmm_length', 'bit_score', 'E-value',
                          'significance', 'clan')

nycomps_pfam <- bind_rows(
    read.table("../ml-datasets/nycomps/nycomps_only_pos.fna.faa.pfamA",
               comment.char = '#', as.is = TRUE),
    read.table("../ml-datasets/nycomps/nycomps_only_neg.fna.faa.pfamA",
               comment.char = '#', as.is = TRUE),
    read.table("../ml-datasets/nycomps/nycomps_mixed.fna.faa.pfamA",
               comment.char = '#', as.is = TRUE))
nycomps_pfam$id <- getname(nycomps_pfam$seq_id, token = 3) %>% as.numeric
colnames(nycomps_pfam) <- colnames(ecoli_pfam)

nycomps_pfam$hmm_training <- nycomps_pfam$hmm_acc %in% ecoli_pfam$hmm_acc
nycomps_pfam$clan_training <- nycomps_pfam$clan %in% ecoli_pfam$clan

nycomps_vectors$hmm_training <- 
    nycomps_vectors$id %in% nycomps_pfam[nycomps_pfam$hmm_training,]$id
nycomps_vectors$clan_training <- 
    nycomps_vectors$id %in% nycomps_pfam[nycomps_pfam$clan_training,]$id

nycomps_auc_hmm_training <-
    foreach(thisplasmid = unique(nycomps_vectors$plasmid_name),
            .combine = bind_rows, .multicombine = TRUE) %dopar% {
    thisdata <- filter(nycomps_vectors,
                       plasmid_name == thisplasmid, hmm_training)
    thisdata <- transmute(thisdata,
                          thisresponse = plasmid_outcome == 1,
                          ml21 = ml21)
    df1 <- data.frame(
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                      direction = "<", method = "delong"),
        group = thisplasmid,
        type = "plasmid",
        cterm = "all",
        ci_labels = c("lower95", "auc", "upper95"),
        count = nrow(thisdata),
        pos_count = sum(thisdata$thisresponse)
        )
    
    df2 <- foreach(thiscterm = unique(nycomps_vectors$cterm),
                   .combine = bind_rows, .multicombine = TRUE) %dopar% {
        thisdata <- nycomps_vectors %>%
            filter(plasmid_name == thisplasmid,cterm == thiscterm) %>%
            transmute(thisresponse = plasmid_outcome == 1,
                      ml21 = ml21)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                          direction = "<", method = "delong"),
            group = thisplasmid,
            type = "plasmid",
            cterm = thiscterm,
            ci_labels = c("lower95", "auc", "upper95"),
            count = nrow(thisdata),
            pos_count = sum(thisdata$thisresponse)
            )
    }
    
    bind_rows(df1, df2)
} %>% mutate(hmm = TRUE)

nycomps_auc_hmm_training <-
    foreach(thisplasmid = unique(nycomps_vectors$plasmid_name),
            .combine = bind_rows, .multicombine = TRUE) %dopar% {
    thisdata <- filter(nycomps_vectors, plasmid_name == thisplasmid, !hmm_training)
    thisdata <- transmute(thisdata, 
                          thisresponse = plasmid_outcome == 1, ml21 = ml21)
    df1 <- data.frame(
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata, direction = "<", method = "delong"),
        group = thisplasmid,
        type = "plasmid",
        cterm = "all",
        ci_labels = c("lower95", "auc", "upper95"),
        count = nrow(thisdata),
        pos_count = sum(thisdata$thisresponse)
        )
    
    df2 <- foreach(thiscterm = unique(nycomps_vectors$cterm),
            .combine = bind_rows, .multicombine = TRUE) %dopar% {
        thisdata <- filter(nycomps_vectors,
                           plasmid_name == thisplasmid, cterm == thiscterm)
        thisdata <- transmute(thisdata, 
                              thisresponse = plasmid_outcome == 1,
                              ml21 = ml21)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                          direction = "<", method = "delong"),
            group = thisplasmid,
            type = "plasmid",
            cterm = thiscterm,
            ci_labels = c("lower95", "auc", "upper95"),
            count = nrow(thisdata),
            pos_count = sum(thisdata$thisresponse)
            )
    }
    
    bind_rows(df1, df2)
} %>% mutate(hmm = FALSE) %>% bind_rows(nycomps_auc_hmm_training)

nycomps_auc_hmm_training <- 
    dcast(nycomps_auc_hmm_training,
          group + type + cterm + count + pos_count + hmm ~ ci_labels,
          value.var = "ml21")

ggplot(nycomps_auc_hmm_training %>% filter(cterm == "all")) +
    geom_errorbar(aes(x = group,
                   ymin = upper95,
                   ymax = lower95),
              width = 0.25) + 
    geom_point(aes(x = group, y = auc, color = hmm))
    # geom_segment(aes(x = parent_score,
    #                xend = mutant_score,
    #                y = parent_expression,
    #                yend = mutant_expression,
    #                color = parent), 
    #            arrow = arrow(length = unit(0.02, "npc"), type = "closed"))
```

```{r session}
if (write_out)
    save.image("fig_other.Rdata")
sessionInfo()
```
