---
title: "Data munging and figure preparation"
author: "Shyam Saladi (saladi@caltech.edu)"
date: "09/20/2016"
output: html_document
---

## Load libraries
Load all libraries necessary for subsequent data munging and plotting.
Some defaults are set here to make things easier throughout.
```{r libraries}
# if TRUE, then data will be written to file
write_out = TRUE

library(datamart) # `uconv` for unit conversion

library(magrittr)
library(tidyverse)
library(dplyrExtras)

library(pROC)
library(ggbeeswarm)
library(cowplot)
library(RColorBrewer)
theme_set(theme_cowplot(font_size = 7L))

library(parallel)
# currently provisioned resources
# cl <- c("brnode05", "brnode07", "brnode08") %>%
#     rep(20) %>%
#     c(rep("brnode11", 44)) %>%
#     makeCluster()

library(foreach)
library(doMC)
registerDoMC(cores = 20L)
#
# library(doParallel)
# registerDoParallel(cl)

# devtools::install("myutils")
library(myutils)
```

### Load NYCOMPS data for prediction function
```{r}
nycomps_env <- new.env()
load("large-scale.Rdata", nycomps_env)
```

### Define auc function for the subsequent calculations
```{r}
auc_w_ci <- partial(ci.auc, direction = "<",
                    method = "delong"#,
                    # boot.n = 1000,
                    # progress = "none",
                    # parallel = TRUE
                    )
```

# Calculate Pfam overlap between E. coli and NYCOMPS
```{r pfam_nycomps_overlap}
ecoli_pfam <- c("training/Daley_gfp.fna.faa.pfamA",
                "training/Daley_phoa.fna.faa.pfamA") %>%
    lapply(read.table, comment.char = '#', as.is = TRUE) %>%
    bind_rows
colnames(ecoli_pfam) <- c('id', 'alignment_start', 'alignment_end',
                          'envelope_start', 'envelope_end', 'hmm_acc',
                          'hmm_name', 'type', 'hmm_start', 'hmm_end',
                          'hmm_length', 'bit_score', 'E-value',
                          'significance', 'clan')
ecoli_pfam %<>%
    separate(id, "id")

ecoli_pfam_summary <- ecoli_pfam %>%
    group_by(id) %>%
    arrange(id, envelope_start) %>%
    summarize(hmm_arch = paste(hmm_acc, collapse = " "),
              clan_arch = paste(clan, collapse = " "))

nycomps_pfam <- c("large-scale/nycomps_only_pos.fna.faa.pfamA",
                  "large-scale/nycomps_only_neg.fna.faa.pfamA",
                  "large-scale/nycomps_mixed.fna.faa.pfamA") %>%
    lapply(read.table, comment.char = '#', as.is = TRUE) %>%
    bind_rows %>%
    as_data_frame
colnames(nycomps_pfam) <- colnames(ecoli_pfam)

nycomps_pfam %<>%
    separate(id, c("temp", "id"), convert = TRUE) %>%
    select(-temp) %>%
    # only keep Pfam families
    filter(type == "Family") %>%
    mutate(hmm_training = hmm_acc %in% ecoli_pfam$hmm_acc,
           clan_training = clan %in% ecoli_pfam$clan) %>%
    mutate_rows(clan == "No_clan", clan_training = NA, clan = NA)
```

# merge pfam information with outcomes
```{r}
nycomps_pfam_outcomes <- nycomps_env$nycomps_all_outcomes %>%
    mutate(outcome = plasmid_outcome == 1) %>%
    rename(grp = plasmid_name)

nycomps_pfam_outcomes <- nycomps_env$nycomps_gene_outcomes %>%
    mutate(grp = "genes") %>%
    rename(outcome = posmix_outcome) %>%
    bind_rows(nycomps_pfam_outcomes) %>%
    mutate(grp = factor(grp,
               levels = c("genes",
                          "N", "C",
                          "C_LDAO", "MSGC.24",
                          "MSGC.28", "MSGC.7",
                          "MSGC.9", "MSGC.9_LDAO"),
               labels = c("All Genes",
                          "His-FLAG-TEV- (N)", "-TEV-His (C)",
                          "-TEV-His (C, LDAO)", "His-GST-TEV- (24)",
                          "-TEV-His (28)", "His-TEV- (7)",
                          "His-MBP-TEV-(9)", "His-MBP-TEV- (9, LDAO)"))) %>%
    select(grp, id, outcome, score)

# need to do it in this convoluted way to get proper NA handling
# don't want multiple NA's for genes with multiple Pfam hits without clans
# lack of a clan should be treated the same way as not having a Pfam hit
# at all
nycomps_pfam_outcomes <- nycomps_pfam %>%
    distinct(id, hmm_acc, hmm_training) %>%
    left_join(nycomps_pfam_outcomes, ., by = "id") %>%
    gather(attribute, attr_value, hmm_acc, hmm_training) %>%
    bind_rows(nycomps_pfam %>%
                  distinct(id, clan, clan_training) %>%
                  left_join(nycomps_pfam_outcomes, ., by = "id") %>%
                  gather(attribute, attr_value, clan, clan_training))

nycomps_pfam_outcomes %<>%
    filter(grp != "All Genes") %>%
    mutate(grp = "All Outcomes") %>%
    bind_rows(nycomps_pfam_outcomes)
```

# calculate AUC for subsets
```{r}
auc_wrapper <- function(df) {
    if (sum(df$outcome) > 1 & sum(!df$outcome) > 1) {
        out <- data_frame(score = auc_w_ci(response = df$outcome,
                                        predictor = df$score),
                          ci_labels = c("lower95", "auc", "upper95"))
    } else {
        out <- data_frame(score = c(NA, auc(response = df$outcome,
                                            predictor = df$score,
                                            direction = "<"),
                                    NA),
                          ci_labels = c("lower95", "auc", "upper95"))
    }
    out %>%
        mutate(count = nrow(df),
               pos_count = sum(df$outcome),
               neg_count = sum(!df$outcome))
}

#overall for each group
nycomps_auc <- nycomps_pfam_outcomes %>%
    group_by(grp) %>%
    filter(n() > 1, count_uniq(outcome) > 1, count_uniq(score) > 1) %>%
    do(auc_wrapper(.)) %>%
    spread(ci_labels, score)

# split by category
nycomps_pfam_auc <- nycomps_pfam_outcomes %>%
    group_by(grp, attribute, attr_value) %>%
    filter(n() > 1, count_uniq(outcome) > 1, count_uniq(score) > 1) %>%
#    filter(grp == "-TEV-His (C,LDAO)") %>%
    # filter(attribute %in% c("hmm_training", "hmm_acc"), attr_value %>% is.na) %$%
    # table(grp)
    do(auc_wrapper(.)) %>%
    spread(ci_labels, score)
```

# auc for families in training or not
```{r}
p_hmm_acc <- nycomps_pfam %>%
    distinct(hmm_acc, hmm_training) %>%
    group_by(hmm_training) %>%
    summarize(hmm_count = n()) %>%
    add_row(hmm_training = "NONE", hmm_count = "") %>%
    mutate(label = "In training") %>%
    mutate_rows(hmm_training == "FALSE", label = "Not in training") %>%
    mutate_rows(hmm_training == "NONE", label = "No Pfam") %>%
    mutate_rows(hmm_training != "NONE",
                label = paste0(label, "\n(", hmm_count, ")")) %>%
    arrange(hmm_training == "TRUE", hmm_training == "FALSE") %$%
    setNames(label, hmm_training)

p_hmm_acc <- nycomps_pfam_auc %>%
    filter(attribute == "hmm_training", grp == "All Outcomes") %>%
    ungroup %>%
    mutate_rows(is.na(attr_value), attr_value = "NONE") %>%
    mutate(attr_value = attr_value) %>%
    ggplot(aes(x = attr_value)) +
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "lightgrey") +
    geom_pointrange(aes(ymin = upper95, y = auc, ymax = lower95),
                    size = 0.5, fatten = 0.5,
                    position = position_dodge(width = 0.5)) +
    geom_text(aes(y = 0.45, label = fmt_cnt(pos_count, count)),
              size = 5*5/14) +
    ylab("AUC") +
    scale_x_discrete(expand = c(0, 0),
                     labels = p_hmm_acc,
                     limits = names(p_hmm_acc) %>% rev) +
    scale_y_continuous(expand = c(0, 0),
                       breaks = seq(0, 1, .1),
                       labels = function(x) x*100) +
    # necessary for the labels
    coord_cartesian(ylim = c(0.495, 0.65)) +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(size = 6),
          # necessary for the labels
          plot.margin = unit(c(4, 0, 19, 4), "pt"))

p_hmm_acc %<>% ggplotGrob()
p_hmm_acc$layout$clip <- "off"

ggdraw(p_hmm_acc)
```


```{r}
nycomps_pfam_outcomes_auc <- nycomps_pfam_auc %>%
    filter(grp == "All Outcomes", attribute == "hmm_acc", count > 5,
           !is.na(attr_value)) %>%
    ungroup %>%
    # for confidence groups, need to do this
    mutate_rows(is.na(lower95), upper95 = auc, lower95 = auc) %>%
    mutate(cumedist = row_number(auc) / length(auc),
           conf_grp = ifelse(auc <= 0.5, 0,
                             ifelse(lower95 <= 0.5, 0.5, 1))) %>%
    separate(attr_value, c("pfam_main"), remove = FALSE) %>%
    left_join(nycomps_pfam %>% distinct(hmm_acc, hmm_name),
              by = c("attr_value" = "hmm_acc"))
```

## Considering multiple comparison adjustments:
In the case here, we don't actually drop anything out in the process, so it
seems within the FCR framework adjustment is not necesary (i.e., R == m). See:
Benjamini, Y., and D. Yekutieli. “False Discovery Rate-Adjusted Multiple
Confidence Intervals for Selected Parameters.” Journal of the American
Statistical Association 100, no. 469 (2005): 71–81.
https://en.wikipedia.org/wiki/False_coverage_rate
http://stats.stackexchange.com/a/148273/62183

# ecdf nycomps all outcomes - min max vectors
```{r}
get_ecdf_labels <- function(df)
    df %>%
    group_by(conf_grp) %>%
    summarize(count = n()) %>%
    ungroup %>%
    mutate(proport = round(count / sum(count)*100) %>% paste0("%")) %>%
    add_row(proport = nrow(df), conf_grp = NA)

p_nycomps_summary <- nycomps_pfam_outcomes_auc %>%
    ggplot(aes(x = auc, y = cumedist)) +
    geom_segment(aes(x = lower95, xend = upper95, yend = cumedist),
                 alpha = 0.25, size = 0.25) +
    geom_point(aes(color = conf_grp), size = 0.15) +
    geom_text(aes(x = 0.06,
                  y = 0.84 + ifelse(is.na(conf_grp), -.05, conf_grp/9),
                  label = proport, color = conf_grp),
              size = 5*5/14,
              data = get_ecdf_labels(nycomps_pfam_outcomes_auc)) +
    xlab("AUC") +
    ylab("Cumulative Density") +
    scale_x_continuous(limits = c(-.01, 1.01), expand = c(0, 0),
                       labels = function(x) x*100) +
    scale_y_continuous(limits = c(-.01, 1.01), expand = c(0, 0),
                       labels = function(x)
                           paste0(specify_decimal(x*100, 0L), "%")) +
    scale_color_continuous(low = "#A4A5A5", high = "#A10F1C",
                           na.value = "black", guide = "none") +
    theme(legend.title = element_blank(),
          legend.position = c(0.2, 0.8))

p_nycomps_summary %<>% ggplotGrob

p_nycomps_summary$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_nycomps_summary)
```

# confidence groups
```{r}
get_ecdf_labels(nycomps_pfam_outcomes_auc)
```

```{r}
format_auc <- function(auc, lower95, upper95, k = 1L)
    paste0(specify_decimal(auc*100, k), " (",
           specify_decimal(lower95*100, k), "-",
           specify_decimal(upper95*100, k), ")")

format_cnt <- function(pos_count, count, k = 0L)
    paste0(specify_decimal(pos_count/count*100, k), "%/", count)
```

```{r}
make_family_plot <- function(df, labels, plot_all = TRUE) {
    data <- df %>%
    filter(grp != "All Outcomes", grp != "All Genes") %>%
    group_by(attr_value) %>%
    # enforce that a confidence interval exists
    filter(!is.na(lower95)) %>%
    # find min and max AUC conditions
    filter(auc %in% c(min(auc), max(auc)))

    if (plot_all)
        data %<>%
            bind_rows(nycomps_pfam_auc %>%
                      filter(grp == "All Outcomes") %>%
                      semi_join(data, by = "attr_value"))

    data %<>%
        ungroup %>%
        mutate(label = paste0(format_cnt(pos_count, count), "\n",
                              format_auc(auc, lower95, upper95)),
               attr_label = labels) %>%
        arrange(attr_value, grp == "All Outcomes", auc)

    to_plot <- nycomps_pfam_outcomes %>%
        inner_join(data)

     ggplot(to_plot, aes(x = attr_label, y = score)) +
        geom_point(aes(color = outcome), size = 0.25,
                   position = position_beeswarm(dodge.width = .5)) +
        geom_text(aes(y = max(to_plot$score) + diff(range(to_plot$score)) * .12,
                      label = label),
                  size = 5*5/14, data = data) +
        scale_color_manual(values = c(`TRUE` = "#A10F1C",
                                      `FALSE` = "#A4A5A5")) +
        scale_x_discrete(expand = c(0, 0),
                         limits = data$attr_label) +
        ylab(expression("SVM" ^ "rank"*~"score")) +
        coord_flip() +
        theme(legend.position = "None",
              axis.title.y = element_blank(),
              plot.margin = unit(c(0, 0, 0, 0), "pt"))
}
```

# single vector families selected
```{r}
family_labels <-
    c(PF05425.10 = 'Copper\nresistance\nprotein D\n(PF05425)',
      PF02667.11 = 'Short-chain\nfatty-acid\ntransporter\n(PF02667)')

p_single <- nycomps_pfam_auc %>%
    filter(attr_value %in% c("PF05425.10",  "PF02667.11")) %>%
    make_family_plot(., labels = family_labels, plot_all = FALSE) %>%
    ggplotGrob

p_single$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_single)
```


```{r}
f_families <- ggdraw() +
    plot_grid(p_hmm_acc, p_nycomps_summary,
              labels = letters[1:3], label_size = 8,
              align = "none", rel_widths = c(3, 3), nrow = 1L) %>%
    draw_plot(x = 0, y = .4, width = 1, height = .6) +
    plot_grid(p_single,
              labels = letters[3], label_size = 8, vjust = 0,
              align = "v", rel_heights = c(2, 3, 3), ncol = 1L) %>%
    draw_plot(x = 0, y = 0, width = 1, height = .4)

f_families %<>% ggplotGrob

# dont clip d labels
f_families$grobs[[7L]]$children[[3L]]$children$layout$layout %<>%
    mutate_rows(name == "panel", clip = "off")

if (write_out == TRUE) {
    save_plot(filename = "plots/fig5.pdf",
              plot = f_families,
              base_width = uconv(89, "mm", "in", "Length"),
              base_height = 2.5)
}
ggdraw(f_families)
```

```{r session}
sessionInfo()
```
