---
title: "Data munging and figure preparation"
author: "Shyam Saladi (saladi@caltech.edu)"
date: "09/20/2016"
output: html_document
---

## Load libraries
Load all libraries necessary for subsequent data munging and plotting.
Some defaults are set here to make things easier throughout.
```{r libraries}
# if TRUE, then data will be written to file
write_out = FALSE

library(magrittr)
library(tidyverse)
library(dplyrExtras)

library(pROC)
library(datamart) # `uconv` for unit conversion
library(ggbeeswarm)
library(cowplot)
library(RColorBrewer)
theme_set(theme_cowplot(font_size = 7L))

library(parallel)
# currently provisioned resources
# cl <- c("brnode05", "brnode07", "brnode08") %>%
#     rep(20) %>%
#     c(rep("brnode11", 44)) %>%
#     makeCluster()

library(foreach)
library(doMC)
registerDoMC(cores = 20L)
#
# library(doParallel)
# registerDoParallel(cl)

# devtools::install("myutils")
library(myutils)
```

### Load NYCOMPS data for prediction function
```{r}
nycomps_env <- new.env()
load("large-scale.Rdata", nycomps_env)
```

### Define auc function for the subsequent calculations
```{r}
auc_w_ci <- partial(ci.auc, direction = "<",
                    method = "delong"#,
                    # boot.n = 1000,
                    # progress = "none",
                    # parallel = TRUE
                    )
```

# Calculate Pfam overlap between E. coli and NYCOMPS
```{r pfam_nycomps_overlap}
ecoli_pfam <- c("training/Daley_gfp.fna.faa.pfamA",
                "training/Daley_phoa.fna.faa.pfamA") %>%
    lapply(read.table, comment.char = '#', as.is = TRUE) %>%
    bind_rows
colnames(ecoli_pfam) <- c('id', 'alignment_start', 'alignment_end',
                          'envelope_start', 'envelope_end', 'hmm_acc',
                          'hmm_name', 'type', 'hmm_start', 'hmm_end',
                          'hmm_length', 'bit_score', 'E-value',
                          'significance', 'clan')
ecoli_pfam %<>%
    separate(id, "id")

ecoli_pfam_summary <- ecoli_pfam %>%
    group_by(id) %>%
    arrange(id, envelope_start) %>%
    summarize(hmm_arch = paste(hmm_acc, collapse = " "),
              clan_arch = paste(clan, collapse = " "))

nycomps_pfam <- c("large-scale/nycomps_only_pos.fna.faa.pfamA",
                  "large-scale/nycomps_only_neg.fna.faa.pfamA",
                  "large-scale/nycomps_mixed.fna.faa.pfamA") %>%
    lapply(read.table, comment.char = '#', as.is = TRUE) %>%
    bind_rows %>%
    as_data_frame
colnames(nycomps_pfam) <- colnames(ecoli_pfam)

nycomps_pfam %<>%
    separate(id, c("temp", "id"), convert = TRUE) %>%
    select(-temp) %>%
    # only keep Pfam families
    filter(type == "Family") %>%
    mutate(hmm_training = hmm_acc %in% ecoli_pfam$hmm_acc,
           clan_training = clan %in% ecoli_pfam$clan) %>%
    mutate_rows(clan == "No_clan", clan_training = NA, clan = NA)

nycomps_pfam_outcomes <- nycomps_env$nycomps_all_outcomes %>%
    mutate(outcome = plasmid_outcome == 1) %>%
    rename(grp = plasmid_name)

nycomps_pfam_outcomes <- nycomps_env$nycomps_gene_outcomes %>%
    mutate(grp = "genes") %>%
    rename(outcome = posmix_outcome) %>%
    bind_rows(nycomps_pfam_outcomes) %>%
    mutate(grp = factor(grp,
               levels = c("genes",
                          "N", "C",
                          "C_LDAO", "MSGC.24",
                          "MSGC.28", "MSGC.7",
                          "MSGC.9", "MSGC.9_LDAO"),
               labels = c("All Genes",
                          "His-FLAG-TEV- (N)", "-TEV-His (C)",
                          "-TEV-His (C, LDAO)", "His-GST-TEV- (24)",
                          "-TEV-His (28)", "His-TEV- (7)",
                          "His-MBP-TEV-(9)", "His-MBP-TEV- (9, LDAO)"))) %>%
    select(grp, id, outcome, score)

# need to do it in this convoluted way to get proper NA handling
# don't want multiple NA's for genes with multiple Pfam hits without clans
# lack of a clan should be treated the same way as not having a Pfam hit
# at all
nycomps_pfam_outcomes <- nycomps_pfam %>%
    distinct(id, hmm_acc, hmm_training) %>%
    left_join(nycomps_pfam_outcomes, ., by = "id") %>%
    gather(attribute, attr_value, hmm_acc, hmm_training) %>%
    bind_rows(nycomps_pfam %>%
                  distinct(id, clan, clan_training) %>%
                  left_join(nycomps_pfam_outcomes, ., by = "id") %>%
                  gather(attribute, attr_value, clan, clan_training))

nycomps_pfam_outcomes %<>%
    filter(grp != "All Genes") %>%
    mutate(grp = "All Outcomes") %>%
    bind_rows(nycomps_pfam_outcomes)
```

# calculate AUC for subsets
```{r}
auc_wrapper <- function(df) {
    if (sum(df$outcome) > 1 & sum(!df$outcome) > 1) {
        out <- data_frame(score = auc_w_ci(response = df$outcome,
                                        predictor = df$score),
                          ci_labels = c("lower95", "auc", "upper95"))
    } else {
        out <- data_frame(score = c(NA, auc(response = df$outcome,
                                            predictor = df$score,
                                            direction = "<"),
                                    NA),
                          ci_labels = c("lower95", "auc", "upper95"))
    }
    out %>%
        mutate(count = nrow(df),
               pos_count = sum(df$outcome),
               neg_count = sum(!df$outcome))
}

#overall for each group
nycomps_auc <- nycomps_pfam_outcomes %>%
    group_by(grp) %>%
    filter(n() > 1, count_uniq(outcome) > 1, count_uniq(score) > 1) %>%
    do(auc_wrapper(.)) %>%
    spread(ci_labels, score)

# split by category
nycomps_pfam_auc <- nycomps_pfam_outcomes %>%
    group_by(grp, attribute, attr_value) %>%
    filter(n() > 1, count_uniq(outcome) > 1, count_uniq(score) > 1) %>%
#    filter(grp == "-TEV-His (C,LDAO)") %>%
    # filter(attribute %in% c("hmm_training", "hmm_acc"), attr_value %>% is.na) %$%
    # table(grp)
    do(auc_wrapper(.)) %>%
    spread(ci_labels, score)
```

# plot outcomes across families
```{r}
p_hmm_acc <- nycomps_pfam_auc %>%
    filter(attribute == "hmm_training",
           grp %in% c("All Genes", "All Outcomes")) %>%
    ungroup %>%
    mutate_rows(is.na(attr_value), attr_value = "NONE") %>%
    mutate(attr_value = factor(attr_value,
                               c('TRUE', 'FALSE', "NONE"),
                               c("In training", "Not in training", "No Pfam"),
                               ordered = TRUE)) %>%
    ggplot() +
    geom_hline(yintercept = 0.50, linetype = "dashed", color = "lightgrey") +
    geom_pointrange(aes(x = grp, ymin = upper95, y = auc, ymax = lower95,
                        group = attr_value, color = attr_value),
                    size = 0.5, fatten = 0.5,
                    position = position_dodge(width = 0.5)) +
    ylab("AUC") +
    scale_color_manual(values = brewer.pal(5L, "Dark2"), na.value = "gray") +
    scale_x_discrete(expand = c(0, 0),
                     limits = c("All Genes", "All Outcomes")) +
    scale_y_continuous(breaks = seq(0, 1, .1),
                       labels = function(x) x*100) +
    theme(legend.position = c(.03, .95),
          legend.title = element_blank(),
          legend.text = element_text(color = brewer.pal(3, "Dark2")[[1]]),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size = 7))

p_hmm_acc %<>% ggplotGrob()
p_hmm_acc$layout$clip <- "off"

# legend - remove keystones and change label colors
for (idx in 4:8)
    p_hmm_acc$grobs[[8L]]$grobs[[1L]]$grobs[[idx]] <- zeroGrob()

p_hmm_acc$grobs[[8L]]$grobs[[1L]][[1L]][[10L]]$gp$col <-
    brewer.pal(3L, "Dark2")[[2L]]
p_hmm_acc$grobs[[8L]]$grobs[[1L]][[1L]][[11L]]$gp$col <-
    brewer.pal(3L, "Dark2")[[3L]]

ggdraw(p_hmm_acc)
```

```{r}
pfams_of_interest <-
    c(PF02628.12 = 'Cytochrome oxidase assembly\nprotein COX15-CtaA (PF02628)', # no struct
      PF03062.16 = 'O-acyltransferase\n(PF03062)', # no struct
      PF05425.10 = 'Copper resistance\nprotein D (PF05425)', # no struct
      PF02667.11 = 'Short-chain fatty-acid\ntransporter (PF02667)', # no struct
      PF01699.21 = 'Na+/Ca2+ exchanger\n(PF01699)',
      PF00535.23 = 'Glycosyl transferase\nfamily (PF00535)',
      PF07690.13 = 'Major facilitator\nsuperfamily (PF07690)',
      PF01169.16 = 'Calcium transporter\nfamily (PF01169)',
      PF09335.8  = 'SNARE-associated golgi\nproteins (PF09335)',
      PF00950.14 = 'ABC transporter 3\n(PF00950)',
      PF01061.21 = "ABC-2 transporter\n(PF01061)",
      PF01594.13 = 'AI-2E transporters\n(PF01594)',
      PF00860.17 = '10TM permease\nfamily (PF00860)'
      # PF02659.12 = 'Manganese efflux\npump (PF02659)',
      # PF00999.18 = 'Na+/H+ exchanger\n(PF00999)',
      # PF01578.17 = 'Cytochrome C assembly\nprotein (PF01578)',
      # PF03601.11 = 'PRM1 family\n(PF03601)',
      # PF03605.11 = 'C4-dicarboxylate\nuptake family\n(PF03605)',
      # PF06930.9  = 'DUF1282\n(PF06930)',
      # PF13231.3  = 'PMT mannosyl-\ntransferases (PF13231)',
      # PF01384.17 = 'Phosphate transporter\nfamily (PF01384)',
      )

nycomps_pfam_best_vector <- nycomps_pfam_auc %>%
    filter(grp != "All Genes", grp != "All Outcomes",
           attribute == "hmm_acc", !is.na(attr_value), count > 5L) %>%
    group_by(attribute, attr_value) %>%
    filter(auc == max(auc)) %>%
    # if multiple vectors with same AUC for the Pfam (4)
    filter(count == max(count)) %>%
    # if any other duplicates (1), pick the one with more positives
    # since the positive rate is lower
    filter(pos_count == max(pos_count)) %>%
    ungroup %>%
    # for confidence groups, need to do this
    mutate_rows(is.na(lower95), upper95 = auc, lower95 = auc) %>%
    mutate(cumedist = row_number(auc) / length(auc),
           conf_grp = ifelse(auc <= 0.5, 0,
                             ifelse(lower95 <= 0.5, 0.5, 1))) %>%
    separate(attr_value, c("pfam_main"), remove = FALSE) %>%
    left_join(nycomps_pfam %>% distinct(hmm_acc, hmm_name),
              by = c("attr_value" = "hmm_acc"))

nycomps_pfam_worst_vector <- nycomps_pfam_auc %>%
    filter(grp != "All Genes", grp != "All Outcomes",
           attribute == "hmm_acc", !is.na(attr_value), count > 5L) %>%
    group_by(attribute, attr_value) %>%
    filter(auc == min(auc)) %>%
    # if multiple vectors with same AUC for the Pfam (4)
    filter(count == max(count)) %>%
    # if any other duplicates (1), pick the one with more positives
    # since the positive rate is lower
    filter(pos_count == max(pos_count)) %>%
    # for other "duplicates", they are effectively the same,
    # so just concatentate the names
    group_by(attribute, attr_value, auc, lower95, upper95,
             count, pos_count, neg_count) %>%
    summarize(
        grp = paste(grp, collapse = "/")
    ) %>%
    ungroup %>%
    # for confidence groups, need to do this
    mutate_rows(is.na(lower95), upper95 = auc, lower95 = auc) %>%
    mutate(cumedist = row_number(auc) / length(auc),
           conf_grp = ifelse(auc <= 0.5, 0,
                             ifelse(lower95 <= 0.5, 0.5, 1))) %>%
    separate(attr_value, c("pfam_main"), remove = FALSE) %>%
    left_join(nycomps_pfam %>% distinct(hmm_acc, hmm_name),
              by = c("attr_value" = "hmm_acc"))
```

```{r}
nycomps_pfam_outcomes_auc <- nycomps_pfam_auc %>%
    filter(grp == "All Outcomes", attribute == "hmm_acc", count > 5) %>%
    ungroup %>%
    # for confidence groups, need to do this
    mutate_rows(is.na(lower95), upper95 = auc, lower95 = auc) %>%
    mutate(cumedist = row_number(auc) / length(auc),
           conf_grp = ifelse(auc <= 0.5, 0,
                             ifelse(lower95 <= 0.5, 0.5, 1))) %>%
    separate(attr_value, c("pfam_main"), remove = FALSE) %>%
    left_join(nycomps_pfam %>% distinct(hmm_acc, hmm_name),
              by = c("attr_value" = "hmm_acc"))
```

# ecdf nycomps all outcomes - min max vectors
```{r}
nycomps_pfam_all_outcomes <- nycomps_pfam_auc %>%
    filter(grp != "All Genes", grp != "All Outcomes",
           attribute == "hmm_acc", !is.na(attr_value), count > 5L) %>%
    group_by(attr_value) %>%
    summarize(min_auc = min(auc),
              max_auc = max(auc)) %>%
    left_join(nycomps_pfam_outcomes_auc)

    # mutate(cumedist = row_number(auc) / length(auc),
    #        conf_grp = ifelse(auc <= 0.5, 0,
    #                          ifelse(lower95 <= 0.5, 0.5, 1))) 

nycomps_pfam_all_outcomes %>%
    filter(min_auc < 0.5, max_auc > 0.5) %>%

nycomps_pfam_worst_vector %>%
    group_by(attr_value) %>%
    summarize(count2 = n()) %>%
    arrange(desc(count2))

get_ecdf_labels <- function(df) 
    df %>%
    group_by(conf_grp) %>%
    summarize(count = n()) %>%
    ungroup %>%
    mutate(proport = round(count / sum(count)*100) %>% paste0("%")) %>%
    add_row(proport = nrow(df), conf_grp = NA)

p_nycomps_summary <- nycomps_pfam_all_outcomes %>%
    ggplot(aes(x = auc, y = cumedist)) +
    geom_hline(aes(yintercept = ecdf(auc)(0.5)),
               color = "black", linetype = "dashed") +
    geom_vline(xintercept = 0.5, color = "black", linetype = "dashed") +
    geom_step(linetype = "dotted") +
    geom_segment(aes(x = min_auc, xend = max_auc, yend = cumedist), alpha = 0.25, size = 0.25) +
    geom_point(aes(color = conf_grp), size = 0.3) +
    geom_text(aes(x = 0.75, y = 0.16 + ifelse(is.na(conf_grp), -.05, conf_grp/10),
                  label = proport, color = conf_grp),
              size = 5*5/14,
              data = get_ecdf_labels(nycomps_pfam_all_outcomes)) +
    xlab("AUC") +
    ylab("Cumulative Density") +
    scale_x_continuous(limits = c(-.01, 1.01), expand = c(0, 0),
                       labels = function(x) x*100) +
    scale_y_continuous(limits = c(-.01, 1.01), expand = c(0, 0),
                       labels = function(x) paste0(specify_decimal(x*100, 0L), "%")) +
    scale_color_continuous(low = "#A4A5A5", high = "#A10F1C", na.value = "black",
                           guide = "none") +
    theme(legend.title = element_blank(),
          legend.position = c(0.2, 0.8))

p_nycomps_summary %<>% ggplotGrob

p_nycomps_summary$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_nycomps_summary)
```

# ecdf nycomps best vector shape size
```{r}
p_nycomps_best_worst <- nycomps_pfam_best_vector %>%
    mutate(type = "best") %>%
    bind_rows(nycomps_pfam_worst_vector %>%
                  mutate(type = "worst")) %>%
    group_by(type)

best_worst_segments <- p_nycomps_best_worst %>%
    filter(find_closest(auc, 0.5)) %>%
    # remove duplicates with this AUC value
    filter(cumedist == max(cumedist))

make_grp_label <- function(count) {
    total = sum(count)
    proport = paste0(round(count / total * 100), "%")
    paste0(paste0(proport, collapse = ","), "/", total)
}

best_worst_labels <- p_nycomps_best_worst %>%
    group_by(type, conf_grp) %>%
    summarize(count = n()) %>%
    group_by(type) %>%
    arrange(type, desc(conf_grp)) %>%
    summarize(label = make_grp_label(count)) %>%
    ungroup %>%
    left_join(best_worst_segments %>%
                  distinct(cumedist))

best_worst_segments <- p_nycomps_best_worst %>%
    filter(find_closest(cumedist, best_worst_segments$cumedist)) %>%
    select(type, auc, cumedist) %>%
    mutate(xmin = auc,
           xmax = auc) %>%
    group_by(cumedist) %>%
    mutate(xmin = ifelse(auc == min(auc), 0, xmin),
           xmax = ifelse(auc == max(auc), 1, xmax)) %>%
    ungroup
    
p_nycomps_best_worst <- p_nycomps_best_worst %>%
    ggplot(aes(x = auc, y = cumedist)) +
    geom_segment(aes(x = xmin, xend = xmax, y = cumedist, yend = cumedist),
                 color = "grey", linetype = "dashed",
                 data = best_worst_segments) +
    geom_segment(aes(x = .05, xend = .05, y = min, yend = max),
                 arrow = arrow(ends = "both", length = unit(0.02, "npc")),
                 size = 0.25,
                 data = best_worst_segments %>% 
                     summarize_at(vars(cumedist), funs(min, max))) +
    geom_text(aes(x = .08, y = mean, label = round(diff) %>% paste0("%")),
              size = 5*5/14,
              data = best_worst_segments %>%
                  summarize_at(vars(cumedist), funs(diff(range(.*100)), mean))) +
    geom_step(aes(group = type), linetype = "dotted") +
    geom_step(aes(color = conf_grp), alpha = 0.5,
              data = nycomps_pfam_all_outcomes) +
    geom_point(aes(color = conf_grp), size = 0.3) +
    # geom_text(aes(x = 0.75, y = 0.16 + ifelse(is.na(conf_grp), -.05, conf_grp/10),
    #               label = proport, color = conf_grp),
    #           size = 5*5/14,
    #           data = get_labels(nycomps_pfam_best_vector)) +
    geom_text(aes(x = 0.85, y = cumedist, label = label),
              vjust = -.3, size = 5*5/14,
              data = best_worst_labels) +
    xlab("AUC") +
    ylab("Cumulative Density") +
    scale_x_continuous(limits = c(-.01, 1.01), expand = c(0, 0),
                       labels = function(x) x*100) +
    scale_y_continuous(limits = c(-.01, 1.01), expand = c(0, 0),
                       labels = function(x) paste0(round(x*100), "%")) +
    scale_color_continuous(low = "#A4A5A5", high = "#A10F1C", na.value = "black",
                           guide = "none") +
    theme(legend.title = element_blank(),
          legend.position = c(0.2, 0.8))

p_nycomps_best_worst %<>% ggplotGrob

p_nycomps_best_worst$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_nycomps_best_worst)
```

```{r}
format_auc <- function(auc, lower95, upper95, k = 1L)
    paste0(specify_decimal(auc*100, k), " (",
           specify_decimal(lower95*100, k), "-",
           specify_decimal(upper95*100, k), ")")

format_cnt <- function(pos_count, count, k = 0L)
    paste0(specify_decimal(pos_count/count*100, k), "%/", count)

p_nycomps_selected_families <- nycomps_pfam_outcomes %>%
    filter(grp != "All Genes", grp != "All Outcomes",
           attr_value %in% names(pfams_of_interest)) %>%
    semi_join(nycomps_pfam_best_vector, by = c("grp", "attr_value")) %>%
    ggplot() +
    geom_point(aes(x = attr_value, y = score, color = outcome), size = 0.25,
               position = position_beeswarm(dodge.width = .5, cex = 3)) +
    geom_text(
        aes(x = attr_value, y = 2.3,
            label = paste(grp, format_cnt(pos_count, count), sep = "\n")),
        size = 5*5/14,
        data = nycomps_pfam_best_vector %>%
            filter(grp != "All Outcomes",
                   attr_value %in% names(pfams_of_interest))) +
    scale_color_manual(values = c(`TRUE` = "#A10F1C", `FALSE` = "#A4A5A5")) +
    scale_x_discrete(expand = c(0, 0),
                     labels = pfams_of_interest,
                     limits = nycomps_pfam_best_vector %>%
                         filter(grp != "All Outcomes",
                                attr_value %in% names(pfams_of_interest)) %>%
                         arrange(auc) %$% unlist(attr_value)) +
    ylab(expression("SVM" ^ "rank"*~"score")) +
    coord_flip(ylim = c(-5.11, 1.4)) +
    theme(legend.position = "None",
              axis.title.y = element_blank(),
              plot.margin = unit(c(0, 60, 0, 0), "pt"))

p_nycomps_selected_families %<>% ggplotGrob()

p_nycomps_selected_families$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_nycomps_selected_families)
```


# single vector families selected
```{r}
p_single_vector_fam <- c("PF05425.10",  "PF02667.11")

p_single_vector_fam <- nycomps_pfam_outcomes %>%
    filter(grp != "All Genes", grp != "All Outcomes",
           attr_value %in% p_single_vector_fam) %>%
    mutate(attr_value = pfams_of_interest[attr_value]) %>%
    ggplot(aes(x = paste(attr_value, grp, sep = "\n"),
               y = score)) +
    geom_point(aes(color = outcome), size = 0.25,
               position = position_beeswarm(dodge.width = .5, cex = 3)) +
    geom_text(aes(y = 1, label = label), size = 5*5/14, vjust = 2,
              data = nycomps_pfam_auc %>%
                  filter(grp != "All Genes", grp != "All Outcomes",
                         attr_value %in% p_single_vector_fam) %>%
                  ungroup %>%
                  mutate(label = format_auc(auc, lower95, upper95),
                         attr_value = pfams_of_interest[attr_value])) +
    scale_color_manual(values = c(`TRUE` = "#A10F1C", `FALSE` = "#A4A5A5")) +
    scale_x_discrete(expand = c(0, 0)) +
    ylab(expression("SVM" ^ "rank"*~"score")) +
    coord_flip() + # ylim = c(-5.11, 1.4)
    theme(legend.position = "None",
          axis.title = element_blank(),
          plot.margin = unit(c(0, 0, 0, 0), "pt"))

p_single_vector_fam %<>% ggplotGrob()

p_single_vector_fam$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_single_vector_fam)
```


```{r}
p_nycomps_families_vectors <- nycomps_pfam_auc %>%
    filter(attr_value %in% c("PF01061.21", "PF07690.13"),
           grp != "All Outcomes", grp != "All Genes") %>%
    group_by(attr_value) %>%
    # enforce that a confidence interval exists
    filter(!is.na(lower95)) %>%
    # find min and max AUC conditions
    filter(auc %in% c(min(auc), max(auc)))

p_nycomps_families_vectors %<>%
    bind_rows(nycomps_pfam_auc %>%
              filter(grp == "All Outcomes") %>%
              semi_join(p_nycomps_families_vectors, by = "attr_value")) %>%
    ungroup %>%
    mutate(label = format_auc(auc, lower95, upper95),
           attr_label = pfams_of_interest[attr_value],
           xlabel = paste(attr_value, grp, sep = "\n")) %>%
    arrange(attr_value, grp == "All Outcomes", auc)

p_nycomps_families_vectors <- nycomps_pfam_outcomes %>%
    semi_join(p_nycomps_families_vectors) %>%
   # mutate(attr_value = pfams_of_interest[attr_value]) %>%
    ggplot(aes(x = paste(attr_value, grp, sep = "\n"), y = score)) +
    geom_point(aes(color = outcome), size = 0.25,
               position = position_beeswarm(dodge.width = .5, cex = 2)) +
    geom_text(aes(y = 1.4, label = label), size = 5*5/14, vjust = 2,
              data = p_nycomps_families_vectors) +
    scale_color_manual(values = c(`TRUE` = "#A10F1C", `FALSE` = "#A4A5A5")) +
    scale_x_discrete(expand = c(0, 0),
                     # labels = pfams_of_interest,
                     limits = p_nycomps_families_vectors$xlabel) +
    ylab(expression("SVM" ^ "rank"*~"score")) +
    coord_flip() +
    theme(legend.position = "None",
          axis.title.y = element_blank(),
          plot.margin = unit(c(0, 0, 0, 0), "pt"))

p_nycomps_families_vectors %<>% ggplotGrob()

p_nycomps_families_vectors$layout %<>%
    mutate_rows(name == "panel", clip = "off")

ggdraw(p_nycomps_families_vectors)
```


```{r}
f_features <- ggdraw() +
    plot_grid(p_hmm_acc, p_nycomps_summary, p_nycomps_best_worst,
              labels = letters[1:3], label_size = 8,
              align = "hv", rel_widths = c(2, 3, 3), nrow = 1) %>%
    draw_plot(x = 0, y = .75, width = 1, height = .25) +
    plot_grid(p_single_vector_fam, p_nycomps_families_vectors,
              labels = letters[4:5], label_size = 8,
              align = "v", rel_heights = c(2, 6), ncol = 1) %>%
    draw_plot(x = 0, y = 0, width = 1, height = .75)

#if (write_out == TRUE) {
    save_plot(filename = "plots/fig5.pdf",
              plot = f_features,
              base_width = uconv(183L, "mm", "in", "Length"),
              base_height = uconv(160, "mm", "in", "Length"))
#}
f_features
```

```{r session}
sessionInfo()
```
