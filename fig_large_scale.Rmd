---
title: "Data munging and Figure 2 preparation"
author: "Shyam Saladi (saladi@caltech.edu)"
date: "09/20/2016"
output: html_document
---

## Load libraries
Load all libraries necessary for subsequent data munging and plotting.
Some defaults are set here to make things easier throughout.
```{r libraries}
library(datamart)

library(ggplot2)
library(ggbeeswarm)
library(ggthemes)
library(cowplot)
library(corrplot)
library(viridis)
theme_set(theme_cowplot(font_size = 7))

library(gtable)
library(grid)
library(gridExtra)
library(gridGraphics)
library(scales)
library(RColorBrewer)
library(reshape2)
library(plyr)
library(dplyr)
library(dplyrExtras)

library(tidyr)

library(boot)
library(caret)

library(pROC)
library(locfit)

library(foreach)
library(doMC)
registerDoMC(cores = 10)

# if TRUE, then data will be written to file
write_out = FALSE
```

## Convenience functions
Load another file with a number of helper functions to mechanize some tedious
or repetitive tasks.
```{r}
source("preparation-convenience.R")
```

# Figure 2 - Prediction in NYCOMPS
## Data Preparation
This block analyzes the model's predictive performance within the NYCOMPS
dataset and prepares the data for plotting.
```{r nycomps_data_prep, cache=TRUE}
# Load features as well as well as scores
nycomps_pos_scores <- read.csv("large-scale/nycomps_only_pos.fna.allstats.csv",
                               header = TRUE) %>%
    mutate(ml21 = read.table("large-scale/nycomps_only_pos.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
           cterm = read.table("large-scale/nycomps_only_pos_phobius.phobiuscterm", header = FALSE)$V1,
           gene_outcome = "pos")

nycomps_neg_scores <- read.csv("large-scale/nycomps_only_neg.fna.allstats.csv",
                               header = TRUE) %>%
    mutate(ml21 = read.table("large-scale/nycomps_only_neg.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
           cterm = read.table("large-scale/nycomps_only_neg_phobius.phobiuscterm", header = FALSE)$V1,
           gene_outcome = "neg")

nycomps_mixed_scores <-
    read.csv("large-scale/nycomps_mixed.fna.allstats.csv",
                                 header = TRUE) %>%
    mutate(ml21 = read.table("large-scale/nycomps_mixed.fna.allstats.daley_only_raw_exp_ml21", header = FALSE)$V1,
           cterm = read.table("large-scale/nycomps_mixed_phobius.phobiuscterm", header = FALSE)$V1,
           gene_outcome = "mix")

nycomps_posmix <- bind_rows(nycomps_pos_scores, nycomps_neg_scores,
                            nycomps_mixed_scores) %>%
    separate(title, c("gi", "id", "name"), convert = TRUE) %>%
    select(-gi) %>%
    mutate_rows(gene_outcome %in% c("mix", "pos"), gene_outcome = "≥1 pos") %>%
    mutate(gene_outcome = factor(gene_outcome, 
                                levels = c("neg", "≥1 pos"), 
                                labels = c("neg", "≥1 pos"),
                                ordered = TRUE))
rm(nycomps_pos_scores, nycomps_neg_scores, nycomps_mixed_scores)

nycomps_vectors <- read.csv("large-scale/nycomps_outcomes.csv",
                            header = TRUE, as.is = TRUE) %>%
    rename(id = X,
           sum_outcomes = sum) %>%
    gather(plasmid_name, plasmid_outcome, N:MSGC.9_LDAO) %>%
    filter(Analyze == 1) %>%
    select(orfno, id, sum_outcomes, tot_neg, tot_pos, pos_neg,
           plasmid_name, plasmid_outcome)

nycomps_vectors <- left_join(nycomps_vectors, nycomps_posmix, by = "id") %>%
    filter(!is.na(ml21), plasmid_outcome != 0)

nycomps_roc <- foreach(thisplasmid = unique(nycomps_vectors$plasmid_name),
                       .combine = bind_rows, .multicombine = TRUE) %dopar% {
    thisdata <- filter(nycomps_vectors, plasmid_name == thisplasmid)
    thisdata <- transmute(thisdata, 
                          thisresponse = plasmid_outcome == 1,
                          ml21 = ml21)
    df <- data.frame(
        my_roc(thisresponse ~ ml21, data = thisdata, direction = "<"),
        group = thisplasmid,
        type = "plasmid")
}

nycomps_roc <- 
    rbind(nycomps_roc,
          data.frame(my_roc(gene_outcome == "≥1 pos" ~ ml21,
                            data = nycomps_posmix, direction = "<"),
                     group = "posmix", type = "all"),
          data.frame(my_roc(plasmid_outcome == 1 ~ ml21,
                            data = nycomps_vectors, direction = "<"),
                     group = "vectors", type = "all"))

nycomps_auc <- foreach(thisplasmid = unique(nycomps_vectors$plasmid_name),
                       .combine = bind_rows, .multicombine = TRUE) %dopar% {
    thisdata <- nycomps_vectors %>%
        filter(plasmid_name == thisplasmid) %>%
        transmute(thisresponse = plasmid_outcome == 1,
                  ml21 = ml21)
    df1 <- data.frame(
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                      direction = "<", method = "delong"),
        group = thisplasmid,
        type = "plasmid",
        cterm = "all",
        ci_labels = c("lower95", "auc", "upper95"),
        count = nrow(thisdata),
        pos_count = sum(thisdata$thisresponse))
    
    df2 <- foreach(thiscterm = unique(nycomps_vectors$cterm),
                   .combine = bind_rows, .multicombine = TRUE) %dopar% {
        thisdata <- nycomps_vectors %>%
            filter(plasmid_name == thisplasmid, cterm == thiscterm) %>%
            transmute(thisresponse = plasmid_outcome == 1,
                      ml21 = ml21)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                          direction = "<", method = "delong"),
            group = thisplasmid,
            type = "plasmid",
            cterm = thiscterm,
            ci_labels = c("lower95", "auc", "upper95"),
            count = nrow(thisdata),
            pos_count = sum(thisdata$thisresponse))
    }
    bind_rows(df1, df2)
} %>%
    bind_rows(
        data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                                   data = nycomps_posmix, direction = "<"),
                   group = "posmix", 
                   type = "all", 
                   cterm = "all",
                   ci_labels = c("lower95", "auc", "upper95"),
                   count = nrow(nycomps_posmix),
                   pos_count = filter(nycomps_posmix,
                                      gene_outcome == "≥1 pos") %>% nrow),
        data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                                 data = filter(nycomps_posmix,
                                               cterm == "CYTOPLASMIC."),
                                 direction = "<"),
                   group = "posmix", 
                   type = "all", 
                   cterm = "CYTOPLASMIC.",
                   ci_labels = c("lower95", "auc", "upper95"),
                   count = filter(nycomps_posmix,
                                  cterm == "CYTOPLASMIC.") %>% nrow,
                   pos_count = filter(nycomps_posmix,
                                      cterm == "CYTOPLASMIC.",
                                      gene_outcome == "≥1 pos") %>% nrow),
        data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                                 data = filter(nycomps_posmix,
                                               cterm == "NON-CYTOPLASMIC."),
                                 direction = "<"),
                   group = "posmix", 
                   type = "all", 
                   cterm = "NON-CYTOPLASMIC.",
                   ci_labels = c("lower95", "auc", "upper95"),
                   count = filter(nycomps_posmix,
                                  cterm == "NON-CYTOPLASMIC.") %>% nrow,
                   pos_count = filter(nycomps_posmix,
                                      cterm == "NON-CYTOPLASMIC.",
                                      gene_outcome == "≥1 pos") %>% nrow),
        data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                                   data = nycomps_vectors, direction = "<"),
                   group = "vectors", 
                   type = "all", 
                   cterm = "all",
                   ci_labels = c("lower95", "auc", "upper95"),
                   count = nrow(nycomps_vectors),
                   pos_count = filter(nycomps_vectors,
                                      plasmid_outcome == 1) %>% nrow),
        data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                                   data = filter(nycomps_vectors,
                                                 cterm == "CYTOPLASMIC."),
                                   direction = "<"),
                    group = "vectors", 
                    type = "all", 
                    cterm = "CYTOPLASMIC.",
                    ci_labels = c("lower95", "auc", "upper95"),
                    count = filter(nycomps_vectors,
                                   cterm == "CYTOPLASMIC.") %>% nrow,
                    pos_count = filter(nycomps_vectors,
                                       cterm == "CYTOPLASMIC.",
                                       plasmid_outcome == 1) %>% nrow),
        data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                                 data = filter(nycomps_vectors,
                                               cterm == "NON-CYTOPLASMIC."),
                                 direction = "<"),
                   group = "vectors", 
                   type = "all", 
                   cterm = "NON-CYTOPLASMIC.",
                   ci_labels = c("lower95", "auc", "upper95"),
                   count = filter(nycomps_vectors,
                                  cterm == "NON-CYTOPLASMIC.") %>% nrow,
                   pos_count = filter(nycomps_vectors,
                                      cterm == "NON-CYTOPLASMIC.",
                                      plasmid_outcome == 1) %>% nrow)) %>%
    dcast(group + type + cterm + count + pos_count ~ ci_labels,
          value.var = "ml21")

nycomps_median <- nycomps_posmix %>%
    group_by(gene_outcome) %>%
    summarize(median_ml21 = median(ml21))

nycomps_xscale <- nycomps_posmix$ml21 %>%
    quantile(probs = c(.0025, .9975), names = FALSE)
nycomps_xscale[[1]] <- nycomps_xscale[[1]] - 1
nycomps_xscale[[2]] <- nycomps_xscale[[2]] + 1
nycomps_breaks <- seq(-6, 6, 2)

if (write_out)
    write.csv(nycomps_auc, file = "nycomps_auc.csv", row.names = FALSE)
```

## NYCOMPS without RNA Secondary Structure predictions
This block analyzes the effect of not including full sequence-length RNA
secondary structure calculations on predictive performance on the NYCOMPS
dataset.
```{r nycomps_nornass, cache=TRUE}
nycomps_pos_scores_noRNAss <- read.csv("large-scale/nycomps_only_pos.fna.allstats_noRNAss.csv", header = TRUE) %>%
    mutate(ml21 = read.table("large-scale/nycomps_only_pos.fna.allstats_noRNAss.csv.ml21", header = FALSE)$V1,
           cterm = read.table("large-scale/nycomps_only_pos_phobius.phobiuscterm", header = FALSE)$V1,
           gene_outcome = "pos")
nycomps_neg_scores_noRNAss <- read.csv("large-scale/nycomps_only_neg.fna.allstats_noRNAss.csv", header = TRUE) %>%
    mutate(ml21 = read.table("large-scale/nycomps_only_neg.fna.allstats_noRNAss.csv.ml21", header = FALSE)$V1,
           cterm = read.table("large-scale/nycomps_only_neg_phobius.phobiuscterm", header = FALSE)$V1,
           gene_outcome = "neg")
nycomps_mixed_scores_noRNAss <- read.csv("large-scale/nycomps_mixed.fna.allstats_noRNAss.csv", header = TRUE) %>%
    mutate(ml21 = read.table("large-scale/nycomps_mixed.fna.allstats_noRNAss.csv.ml21", header = FALSE)$V1,
           cterm = read.table("large-scale/nycomps_mixed_phobius.phobiuscterm", header = FALSE)$V1,
           gene_outcome = "mix")

nycomps_posmix_noRNAss <- bind_rows(nycomps_pos_scores_noRNAss,
                                    nycomps_neg_scores_noRNAss,
                                    nycomps_mixed_scores_noRNAss) %>%
    separate(title, c("gi", "id", "name"), convert = TRUE) %>%
    select(-gi) %>%
    mutate_rows(gene_outcome %in% c("mix", "pos"),
                gene_outcome = "≥1 pos") %>%
    mutate(gene_outcome = factor(gene_outcome, 
                                levels = c("neg", "≥1 pos"), 
                                labels = c("neg", "≥1 pos"),
                                ordered = TRUE))
rm(nycomps_pos_scores_noRNAss,
   nycomps_neg_scores_noRNAss,
   nycomps_mixed_scores_noRNAss)

nycomps_vectors_noRNAss <- read.csv("large-scale/nycomps_outcomes.csv",
                                    header = TRUE, as.is = TRUE) %>%
    rename(id = X, sum_outcomes = sum) %>%
    gather(plasmid_name, plasmid_outcome, N:MSGC.9_LDAO) %>%
    filter(Analyze == 1) %>%
    select(orfno, id, sum_outcomes, tot_neg, tot_pos, pos_neg,
           plasmid_name, plasmid_outcome)

nycomps_vectors_noRNAss <- nycomps_vectors_noRNAss %>%
    left_join(nycomps_posmix_noRNAss, by = "id") %>%
    filter(!is.na(ml21), plasmid_outcome != 0)

nycomps_auc_noRNAss <-
    foreach(thisplasmid = unique(nycomps_vectors_noRNAss$plasmid_name),
            .combine = bind_rows, .multicombine = TRUE) %dopar% {
    thisdata <- filter(nycomps_vectors_noRNAss, plasmid_name == thisplasmid)
    thisdata <- transmute(thisdata, 
                          thisresponse = plasmid_outcome == 1,
                          ml21 = ml21)
    df1 <- data.frame(
        ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                      direction = "<", method = "delong"),
        group = thisplasmid,
        type = "plasmid",
        cterm = "all",
        ci_labels = c("lower95", "auc", "upper95"),
        count = nrow(thisdata),
        pos_count = sum(thisdata$thisresponse)
        )
    
    df2 <- foreach(thiscterm = unique(nycomps_vectors_noRNAss$cterm),
                   .combine = bind_rows, .multicombine = TRUE) %dopar% {
        thisdata <- nycomps_vectors_noRNAss %>%
            filter(plasmid_name == thisplasmid, cterm == thiscterm) %>%
            transmute(thisresponse = plasmid_outcome == 1,
                      ml21 = ml21)
        data.frame(
            ml21 = ci.auc(thisresponse ~ ml21, data = thisdata,
                          direction = "<", method = "delong"),
            group = thisplasmid,
            type = "plasmid",
            cterm = thiscterm,
            ci_labels = c("lower95", "auc", "upper95"),
            count = nrow(thisdata),
            pos_count = sum(thisdata$thisresponse)
            )
    }
    
    bind_rows(df1, df2)
} %>%
    bind_rows(
        data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                               data = nycomps_posmix_noRNAss,
                               direction = "<"),
                group = "posmix", 
                type = "all", 
                cterm = "all",
                ci_labels = c("lower95", "auc", "upper95")),
        data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                               data = filter(nycomps_posmix_noRNAss,
                                             cterm == "CYTOPLASMIC."),
                               direction = "<"),
                group = "posmix", 
                type = "all", 
                cterm = "CYTOPLASMIC.",
                ci_labels = c("lower95", "auc", "upper95")),
        data.frame(ml21 = ci.auc(gene_outcome == "≥1 pos" ~ ml21, 
                               data = filter(nycomps_posmix_noRNAss,
                                             cterm == "NON-CYTOPLASMIC."),
                               direction = "<"),
                group = "posmix", 
                type = "all", 
                cterm = "NON-CYTOPLASMIC.",
                ci_labels = c("lower95", "auc", "upper95")),
        data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                               data = nycomps_vectors_noRNAss,
                               direction = "<"),
                group = "vectors", 
                type = "all", 
                cterm = "all",
                ci_labels = c("lower95", "auc", "upper95")),
        data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                               data = filter(nycomps_vectors_noRNAss,
                                             cterm == "CYTOPLASMIC."),
                               direction = "<"),
                group = "vectors", 
                type = "all", 
                cterm = "CYTOPLASMIC.",
                ci_labels = c("lower95", "auc", "upper95")),
        data.frame(ml21 = ci.auc(plasmid_outcome == 1 ~ ml21, 
                               data = filter(nycomps_vectors_noRNAss,
                                             cterm == "NON-CYTOPLASMIC."),
                               direction = "<"),
                group = "vectors", 
                type = "all", 
                cterm = "NON-CYTOPLASMIC.",
                ci_labels = c("lower95", "auc", "upper95"))) %>%
        dcast(group + type + cterm + count + pos_count ~ ci_labels,
        value.var = "ml21")

if (write_out)
    write.csv(nycomps_auc_noRNAss, file = "nycomps_nonupack_auc.csv",
              row.names = FALSE)
```

## nycomps plotting
```{r nycomps_trial_counts}
p2_trial_counts <- nycomps_vectors %>%
    group_by(id) %>% 
    summarize(count = factor(length(id), levels = 1:8, ordered = TRUE),
              pos_neg = factor(pos_neg[1], levels = c("neg", "mix", "pos"),
                               ordered = TRUE)) %>%
    ggplot(aes(x = count, fill = pos_neg)) +
    geom_bar(position = "stack", width = 0.5) +
    xlab("Number of Trials") +
    ylab("Number of Different Genes") +
    scale_fill_manual(values = c("#A4A5A5", "#AD665D", "#A10F1C")) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_discrete(expand = c(0, 0), drop = FALSE) +
    theme(legend.position = "none")

if (write_out)
    p2_trial_counts
```

```{r nycomps_posmix_ppv}
p2_posmix_ppv_prep <- prep_for_polygon(filter(nycomps_roc, group == "posmix"))
p2_posmix_ppv <- ggplot(p2_posmix_ppv_prep) + 
    geom_polygon(aes(x = threshold_percentiles, y = ppv, group = id,
                     fill = y_greater_min, color = y_greater_min), size = 0.1) +
    geom_path(aes(x = threshold_percentiles, y = ppv), size = 0.25, 
              data = filter(p2_posmix_ppv_prep, type != "min_ppv") %>%
                     distinct(threshold_percentiles, ppv)) +
    geom_hline(aes(yintercept = min(min_ppv)),
               linetype = "dashed", color = "darkgrey", size = 0.5) +
    scale_x_continuous(expand = c(0, 0), limits = c(0, 1),
                       labels = function(x) x*100) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, .6001),
                       breaks = seq(0, 1, .2), labels = function(x) x*100) +
    xlab(expression("Percentile SVM" ^ "rank"*~"score")) + 
    ylab("PPV") +
    scale_color_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme(legend.position = "None",
          plot.margin = unit(c(1/16, 1/16, 1/16, 0), "in"))

if (write_out)
    p2_posmix_ppv
```

```{r nycomps_posmix_histogram}
nycomps_svmrank_q75 <- filter(nycomps_roc, group == "posmix") %>%
    slice(which.min(abs(threshold_percentiles - 0.75)))

p2_posmix_histogram <- ggplot(nycomps_posmix) + 
    geom_histogram(aes(x = ml21, fill = gene_outcome), 
                   binwidth = fd_bw(nycomps_posmix$ml21),
                   alpha = 1, position = "identity") +
    geom_vline(xintercept = nycomps_svmrank_q75$thresholds,
               linetype = "dashed") + 
    scale_x_continuous(expand = c(0, 0),
                       breaks = nycomps_breaks, limits = nycomps_xscale) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C"),
                      labels = c("Not Expressed", "Expressed")) +
    ylab("Count") +
    xlab(expression("SVM" ^ "rank"*~"score")) + 
    theme(legend.key = element_blank(),
          legend.key.size = unit(0.25, "cm"),
          legend.title = element_blank(),
          legend.position = c(0.2, 0.8),
          plot.margin = unit(c(0, 0, 0, 0), "in"))

p2_posmix_histogram <- ggplotGrob(p2_posmix_histogram)
p2_posmix_histogram$grobs[[8]]$grobs[[1]][[1]][[7]]$gp$col <- "#A4A5A5"
p2_posmix_histogram$grobs[[8]]$grobs[[1]][[1]][[8]]$gp$col <- "#A10F1C"

if (write_out)
    ggdraw(p2_posmix_histogram)
```

```{r nycomps_posmix_roc}
p2_posmix_roc_label <- filter(nycomps_auc, group == "posmix",
                              cterm == "all") %>% 
    mutate(auc = specify_decimal(auc*100, k = 1),
           lower95 = specify_decimal(lower95*100, k = 1),
           upper95 = specify_decimal(upper95*100, k = 1),
           ci = paste0("'", auc, "'~('", lower95, "'-'", upper95, "')"),
           count = paste0(pos_count, "/" ,count)
           )
    
p2_posmix_roc <- ggplot(filter(nycomps_roc, group == "posmix")) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed",
                color = "darkgrey") +
    geom_path(aes(x = 1 - specificities, y = sensitivities)) +
    annotate(geom = "text", x = .70, y = .19,
             label = p2_posmix_roc_label$count,
             size = 6*5/14, parse = TRUE) +
    annotate(geom = "text", x = .70, y = .10,
             label = p2_posmix_roc_label$ci,
             size = 6*5/14, parse = TRUE) +
    scale_y_continuous(expand = c(0, 0), labels = function(x) x*100) +
    scale_x_continuous(expand = c(0, 0), labels = function(x) x*100) +
    xlab("False Positive Rate") + 
    ylab("True Positive Rate") +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C")) + 
    theme(aspect.ratio = 1,
          legend.position = "None",
          plot.margin = unit(c(0, 0, 0, 0), "in"))

if (write_out)
    p2_posmix_roc
```

```{r nycomps_auc_table}
nycomps_cterm <-
    filter(nycomps_auc,
           type == "plasmid" | (type == "all" & group == "vectors"),
           cterm == "all") %>%
    inner_join(
        filter(nycomps_auc,
               type == "plasmid" | (type == "all" & group == "vectors"),
               cterm != "all"),
        by = c("group" = "group")) %>%
    arrange(desc(count.x), cterm.y) %>%
    mutate(auc.x = specify_decimal(auc.x*100, k = 1),
           lower95.x = specify_decimal(lower95.x*100, k = 1),
           upper95.x = specify_decimal(upper95.x*100, k = 1),
           auc.y = specify_decimal(auc.y*100, k = 1),
           lower95.y = specify_decimal(lower95.y*100, k = 1),
           upper95.y = specify_decimal(upper95.y*100, k = 1)) %>%
    transmute(
        group = factor(group,
               levels = c("vectors",
                          "N", "C",
                          "C_LDAO", "MSGC.24",
                          "MSGC.28", "MSGC.7",
                          "MSGC.9", "MSGC.9_LDAO"),
               labels = c("All Conditions",
                          "(N) His-FLAG-TEV-", "(C) -TEV-His",
                          "(C) -TEV-His (LDAO)", "(24) His-GST-TEV-",
                          "(28) -TEV-His", "(7) His-TEV-",
                          "(9) His-MBP-TEV-", "(9) His-MBP-TEV- (LDAO)")),
        all_count = count.x,
        all_label = paste0(auc.x, " (", lower95.x, "-", upper95.x, ")"),
        cterm_count = count.y,
        cterm_label = paste0(auc.y, " (", lower95.y, "-", upper95.y, ")"),
        cterm = factor(cterm.y,
                       levels = c("CYTOPLASMIC.", "NON-CYTOPLASMIC."),
                       labels = c("Cyto.", "Peri.")))

nycomps_cterm <- filter(nycomps_cterm,
                        group %in% c("All Conditions",
                                     "(N) His-FLAG-TEV-", "(C) -TEV-His"))

table_theme2 <- ttheme_default(
    core = list(fg_params = list(fontsize = 7)),
    colhead = list(fg_params = list(fontsize = 7)),
    rowhead = list(fg_params = list(fontsize = 7)),
    padding = unit(c(1, 2), "mm"))

p2_auc_table <- tableGrob(select(nycomps_cterm, -group),
                          theme = table_theme2,
                          cols = c("Count", "AUC (95% CI)",
                                   "Count", "AUC (95% CI)", "cterm"),
                          rows = c("All Conditions", "",
                                   "(N) His-FLAG-TEV-","", "(C) -TEV-His", ""))

# All Conditions
p2_auc_table <- change_cell(p2_auc_table, 2, 2, tnew = 2, bnew = 3)
p2_auc_table <- change_cell(p2_auc_table, 2, 3, tnew = 2, bnew = 3)

# N
p2_auc_table <- change_cell(p2_auc_table, 5, 2, tnew = 4, bnew = 5)
p2_auc_table <- change_cell(p2_auc_table, 5, 3, tnew = 4, bnew = 5)

# C
p2_auc_table <- change_cell(p2_auc_table, 6, 2, tnew = 6, bnew = 7)
p2_auc_table <- change_cell(p2_auc_table, 6, 3, tnew = 6, bnew = 7)

if (write_out)
    ggdraw(p2_auc_table)
```

## Compile all panels into full figure 2
A diagram with arrows showing a summary of the outcomes (with the three arrows)
was added in Adobe Illustrator after the fact.
```{r nycomps_fig_compilation}
p2_main <- ggdraw() +
    draw_plot(
        plot_grid(p2_posmix_ppv, p2_posmix_histogram, 
                  labels = c("b", "c"), label_size = 8,
                  ncol = 1, align = "v"),
        x = 1/3, y = .355, width = 2/3, height = 1 - .355) +
    annotate(geom = "text", x = 0.20, y = 0.81,
             label = "933 complete successes (~11%)",
             size = 6*5/14, color = "#A10F1C") +
    annotate(geom = "text", x = 0.20, y = 0.78,
             label = "1189 mixed outcomes (~14%)",
             size = 6*5/14, color = "#A10F1C") +
    annotate(geom = "text", x = 0.20, y = 0.75,
             label = "6325 complete failures (~75%)",
             size = 6*5/14, color = "#A4A5A5") +
    draw_plot(p2_trial_counts, x = 0, y = .5, width = .33, height = .35) + 
    draw_plot(p2_posmix_roc, x = -.1, y = 0, width = .5, height = .35) + 
    draw_plot(p2_auc_table, x = .32, y = 0, width = 2/3, height = .35) + 
    draw_plot_label(label = c("a", "d", "e"),
                    x = c(0, 0, 1/3),
                    y = c(1, .35, .35), size = 8)

if (write_out == TRUE) {
    save_plot(filename = "plots/fig2_w_panels_largescale.pdf",
              plot = p2_main,
              base_width = uconv(136, "mm", "in", "Length"))
} else {
    p2_main
}
```

```{r fig4_nycomps_nvector_ppv}
p4_nvector_ppv_prep <- prep_for_polygon(filter(nycomps_roc, group == "N"))
p4_nvector_ppv <- ggplot(p4_nvector_ppv_prep) + 
    geom_polygon(aes(x = thresholds, y = ppv, group = id, fill = y_greater_min,
                     color = y_greater_min), size = 0.1) +
    geom_path(aes(x = thresholds, y = ppv), size = 0.5,
              data = filter(p4_nvector_ppv_prep, type != "min_ppv") %>%
                     distinct(thresholds, ppv)) +
    geom_hline(aes(yintercept = min(min_ppv)),
               linetype = "dashed", color = "darkgrey", size = 0.5) +
    annotate("text", x = -1.7, y = 55, size = 7*5/14,
             label = "Expression in (N) His-FLAG-TEV-", fontface = "bold") + 
    coord_cartesian(xlim = nycomps_xscale) +
    scale_x_continuous(expand = c(0, 0), breaks = nycomps_breaks) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, .6),
                       breaks = seq(0, 1, .2), labels = function(x) x*100) +
    xlab(expression("SVM" ^ "rank"*~"score")) + 
    ylab("Positive Predictive Value") +
    scale_color_manual(values = c("#A4A5A5", "#A10F1C")) + 
    scale_fill_manual(values = c("#A4A5A5", "#A10F1C")) + 
    theme(legend.position = "None",
          plot.margin = unit(c(0, 0, 0, 0), "in"))

if (write_out)
    p4_nvector_ppv
```

```{r}
sessionInfo()
```
