---
title: "Data munging and Figure 2 preparation"
author: "Shyam Saladi (saladi@caltech.edu)"
date: "09/20/2016"
output: html_document
---

## Load libraries
Load all libraries necessary for subsequent data munging and plotting.
Some defaults are set here to make things easier throughout.
```{r libraries}
library(magrittr)
library(tidyverse)
library(dplyrExtras)

library(gridExtra)
# `uconv` for unit conversion
library(datamart)
library(cowplot)
theme_set(theme_cowplot(font_size = 7))

# devtools::install("myutils")
library(myutils)
library(doMC)
registerDoMC(cores = 20L)

# if TRUE, then data will be written to file
write_out = TRUE
```

### Load model data for prediction function
```{r}
model_env <- new.env()
load("model.RData", model_env)
svmpredict <- function(feature_df)
    prediction_fn(feature_df, model_env$daley_preprocess_params,
                  model_env$svm_model)
```


# Figure 2 - Large Scale Expression Prediction
## NYCOMPS Data Preparation
This block analyzes the model's predictive performance within the NYCOMPS
dataset and prepares the data for plotting.
```{r nycomps_data_prep, cache = TRUE}
# Load features as well as well as scores
feat_col_spec = cols(.default = col_double(), title = col_character())

# these are actually not the designations
# they were initially just grouped this way for convenience
nycomps_features <- bind_rows(
    read_csv("large-scale/nycomps_only_pos.fna.allstats.csv.gz",
             col_types = feat_col_spec) %>%
        bind_cols(read_csv("large-scale/nycomps_only_pos_phobius.phobiuscterm",
                           col_names = "cterm")),
    read_csv("large-scale/nycomps_only_neg.fna.allstats.csv.gz",
             col_types = feat_col_spec) %>%
       bind_cols(read_csv("large-scale/nycomps_only_neg_phobius.phobiuscterm",
                           col_names = "cterm")),
    read_csv("large-scale/nycomps_mixed.fna.allstats.csv.gz",
             col_types = feat_col_spec) %>%
        bind_cols(read_csv("large-scale/nycomps_mixed_phobius.phobiuscterm",
                           col_names = "cterm"))) %>%
    separate(title, c("gi", "id", "name"), convert = TRUE) %>%
    select(-gi)

nycomps_features$score <- svmpredict(nycomps_features)

nycomps_features$score_nornass <- nycomps_features %>%
    select(-avgRNAss, -minRNAss, -q25RNAss, -q75RNAss, -maxRNAss) %>%
    svmpredict

nycomps_all_outcomes <- read_csv("large-scale/nycomps_outcomes.csv") %>%
    rename(id = X1,
           sum_outcomes = sum) %>%
    gather(plasmid_name, plasmid_outcome, N:MSGC.9_LDAO) %>%
    filter(Analyze == 1L) %>%
    select(id, plasmid_name, plasmid_outcome) %>%
    left_join(nycomps_features %>%
                  select(id, cterm, score, score_nornass),
              by = "id") %>%
    # 0L here means that condition wasn't tested
    filter(!is.na(score), plasmid_outcome != 0L)

gene_outcome_func <- function(x) {
    if (all(x == -1L)) {
        "neg"
    } else if (all(x == 1L)) {
        "pos"
    } else {
        "mix"
    }
}

nycomps_gene_outcomes <- nycomps_all_outcomes %>%
    group_by(id, cterm, score, score_nornass) %>%
    summarise(
        attempts = n(),
        gene_outcome = gene_outcome_func(plasmid_outcome)) %>%
    mutate(gene_outcome = factor(gene_outcome, levels = c("neg", "mix", "pos"),
                                 ordered = TRUE),
           posmix_outcome = gene_outcome != "neg") %>%
    ungroup

# for a consistent scale throughout
nycomps_xscale <- nycomps_gene_outcomes$score %>%
    quantile(probs = c(.0025, .9975), names = FALSE)
nycomps_xscale[[1]] <- nycomps_xscale[[1]] - 1
nycomps_xscale[[2]] <- nycomps_xscale[[2]] + 1
nycomps_breaks <- seq(-6, 6, 2)
```

## nycomps plotting
```{r nycomps_trial_counts}
gene_summary <- nycomps_gene_outcomes %>%
    group_by(gene_outcome) %>%
    summarize(count = n()) %>%
    spread(gene_outcome, count) %>%
    unlist

p2_trial_counts <- nycomps_gene_outcomes %>%
    mutate(count = factor(attempts, levels = 1:max(attempts),
                          ordered = TRUE)) %>%
    ggplot(aes(x = count, fill = gene_outcome)) +
    geom_bar(position = "stack", width = 0.5) +
    annotate(geom = "text", x = 5, y = 4000, label = "Genes:",
             size = 6*5/14) +
    annotate(geom = "text", x = 5, y = 3600,
             label = paste(gene_summary['pos'], "Expressed"),
             size = 6*5/14, color = "#A10F1C") +
    annotate(geom = "text", x = 5, y = 3200,
             label = paste(gene_summary['mix'], "Mixed Outcomes"),
             size = 6*5/14, color = "#A10F1C") +
    annotate(geom = "text", x = 5, y = 2800,
             label = paste(gene_summary['neg'], "Not Expressed"),
             size = 6*5/14, color = "#A4A5A5") +
    xlab("Number of Trials") +
    ylab("Number of Different Genes") +
    scale_fill_manual(values = c("#A4A5A5", "#AD665D", "#A10F1C")) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_discrete(expand = c(0, 0), drop = FALSE) +
    theme(legend.position = "none")

if (write_out)
    p2_trial_counts
```

## NYCOMPS without RNA Secondary Structure predictions
This block analyzes the effect of not including full sequence-length RNA
secondary structure calculations on predictive performance on the NYCOMPS
dataset.
```{r nycomps_auc, cache=TRUE}

calculate_all_aucs <- function(all_outcomes, gene_outcomes, score_col) {
    calc_auc_plasmid <-
        partial(calc_auc_roc, score_col = score_col,
                outcome_col = "plasmid_outcome", method = "auc")
    calc_auc_gene <- partial(calc_auc_roc, score_col = score_col,
                             outcome_col = "posmix_outcome", method = "auc")

    bind_rows(calc_auc_plasmid(all_outcomes, grouping_col = "plasmid_name"),
              calc_auc_plasmid(all_outcomes %>% mutate(all = "all"),
                         grouping_col = "all"),
              calc_auc_gene(gene_outcomes %>% mutate(posmix = "posmix"),
                            grouping_col = "posmix")) %>%
        mutate(group = paste(group, "all")) %>%
        bind_rows(
            calc_auc_plasmid(all_outcomes %>%
                                 mutate(cterm = paste("all", cterm)),
                         grouping_col = "cterm"),
            calc_auc_gene(gene_outcomes %>%
                              mutate(cterm = paste("posmix", cterm)),
                         grouping_col = "cterm"),
            calc_auc_plasmid(all_outcomes %>%
                             mutate(plasmid_cterm = paste(plasmid_name, cterm)),
                         grouping_col = "plasmid_cterm")
        ) %>%
        separate(group, into = c("group", "cterm"), sep = " ")
    }

nycomps_auc <-
    calculate_all_aucs(nycomps_all_outcomes, nycomps_gene_outcomes, "score")

nycomps_nornass_auc <-
    calculate_all_aucs(nycomps_all_outcomes, nycomps_gene_outcomes,
                       "score_nornass")

if (write_out)
    write.csv(nycomps_auc_noRNAss, file = "nycomps_nonupack_auc.csv",
              row.names = FALSE)
```

```{r nycomps_posmix_ppv}
p2_posmix_ppv_prep <- nycomps_gene_outcomes %>%
    mutate(posmix = "posmix") %>%
    calc_auc_roc(grouping_col = "posmix", score_col = "score",
                 outcome_col = "posmix_outcome", method = "roc") %>%
    prep_for_polygon

p2_posmix_ppv <- ggplot(p2_posmix_ppv_prep) +
    geom_polygon(aes(x = threshold_percentiles, y = ppv, group = id,
                     fill = y_greater_min, color = y_greater_min), size = 0.1) +
    geom_path(aes(x = threshold_percentiles, y = ppv), size = 0.25,
              data = filter(p2_posmix_ppv_prep, type != "min_ppv") %>%
                     distinct(threshold_percentiles, ppv)) +
    geom_hline(aes(yintercept = min(min_ppv)),
               linetype = "dashed", color = "darkgrey", size = 0.5) +
    scale_x_continuous(expand = c(0, 0), limits = c(0, 1),
                       labels = function(x) x*100) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, .6001),
                       breaks = seq(0, 1, .2), labels = function(x) x*100) +
    xlab(expression("Percentile SVM" ^ "rank"*~"score")) +
    ylab("PPV") +
    scale_color_manual(values = c("#A4A5A5","#A10F1C")) +
    theme(legend.position = "None",
          plot.margin = unit(c(1/16, 1/16, 1/16, 0), "in"))

if (write_out)
    p2_posmix_ppv

p2_posmix_ppv_prep %>%
    filter(find_closest(threshold_percentiles, 0.75),
           type == "ppv") %>%
    distinct(threshold_percentiles, ppv, min_ppv) %>%
    transmute(`Enrichment at 75th percentile` = ppv - min_ppv)

p2_posmix_ppv_prep %>%
    filter(find_closest(thresholds, 0.5),
           type == "ppv") %>%
    distinct(thresholds, ppv, min_ppv) %>%
    mutate(additional_expressed =
               (ppv - min_ppv) * nrow(nycomps_gene_outcomes))
```

```{r nycomps_posmix_histogram}
p2_posmix_histogram <- ggplot(nycomps_gene_outcomes) +
    geom_histogram(aes(x = score, fill = posmix_outcome,
                       order = -as.numeric(posmix_outcome)),
                   binwidth = fd_bw(nycomps_gene_outcomes$score),
                   alpha = 1, position = "identity") +
    geom_vline(xintercept = nycomps_gene_outcomes$score %>%
                   quantile(0.75, names = FALSE),
               linetype = "dashed") +
    scale_x_continuous(expand = c(0, 0),
                       breaks = nycomps_breaks, limits = nycomps_xscale) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C"),
                      labels = c("Not Expressed", "Expressed")) +
    ylab("Count") +
    xlab(expression("SVM" ^ "rank"*~"score")) +
    theme(legend.key = element_blank(),
          legend.key.size = unit(0.25, "cm"),
          legend.title = element_blank(),
          legend.position = c(0.08, 0.85),
          plot.margin = unit(c(0, 0, 0, 0), "in"))

p2_posmix_histogram %<>% ggplotGrob

# legend - remove keystones and change label colors
for (idx in 4:6)
    p2_posmix_histogram$grobs[[8L]]$grobs[[1L]]$grobs[[idx]] <- zeroGrob()

p2_posmix_histogram$grobs[[8L]]$grobs[[1L]][[1L]][[7L]]$gp$col <- "#A4A5A5"
p2_posmix_histogram$grobs[[8L]]$grobs[[1L]][[1L]][[8L]]$gp$col <- "#A10F1C"

if (write_out)
    ggdraw(p2_posmix_histogram)
```


```{r nycomps_posmix_roc}
p2_posmix_roc_label <- filter(nycomps_auc, group == "posmix",
                              cterm == "all") %>%
    mutate(auc = specify_decimal(auc*100),
           lower95 = specify_decimal(lower95*100),
           upper95 = specify_decimal(upper95*100),
           ci = paste0("'", auc, "'~('", lower95, "'-'", upper95, "')"),
           count = paste0(pos_count, "/" ,count)
           )

p2_posmix_roc <- nycomps_gene_outcomes %>%
    mutate(posmix = "posmix") %>%
    calc_auc_roc(score_col = "score", outcome_col = "posmix_outcome",
                  grouping_col = "posmix", method = "roc") %>%
    ggplot() +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed",
                color = "darkgrey") +
    geom_path(aes(x = 1 - specificities, y = sensitivities)) +
    annotate(geom = "text", x = .70, y = .19,
             label = p2_posmix_roc_label$count,
             size = 6*5/14, parse = TRUE) +
    annotate(geom = "text", x = .70, y = .10,
             label = p2_posmix_roc_label$ci,
             size = 6*5/14, parse = TRUE) +
    scale_y_continuous(expand = c(0, 0), labels = function(x) x*100) +
    scale_x_continuous(expand = c(0, 0), labels = function(x) x*100) +
    xlab("False Positive Rate") +
    ylab("True Positive Rate") +
    scale_fill_manual(values = c("#A4A5A5","#A10F1C")) +
    theme(aspect.ratio = 1,
          legend.position = "None",
          plot.margin = unit(c(0, 0, 0, 0), "in"))

if (write_out)
    p2_posmix_roc
```

```{r}
p_nycomps_cterm <- nycomps_auc %>%
    filter(group != "posmix") %>%
    mutate(
        group = factor(group,
               levels = c("all",
                          "N", "C",
                          "C_LDAO", "MSGC.24",
                          "MSGC.28", "MSGC.7",
                          "MSGC.9", "MSGC.9_LDAO"),
               labels = c("All\nConditions",
                          "His-FLAG-\nTEV-(N)", "-TEV-His\n(C)",
                          "-TEV-His\n(C,LDAO)", "His-GST-\nTEV-(24)",
                          "-TEV-His\n(28)", "His-TEV-\n(7)",
                          "His-MBP-\nTEV-(9)", "His-MBP-\nTEV-(9, LDAO)")))

p_nycomps_cterm <- p_nycomps_cterm %>%
    # calculate label positions
    mutate(lab_y = .35) %>%
    mutate_rows(cterm != "all", lab_y = lab_y - .032) %>%
    mutate_rows(cterm == "NON-CYTOPLASMIC.", lab_y = lab_y - .032) %>%
    ggplot() +
    geom_hline(yintercept = 0.50, color = "darkgrey", linetype = "dashed") +
    geom_text(aes(x = group, y = lab_y,
                  color = cterm, label = fmt_cnt(pos_count, count)),
              size = 5*5/14) +
    geom_pointrange(aes(x = group, ymin = upper95, y = auc, ymax = lower95,
                        group = cterm, color = cterm),
                    fatten = 0.5,
                    position = position_dodge(width = 0.5)) +
    ylab("AUC") +
    scale_color_manual(
        values = setNames(c("black", brewer.pal(5L, "Dark2")[1:2]),
                          c("all", "CYTOPLASMIC.", "NON-CYTOPLASMIC.")),
                       labels = c(`all` = "All C-termini",
                                  `CYTOPLASMIC.` = "Cytoplasmic",
                                  `NON-CYTOPLASMIC.` = "Periplasmic")) +
    scale_x_discrete(expand = c(0, 0),
                     limits = p_nycomps_cterm %>%
                         filter(cterm == "all") %>%
                         arrange(desc(count)) %$% unlist(group)) +
    scale_y_continuous(expand = c(0, 0),
                       labels = function(x) x*100) +
    coord_cartesian(ylim = c(0.45, .885)) +
    theme(legend.position = c(.06, .8),
          legend.title = element_blank(),
          legend.key.size = unit(0.25, "cm"),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size = 5),
          plot.margin = unit(c(0,0,21,0), "pt"))

p_nycomps_cterm %<>%
    ggplot_build %>% ggplot_gtable

p_nycomps_cterm$layout %<>%
    mutate_rows(name == "panel", clip = "off")

# hide key
for (idx in 4:11)
    p_nycomps_cterm$grobs[[8L]]$grobs[[1L]]$grobs[[idx]] <- zeroGrob()

# fix colors of C-terminal labels in legend
p_nycomps_cterm$grobs[[8L]]$grobs[[1L]]$grobs[[13L]]$gp$col <-
    brewer.pal(3, "Dark2")[[1]]
p_nycomps_cterm$grobs[[8L]]$grobs[[1L]]$grobs[[14L]]$gp$col <-
    brewer.pal(3, "Dark2")[[2]]

ggdraw(p_nycomps_cterm)
```

## Compile all panels into full figure 2
A diagram with arrows showing a summary of the outcomes (with the three arrows)
was added in Adobe Illustrator after the fact.
```{r nycomps_fig_compilation}
plasmid_summary <- nycomps_all_outcomes %>%
    group_by(plasmid_outcome) %>%
    summarise(count = n()) %>%
    spread(plasmid_outcome, count) %>%
    unlist

p2_main <- ggdraw() +
    annotate("text", x = 0.15, y = 0.95, size = 6*5/14,
             label = paste(nrow(nycomps_gene_outcomes), "genes")) +
    annotate("text", x = 0.15, y = 0.875, size = 6*5/14,
             label = paste(nrow(nycomps_all_outcomes), "expression trials")) +
    annotate("text", x = 0.1, y = 0.8, size = 6*5/14,
             label = paste(plasmid_summary["1"], "\nsuccesses")) +
    annotate("text", x = 0.2, y = 0.8, size = 6*5/14,
             label = paste(plasmid_summary["-1"], "\nfailures")) +
    draw_plot(
        plot_grid(p2_posmix_ppv, p2_posmix_histogram,
                  labels = c("b", "c"), label_size = 8,
                  ncol = 1, align = "v"),
        x = 1/3, y = .355, width = 2/3, height = 1 - .355) +
    draw_plot(p2_trial_counts, x = 0, y = .37, width = .33, height = .35) +
    draw_plot(p2_posmix_roc, x = -.12, y = 0, width = .5, height = .35) +
    draw_plot(p_nycomps_cterm, x = .27, y = 0, width = .715, height = .38) +
    draw_plot_label(label = c("a", "d", "e"),
                    x = c(0, 0, .272),
                    y = c(1, .385, .385), size = 8)

if (write_out == TRUE) {
    save_plot(filename = "plots/fig2_newE.pdf",
              plot = p2_main,
              base_width = uconv(136, "mm", "in", "Length"))
} else {
    ggdraw(p2_main)
}
```

```{r session}
if (write_out)
    save(nycomps_features, nycomps_all_outcomes, nycomps_gene_outcomes,
         nycomps_xscale, nycomps_breaks,
         file = "large-scale.Rdata", compression_level = 9)
sessionInfo()
```
